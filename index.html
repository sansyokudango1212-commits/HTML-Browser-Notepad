<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>Notepad_Ver7.3.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff; --text: #333; --ui-bg: rgba(255, 255, 255, 0.5);
      --hover: rgba(0,0,0,0.05); --dim: #888; --radius: 25px;
      --accent: #006956;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #121212; --text: #e0e0e0; --ui-bg: rgba(40, 40, 40, 0.5); --hover: rgba(255,255,255,0.08); }
    }
    
    select, input[type="text"] { 
      border-radius: 8px; 
      padding: 4px 4px; 
      font-size: 12px; 
      font-family: inherit; 
      border: 1px solid rgba(128,128,128,0.2);
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }
    
    @media (prefers-color-scheme: dark) {
      select, input[type="text"] { 
        background: #333; 
        color: #fff; 
        border: 1px solid rgba(255,255,255,0.1); 
      }
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: sans-serif; height: 100vh; overflow: hidden;
    }

    .glass {
      background: var(--ui-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2); z-index: 10;
    }
    header, #options, footer, .modal, .toast { border-radius: var(--radius); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    header { 
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      padding: 4px; display: flex; gap: 4px; width: fit-content;
      max-width: 95vw;
      justify-content: center;
      z-index: 160; /* 検索バーより上に設定 */
    }
    header button { 
      background: transparent; border: none; cursor: pointer; 
      padding: 8px 16px; font-size: 13px; color: inherit;
      border-radius: 20px; transition: 0.2s; font-family: inherit;
      white-space: nowrap;
    }
    header button:hover { background: var(--hover); }

    @media (max-width: 480px) {
      header { gap: 2px; padding: 4px 6px; }
      header button { padding: 6px 10px; font-size: 11px; }
    }

    #options {
      position: fixed; 
      top: 50%; 
      left: 50%; 
      z-index: 170; 
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      min-width: 220px; 
      padding: 12px; 
      padding-top: 36px; 
      border-radius: 18px;
      transform: translate(-50%, -50%) scale(0.9);
      opacity: 0; 
      pointer-events: none; 
      will-change: opacity, transform;
      transition: opacity 0.3s cubic-bezier(0.4,0,0.2,1), transform 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    #options.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    .close-dot {
      position: absolute; top: 12px; left: 12px; width: 14px; height: 14px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935);
      border: 1px solid rgba(0,0,0,0.25); box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      cursor: pointer; padding: 0; display: inline-block;
    }
    .close-dot:hover { transform: scale(1.1); }
    .close-dot:focus { outline: none; }

    #options div { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .label { width: 60px; color: var(--dim); font-size: 11px; }

    .modal {
      position: fixed; top: 50%; left: 50%; 
      transform: translate(-50%, -50%) scale(0.9);
      width: fit-content; min-width: 280px; padding: 24px 30px; text-align: center; opacity: 0; pointer-events: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 180;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal.show { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1); 
      pointer-events: auto; 
    }
    .modal p { margin: 0 0 15px 0; font-size: 14px; white-space: nowrap; font-weight: bold; }
    
    #fileNameInput {
      width: 100%; border-radius: 12px;
      border: 1px solid rgba(128,128,128,0.2); background: rgba(255,255,255,0.1);
      color: inherit; font-family: inherit; font-size: 14px; margin-bottom: 20px;
      outline: none; text-align: center;
    }

    .modal-btns { display: flex; gap: 10px; width: 100%; }
    .modal-btns button { 
      flex: 1; padding: 10px 0; border-radius: 15px; border: none; cursor: pointer; 
      font-size: 14px; font-family: inherit; transition: 0.2s;
    }
    .btn-main { background: var(--accent); color: white; }
    .btn-sub { background: var(--hover); color: var(--text); }

    textarea {
      position: absolute; inset: 0;
      border: none; outline: none; box-sizing: border-box;
      padding: 80px 30px 100px 30px;
      background: transparent; color: inherit; line-height: 1.8; font-size: 18px; resize: none;
      width: 100%; height: auto; overflow: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      transition: padding-top 0.3s ease; /* パディング変更を滑らかに */
    }
    textarea::-webkit-scrollbar { width: 0; height: 0; display: none; }

    footer {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      padding: 5px 14px; font-size: 11px; color: var(--dim); display: flex; gap: 8px;
      max-width: 90vw; justify-content: center; white-space: nowrap;
    }
    footer.hidden { transform: translate(-50%, 50px); opacity: 0; pointer-events: none; }
    
    #backdrop { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.15); 
      z-index: 9; display: none; 
    }
    #backdrop.show { display: block; }

    .toast {
      position: fixed; right: 16px; top: 12px; min-width: 260px; max-width: 420px;
      background: var(--ui-bg); color: var(--text); z-index: 200; overflow: hidden;
      transform: translateX(120%); transition: transform 0.36s cubic-bezier(0.2,0,0.2,1), opacity 0.2s; opacity: 0;
      display: flex; align-items: center; padding: 10px 14px; gap: 10px; font-size: 13px;
    }
    .toast.show { transform: translateX(0); opacity: 1; }
    
    @media (max-width: 480px) {
      .toast {
        left: 50%;
        right: auto;
        transform: translate(-50%, -100%);
        width: 95vw;
        max-width: 95vw;
        justify-content: center;
      }
      .toast.show {
        transform: translate(-50%, 0);
      }
    }

    .toast .count { position: absolute; left: 0; top: 0; height: 4px; background: var(--accent); width: 100%; transition: width linear; }
    .toast .msg { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    #contextMenu {
      position: fixed;
      z-index: 1000;
      display: none;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 20px;
      overflow: hidden;
      padding: 4px;
    }
    #contextMenu button {
      width: 100%;
      padding: 8px 16px;
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      font-family: inherit;
      transition: 0.2s;
      border-radius: 16px;
    }
    #contextMenu button:hover {
      background: var(--hover);
    }

    /* 検索ハイライト ミラーdiv */
    #searchHighlightMirror {
      position: absolute; inset: 0;
      pointer-events: none; z-index: 1;
      padding: 80px 30px 100px 30px;
      line-height: 1.8; font-size: 18px;
      white-space: pre-wrap; word-wrap: break-word;
      overflow: hidden; color: transparent;
      box-sizing: border-box;
      transition: padding-top 0.3s ease;
    }
    #searchHighlightMirror mark {
      border-radius: 3px;
      color: transparent;
      background: var(--accent);
      opacity: 0.18;
    }
    #searchHighlightMirror mark.current {
      opacity: 0.38;
    }

    /* 検索バー */
    #searchBar {
      position: fixed; left: 50%;
      display: flex; align-items: center; gap: 6px;
      padding: 6px 10px; z-index: 150;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s cubic-bezier(0.4,0,0.2,1), transform 0.25s cubic-bezier(0.4,0,0.2,1), top 0.3s ease;
      transform: translateX(-50%) translateY(-6px);
      border-radius: var(--radius);
    }
    #searchBar.show {
      opacity: 1; pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
    #searchBar input {
      border: none; outline: none; background: transparent;
      font-size: 14px; color: var(--text); font-family: inherit;
      width: 200px; padding: 2px 4px;
    }
    #searchBar .s-count { font-size: 11px; color: var(--dim); white-space: nowrap; min-width: 40px; }
    #searchBar button {
      background: transparent; border: none; cursor: pointer;
      font-size: 13px; color: var(--dim); padding: 2px 6px;
      border-radius: 8px; font-family: inherit; transition: 0.15s;
    }
    #searchBar button:hover { background: var(--hover); color: var(--text); }
    #searchBar .s-divider { width: 1px; height: 16px; background: rgba(128,128,128,0.25); }

    /* テーマカラースウォッチ */
    .color-swatches { display: flex; gap: 6px; flex-wrap: wrap; }
    .swatch {
      width: 20px; height: 20px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent; transition: 0.15s; flex-shrink: 0;
    }
    .swatch:hover { transform: scale(1.15); }
    .swatch.active { border-color: var(--text); }

  </style>
</head>
<body>

  <header class="glass">
    <button onclick="act('new')">新規</button>
    <button onclick="act('open')">開く</button>
    <button onclick="act('save')">保存</button>
    <button onclick="act('toggleSearch')">検索</button>
    <button onclick="act('toggle')">設定</button>
  </header>

  <div id="searchBar" class="glass">
    <button onclick="act('searchPrev')" title="前へ">↑</button>
    <button onclick="act('searchNext')" title="次へ">↓</button>
    <div class="s-divider"></div>
    <input id="searchInput" type="text" placeholder="検索..." autocomplete="off">
    <span id="searchCount" class="s-count"></span>
    <div class="s-divider"></div>
    <button onclick="act('toggleSearch')">✕</button>
  </div>

  <div id="options" class="glass">
    <button class="close-dot" onclick="act('toggle')" aria-label="閉じる" title="閉じる"></button>

    <div><span class="label">Font</span><select id="fSel"></select></div>
    <div><span class="label">Size</span><select id="sSel"></select></div>
    <div><span class="label">検索</span><select id="searchSel">
      <option value="google">Google</option>
      <option value="duckduckgo">DuckDuckGo</option>
      <option value="startpage">StartPage</option>
      <option value="yahooJP">Yahoo! Japan</option>
      <option value="bing">Bing</option>
    </select></div>
    <div><span class="label">翻訳</span><select id="translateSel">
      <option value="google">Google 翻訳</option>
      <option value="bing">Bing 翻訳</option>
      <option value="weblio">Weblio</option>
    </select></div>
    <div><span class="label">テーマ</span>
      <div class="color-swatches" id="colorSwatches"></div>
    </div>
    <div><span class="label">自動保存</span>
      <select id="autoSaveToggle">
        <option value="on">ON</option>
        <option value="off">OFF</option>
      </select>
    </div>
    <div style="font-size: 10px; color: var(--dim); justify-content: center; border-top: 1px solid rgba(128,128,128,0.1); padding-top: 8px; margin-top: 8px; text-align:center; display: flex; flex-direction: column;">
      <span>Build TH202602120151</span>
      <span>Version 7.4</span>
      <span>↓Creator↓<br>Claude<br>Chat GPT<br>Gemini<br>Copilot<br>Tikuwa</span>
    </div>
  </div>

  <div id="confirmModal" class="glass modal" role="dialog" aria-modal="true" aria-labelledby="modalMsg" tabindex="-1">
    <p id="modalMsg">内容をすべて消去しますか？</p>
    <input type="text" id="fileNameInput" placeholder="ファイル名を入力..." style="display:none">
    <div class="modal-btns">
      <button class="btn-sub" onclick="closeConfirm(false)">キャンセル</button>
      <button id="modalConfirmBtn" class="btn-main" onclick="closeConfirm(true)">確定</button>
    </div>
  </div>

  <div id="backdrop" onclick="act('closeOverlays')"></div>
  
  <div id="contextMenu" class="glass">
    <button onclick="searchGoogle()">検索</button>
    <button onclick="translateText()">翻訳</button>
  </div>
  
  <div id="searchHighlightMirror"></div>
  <textarea id="edit" spellcheck="false"></textarea>

  <footer id="ft" class="glass">
    <span id="b-info"></span>
    <span id="f-info"></span>
  </footer>

  <input type="file" id="fileInput" hidden accept=".txt">

  <div id="toastContainer"></div>

  <script>
    var $ = function(id) { return document.getElementById(id); };
    
    var getBrowser = function() {
      var ua = navigator.userAgent.toLowerCase();
      if (ua.indexOf('opr') !== -1 || ua.indexOf('opera') !== -1) return 'Opera';
      if (ua.indexOf('edg') !== -1) return 'Edge';
      if (ua.indexOf('firefox') !== -1) return 'Firefox';
      if (ua.indexOf('chrome') !== -1) return 'Chrome'; 
      if (ua.indexOf('safari') !== -1) return 'Safari';
      return 'Browser';
    };

    var state = {
      curFile: 'memo.txt',
      browser: getBrowser(),
      text: '',
      isOptionsOpen: false,
      isModalOpen: false,
      isSearchOpen: false,
      modalType: 'new',
      isFooterHidden: false,
      hideTimer: null,
      searchEngine: localStorage.getItem('searchEngine') || 'google',
      accentColor: localStorage.getItem('accentColor') || '#006956',
      autoSave: localStorage.getItem('autoSave') === 'true'
    };

    var supportedFonts = ['Arial', 'Noto Sans JP', 'Noto Serif JP', 'Zen Maru Gothic', 'Dela Gothic One'];
    var supportedSizes = (function(){ var a=[]; for(var s=12;s<=80;s+=2) a.push(s); return a; })();

    var toastQueue = [];
    var isToastShowing = false;
    var sizeToastTimer = null;

    function queueToast(message, duration) {
      toastQueue.push({ message, duration: duration || 4000 });
      processToastQueue();
    }

    function processToastQueue() {
      if (isToastShowing || toastQueue.length === 0) return;
      isToastShowing = true;
      var item = toastQueue.shift();
      showToastUI(item.message, item.duration);
    }

    function showToastUI(message, duration) {
      var container = $('toastContainer');
      var el = document.createElement('div');
      el.className = 'glass toast';
      var count = document.createElement('div');
      count.className = 'count';
      var msg = document.createElement('div');
      msg.className = 'msg';
      msg.textContent = message;
      el.appendChild(count);
      el.appendChild(msg);
      container.appendChild(el);

      var header = document.querySelector('header');
      if (header) {
        var rect = header.getBoundingClientRect();
        el.style.top = rect.top + 'px';
        el.style.height = rect.height + 'px';
        el.style.borderRadius = getComputedStyle(header).borderRadius;
      }

      setTimeout(function() {
        el.classList.add('show');
        count.style.transitionDuration = duration + 'ms';
        count.style.width = '0%';
      }, 50);

      setTimeout(function() {
        el.classList.remove('show');
        setTimeout(function() {
          el.remove();
          isToastShowing = false;
          processToastQueue();
        }, 400);
      }, duration);
    }

    var ActionHandlers = {
      new: function() { 
        state.modalType = 'new';
        state.isModalOpen = true; 
      },
      open: function() { 
        state.isModalOpen = false;
        state.isOptionsOpen = false;
        render();
        var fi = $('fileInput');
        try { fi.value = ''; } catch(e) {}
        fi.click(); 
      },
      save: function() {
        var editEl = $('edit');
        state.text = editEl.value;
        try {
          var fontMeta = '##FONT:"' + $('fSel').value + '"';
          var sizeMeta = '##SIZE:' + $('sSel').value;
          var fullText = fontMeta + '\n' + sizeMeta + '\n' + state.text;

          var a = document.createElement('a');
          var blob = new Blob([fullText], { type: 'text/plain' });
          var url = URL.createObjectURL(blob);
          a.href = url;
          a.download = sanitizeFileName(state.curFile);
          a.click();
          URL.revokeObjectURL(url);
          queueToast('保存を開始しました：' + state.curFile, 2500);
        } catch (e) {
          queueToast('保存に失敗しました。');
        }
      },
      toggle: function() { 
        state.isOptionsOpen = !state.isOptionsOpen; 
        if (state.isOptionsOpen) state.isModalOpen = false;
      },
      toggleSearch: function() {
        state.isSearchOpen = !state.isSearchOpen;
        if (state.isSearchOpen) {
          setTimeout(function() { $('searchInput').focus(); }, 50);
          doSearch();
        } else {
          clearSearchHighlight();
          $('searchCount').textContent = '';
        }
        updateTextareaPadding(); // 検索バーの有無でパディングと読み取り専用を切り替え
      },
      searchNext: function() { doSearch(1); },
      searchPrev: function() { doSearch(-1); },
      closeOverlays: function() {
        state.isOptionsOpen = false;
        state.isModalOpen = false;
      },
      updateText: function(val) {
        var lines = val.split(/\r?\n/);
        var bodyLines = [];
        var changed = false;

        for(var i=0; i<lines.length; i++) {
          var line = lines[i];
          if(line.startsWith('##FONT:')) {
            var font = line.replace('##FONT:', '').replace(/"/g, '').trim();
            updateSelectValue('fSel', font);
            changed = true; continue;
          }
          if(line.startsWith('##SIZE:')) {
            var sizeRaw = parseInt(line.replace('##SIZE:', '').trim());
            if(!isNaN(sizeRaw)) {
              updateSelectValue('sSel', normalizeSize(sizeRaw));
              changed = true;
            }
            continue;
          }
          bodyLines.push(line);
        }

        var processedText = bodyLines.join('\n');
        
        if (changed) {
            state.text = processedText;
            $('edit').value = state.text;
            applyStyles();
        } else {
            state.text = val;
        }

        clearTimeout(state.hideTimer);
        var edit = $('edit');
        if (state.text.length > 0 && (edit.scrollHeight - (edit.scrollTop + edit.clientHeight) < 50)) {
          state.isFooterHidden = true;
          state.hideTimer = setTimeout(function() { state.isFooterHidden = false; render(); }, 1000);
        } else {
          state.isFooterHidden = false;
        }
      }
    };

    // 検索バーに合わせてtextareaのパディングと入力を制御
    function updateTextareaPadding() {
      var edit = $('edit');
      var mirror = $('searchHighlightMirror');
      var searchBar = $('searchBar');
      
      if (state.isSearchOpen) {
        var barHeight = searchBar.offsetHeight || 44;
        var barTop = parseInt(searchBar.style.top) || 68;
        var totalPadding = barTop + barHeight + 20; 
        
        edit.style.paddingTop = totalPadding + "px";
        mirror.style.paddingTop = totalPadding + "px";
        edit.readOnly = true; // 入力不可にする
      } else {
        edit.style.paddingTop = "80px";
        mirror.style.paddingTop = "80px";
        edit.readOnly = false; // 入力許可に戻す
      }
    }

    function isFontAvailable(font) {
      if (!font) return false;
      try {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        ctx.font = '72px monospace';
        var w1 = ctx.measureText('abcdefg').width;
        ctx.font = '72px "' + font + '", monospace';
        var w2 = ctx.measureText('abcdefg').width;
        return w1 !== w2;
      } catch (e) { return false; }
    }

    function updateSelectValue(id, value) {
      var sel = $(id);
      for(var i=0; i<sel.options.length; i++){
        if(sel.options[i].value == value) {
          sel.selectedIndex = i;
          return;
        }
      }
      if(id === 'fSel' && isFontAvailable(value)) {
        sel.add(new Option(value, value));
        sel.selectedIndex = sel.options.length - 1;
      }
    }

    function normalizeSize(size) {
      size = Math.round(size);
      if (size % 2 !== 0) size = (size < 18) ? size + 1 : size - 1;
      return Math.min(80, Math.max(12, size));
    }

    function sanitizeFileName(name) {
      name = (name || 'memo.txt').trim().replace(/[/\\:\*\?"<>\|]/g, '');
      return name.toLowerCase().endsWith('.txt') ? name : name + '.txt';
    }

    function debounce(fn, wait) {
      var t; return function() {
        var ctx = this, args = arguments;
        clearTimeout(t); t = setTimeout(function() { fn.apply(ctx, args); }, wait);
      };
    }

    var selectedText = '';
    var contextMenu = null;

    window.searchGoogle = function() {
      if (selectedText) {
        var searchUrls = {
          'google': 'https://www.google.com/search?q=',
          'duckduckgo': 'https://duckduckgo.com/?q=',
          'bing': 'https://www.bing.com/search?q=',
          'yahooJP': 'https://search.yahoo.co.jp/search?p=',
          'startpage': 'https://www.startpage.com/do/search?q='
        };
        var url = searchUrls[state.searchEngine] || searchUrls['google'];
        window.open(url + encodeURIComponent(selectedText), '_blank');
      }
      hideContextMenu();
    };

    window.translateText = function() {
      if (selectedText) {
        var engine = $('translateSel') ? $('translateSel').value : 'google';
        var translateUrls = {
          'google': 'https://translate.google.com/?sl=auto&tl=ja&text=',
          'bing': 'https://www.bing.com/translator?text=',
          'weblio': 'https://ejje.weblio.jp/content/'
        };
        var url = translateUrls[engine] || translateUrls['google'];
        window.open(url + encodeURIComponent(selectedText), '_blank');
      }
      hideContextMenu();
    };

    function hideContextMenu() {
      if (contextMenu) contextMenu.style.display = 'none';
    }

    function showContextMenu(x, y) {
      if (!contextMenu) contextMenu = $('contextMenu');
      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
      contextMenu.style.display = 'block';
    }

    window.act = function(type) { ActionHandlers[type](); render(); };
    window.closeConfirm = function(yes) {
      if (yes && state.modalType === 'new') { 
          $('edit').value = ""; 
          ActionHandlers.updateText(""); 
          state.curFile = 'memo.txt'; 
      }
      ActionHandlers.closeOverlays(); render();
    };

    function render() {
      var edit = $('edit');
      $('f-info').textContent = state.curFile + " · " + edit.value.length + " 文字";
      $('b-info').textContent = state.browser;
      edit.placeholder = state.browser + " >";

      var isAnyOpen = state.isOptionsOpen || state.isModalOpen;
      $('options').className = 'glass' + (state.isOptionsOpen ? ' show' : '');
      $('confirmModal').className = 'glass modal' + (state.isModalOpen ? ' show' : '');
      $('backdrop').className = (isAnyOpen ? 'show' : '');
      $('ft').className = 'glass' + (state.isFooterHidden ? ' hidden' : '');
      $('searchBar').className = 'glass' + (state.isSearchOpen ? ' show' : '');
    }

    function applyStyles() {
      var edit = $('edit');
      edit.style.fontFamily = $('fSel').value;
      edit.style.fontSize = $('sSel').value + 'px';
      updateMirror();
    }

    // ── テーマカラー ──
    var themeColors = [
      { color: '#006956', label: 'グリーン' },
      { color: '#1a73e8', label: 'ブルー' },
      { color: '#9c27b0', label: 'パープル' },
      { color: '#e53935', label: 'レッド' },
      { color: '#f57c00', label: 'オレンジ' },
      { color: '#455a64', label: 'スレート' },
    ];

    function applyAccentColor(color) {
      document.documentElement.style.setProperty('--accent', color);
      state.accentColor = color;
      localStorage.setItem('accentColor', color);
      document.querySelectorAll('.swatch').forEach(function(s) {
        s.classList.toggle('active', s.dataset.color === color);
      });
    }

    // ── テキスト内検索 ──
    var searchMatches = [];
    var searchIndex = 0;

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function updateMirror() {
      var mirror = $('searchHighlightMirror');
      var edit   = $('edit');
      if (!mirror) return;

      mirror.style.fontFamily = edit.style.fontFamily || '';
      mirror.style.fontSize   = edit.style.fontSize   || '18px';

      if (!state.isSearchOpen || searchMatches.length === 0) {
        mirror.innerHTML = '';
        mirror.scrollTop = edit.scrollTop;
        return;
      }

      var query = $('searchInput').value;
      if (!query) { mirror.innerHTML = ''; return; }

      var text   = edit.value;
      var qLen   = query.length;
      var html   = '';
      var cursor = 0;

      searchMatches.forEach(function(pos, i) {
        html += escapeHtml(text.substring(cursor, pos));
        var cls = (i === searchIndex) ? 'current' : '';
        html += '<mark class="' + cls + '">' + escapeHtml(text.substring(pos, pos + qLen)) + '</mark>';
        cursor = pos + qLen;
      });
      html += escapeHtml(text.substring(cursor));

      mirror.innerHTML = html;
      mirror.scrollTop = edit.scrollTop;
    }

    function doSearch(dir) {
      var query = $('searchInput').value;
      var edit  = $('edit');
      searchMatches = [];
      if (!query) {
        $('searchCount').textContent = '';
        updateMirror();
        return;
      }
      var text      = edit.value;
      var lowerText = text.toLowerCase();
      var lowerQ    = query.toLowerCase();
      var pos = 0;
      while ((pos = lowerText.indexOf(lowerQ, pos)) !== -1) {
        searchMatches.push(pos);
        pos += lowerQ.length;
      }
      if (searchMatches.length === 0) {
        $('searchCount').textContent = '0 / 0';
        updateMirror();
        return;
      }
      if      (dir ===  1) searchIndex = (searchIndex + 1) % searchMatches.length;
      else if (dir === -1) searchIndex = (searchIndex - 1 + searchMatches.length) % searchMatches.length;
      else                 searchIndex = 0;

      var matchPos   = searchMatches[searchIndex];
      edit.setSelectionRange(matchPos, matchPos + query.length);
      var lineHeight = parseFloat(getComputedStyle(edit).lineHeight) || 28;
      var lineNum    = edit.value.substring(0, matchPos).split('\n').length - 1;
      
      // スクロール位置調整（パディングを考慮）
      var paddingTop = parseInt(edit.style.paddingTop) || 80;
      edit.scrollTop = Math.max(0, lineNum * lineHeight - (edit.clientHeight - paddingTop) / 2);

      $('searchCount').textContent = (searchIndex + 1) + ' / ' + searchMatches.length;
      updateMirror();
    }

    function clearSearchHighlight() {
      searchMatches = [];
      searchIndex   = 0;
      var mirror = $('searchHighlightMirror');
      if (mirror) mirror.innerHTML = '';
    }

    var autoSaveTimer = null;

    function scheduleAutoSave() {
      if (!state.autoSave) return;
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(function() {
        var text = $('edit').value;
        localStorage.setItem('autosave_text', text);
        localStorage.setItem('autosave_file', state.curFile);
        var time = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
        queueToast('自動保存済み |' + time, 2000);
      }, 2000);
    }

    (function init() {
      var fSel = $('fSel'), sSel = $('sSel'), edit = $('edit'), searchSel = $('searchSel');
      supportedFonts.forEach(function(f) { fSel.add(new Option(f, f)); });
      for (var j = 12; j <= 80; j += 2) sSel.add(new Option(j + "px", j));
      sSel.value = 18;
      
      searchSel.value = state.searchEngine;
      searchSel.onchange = function() {
        state.searchEngine = searchSel.value;
        localStorage.setItem('searchEngine', searchSel.value);
      };

      var translateSel = $('translateSel');
      translateSel.value = localStorage.getItem('translateEngine') || 'google';
      translateSel.onchange = function() {
        localStorage.setItem('translateEngine', translateSel.value);
      };

      var swatchContainer = $('colorSwatches');
      themeColors.forEach(function(t) {
        var s = document.createElement('button');
        s.className = 'swatch';
        s.dataset.color = t.color;
        s.style.background = t.color;
        s.title = t.label;
        s.onclick = function() { applyAccentColor(t.color); };
        swatchContainer.appendChild(s);
      });
      applyAccentColor(state.accentColor);

      var autoSaveToggle = $('autoSaveToggle');
      autoSaveToggle.value = state.autoSave ? 'on' : 'off';
      if (state.autoSave) {
        var saved = localStorage.getItem('autosave_text');
        var savedFile = localStorage.getItem('autosave_file');
        if (saved && saved.length > 0 && edit.value.length === 0) {
          edit.value = saved;
          if (savedFile) state.curFile = savedFile;
          ActionHandlers.updateText(edit.value);
          queueToast('自動保存されたデータを復元しました', 3000);
        }
      }
      autoSaveToggle.onchange = function() {
        state.autoSave = autoSaveToggle.value === 'on';
        localStorage.setItem('autoSave', state.autoSave);
        if (!state.autoSave) clearTimeout(autoSaveTimer);
      };

      var searchInput = $('searchInput');

      function positionSearchBar() {
        var header = document.querySelector('header');
        var bar = $('searchBar');
        if (header && bar) {
          var rect = header.getBoundingClientRect();
          // メニューバーの直下（12px）に配置
          bar.style.top = (rect.bottom + 12) + 'px';
          if (state.isSearchOpen) updateTextareaPadding();
        }
      }
      positionSearchBar();
      window.addEventListener('resize', positionSearchBar);

      searchInput.oninput = function() { doSearch(0); };
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          e.stopPropagation();
          doSearch(e.key === 'ArrowDown' ? 1 : -1);
          setTimeout(function() { searchInput.focus(); }, 0);
        }
        if (e.key === 'Enter') { e.preventDefault(); doSearch(e.shiftKey ? -1 : 1); }
        if (e.key === 'Escape') { act('toggleSearch'); render(); }
      });

      var upd = debounce(function() { 
        if (!edit.readOnly) { // 読み取り専用時は更新しない
          ActionHandlers.updateText(edit.value); 
          scheduleAutoSave(); 
          render(); 
        }
      }, 150);
      edit.oninput = upd;
      edit.onclick = function() {
          hideContextMenu();
          upd();
      };
      
      edit.onscroll = function() {
        hideContextMenu();
        updateMirror();
      };

      if (window.ResizeObserver) {
        new ResizeObserver(function() { updateMirror(); }).observe($('edit'));
      }

      fSel.onchange = applyStyles;
      sSel.onchange = applyStyles;

      edit.addEventListener('wheel', function(e) {
        if (!e.ctrlKey) return;
        e.preventDefault();
        var current = parseInt(sSel.value, 10) || 18;
        var newSize = normalizeSize(current + (e.deltaY < 0 ? 2 : -2));
        if (newSize !== current) {
          sSel.value = String(newSize);
          applyStyles();
          clearTimeout(sizeToastTimer);
          sizeToastTimer = setTimeout(function() { queueToast('フォントサイズ: ' + newSize + 'px', 1000); }, 600);
        }
      }, { passive: false });

      $('fileInput').onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        state.curFile = file.name;
        var reader = new FileReader();
        reader.onload = function() { 
            edit.value = reader.result; 
            ActionHandlers.updateText(edit.value); 
            render(); 
        };
        reader.readAsText(file);
      };

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && (state.isOptionsOpen || state.isModalOpen)) { ActionHandlers.closeOverlays(); render(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); ActionHandlers.toggleSearch(); render(); }
      });

      edit.addEventListener('contextmenu', function(e) {
        var text = window.getSelection().toString().trim();
        if (text.length > 0) {
          e.preventDefault();
          selectedText = text;
          showContextMenu(e.clientX, e.clientY);
        } else {
          hideContextMenu();
        }
      });

      edit.addEventListener('mouseup', function(e) {
        setTimeout(function() {
          var text = window.getSelection().toString().trim();
          if (text.length > 0) {
            selectedText = text;
            showContextMenu(e.clientX, e.clientY);
          } else {
            if (contextMenu && !contextMenu.contains(e.target)) hideContextMenu();
          }
        }, 20);
      });

      document.addEventListener('mousedown', function(e) {
        if (contextMenu && !contextMenu.contains(e.target) && e.target !== edit) {
          hideContextMenu();
        }
      });

      applyStyles();
      render();
    })();
  </script>
</body>
</html>
