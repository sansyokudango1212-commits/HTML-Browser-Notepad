<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>HTMLブラウザメモ帳</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Noto+Serif+JP&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    /* 変数の定義 */
    :root {
      --bg: #ffffff;
      --text: #333333;
      --ui-bg: #f0f0f0;
      --hover: #ddd;
      --dim: #666;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1e1e1e;
        --text: #f0f0f0;
        --ui-bg: #333333;
        --hover: #555555;
        --dim: #bbbbbb;
      }
      select { background: #3e3e3e; color: #f0f0f0; border: 1px solid #555; }
    }

    body {
      margin: 0;
      font-family: "Segoe UI", "Meiryo", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      /* 画面全体の不要なスクロールバーを完全に抑制 */
      overflow: hidden;
    }

    header {
      background: var(--ui-bg);
      padding: 4px 10px;
      display: flex;
      gap: 15px;
      font-size: 12px;
      user-select: none;
      flex-shrink: 0;
    }

    header span {
      cursor: pointer;
      padding: 1px 4px;
      border-radius: 4px;
    }

    header span:hover { background: var(--hover); }

    /* オプションメニューのアニメーション */
    #options {
      background: var(--ui-bg);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: 0;
      padding: 0 10px;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
      flex-shrink: 0;
    }

    #options.show {
      max-height: 100px;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    #options div { display: flex; align-items: center; gap: 10px; }
    .label { width: 70px; margin-left: 5px; }

    textarea {
      flex: 1;
      border: none;
      outline: none;
      padding: 10px;
      resize: none;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      font-family: inherit;
      font-size: 14px;
      /* テキストエリア内だけは必要に応じてスクロール可能にする */
      overflow-y: auto;
    }

    footer {
      background: var(--ui-bg);
      padding: 3px 10px;
      font-size: 11px;
      color: var(--dim);
      flex-shrink: 0;
    }

    @media (max-width: 600px) { footer { text-align: center; } }
  </style>
</head>
<body>

  <header>
    <span onclick="newFile()">新規</span>
    <span onclick="fileInput.click()">開く</span>
    <span onclick="saveFile()">保存</span>
    <span onclick="optionsMenu.classList.toggle('show')">オプション</span>
  </header>

  <div id="options">
    <div>
      <span class="label">フォント：</span>
      <select id="fSel" onchange="apply()"></select>
    </div>
    <div>
      <span class="label">サイズ：</span>
      <select id="sSel" onchange="apply()"></select>
    </div>
  </div>

  <textarea id="edit" placeholder="ここに入力..."></textarea>

  <footer>
    <span id="browser-info">...</span>
  </footer>

  <input type="file" id="fileInput" hidden onchange="loadFile(event)">

  <script>
    const edit = document.getElementById('edit');
    const fSel = document.getElementById('fSel');
    const sSel = document.getElementById('sSel');
    const optionsMenu = document.getElementById('options');
    const fileInput = document.getElementById('fileInput');

    // 指定されたフォントリスト
    const fonts = [
      { name: 'Arial', value: 'Arial, sans-serif' },
      { name: 'Noto Serif JP', value: '"Noto Serif JP", serif' },
      { name: 'Zen Maru Gothic', value: '"Zen Maru Gothic", sans-serif' },
      { name: 'Dela Gothic One', value: '"Dela Gothic One", cursive' }
    ];
    const sizes = [8, 10, 12, 14, 16, 18, 20, 24, 28, 32, 36, 40, 48, 50];

    // デフォルト値の定義
    const DEFAULT_FONT = fonts[0].value;
    const DEFAULT_SIZE = 14;

    // 現在のファイル名を管理
    let currentFileName = 'memo.txt';

    // セレクトボックスの生成
    fonts.forEach(f => fSel.add(new Option(f.name, f.value)));
    sizes.forEach(s => sSel.add(new Option(s + 'px', s)));

    /**
     * 設定をバリデーションして反映する
     * @param {string|null} newFont 適用したいフォント名(value)
     * @param {number|null} newSize 適用したいフォントサイズ(px)
     */
    function apply(newFont, newSize) {
      if (newFont !== undefined && newFont !== null) {
        const isValidFont = [...fSel.options].some(o => o.value === newFont);
        fSel.value = isValidFont ? newFont : DEFAULT_FONT;
      }

      if (newSize !== undefined && newSize !== null) {
        const s = Math.min(Math.max(parseInt(newSize) || DEFAULT_SIZE, 8), 50);
        if (![...sSel.options].some(o => parseInt(o.value) === s)) {
          sSel.add(new Option(s + 'px', s));
        }
        sSel.value = s;
      }

      const finalFont = [...fSel.options].some(o => o.value === fSel.value) ? fSel.value : DEFAULT_FONT;
      edit.style.fontFamily = finalFont;

      const finalSize = parseInt(sSel.value);
      if (!isNaN(finalSize) && finalSize >= 8 && finalSize <= 50) {
        edit.style.fontSize = finalSize + 'px';
      } else {
        edit.style.fontSize = DEFAULT_SIZE + 'px';
        sSel.value = DEFAULT_SIZE;
      }
    }

    function newFile() {
      edit.value = "";
      currentFileName = 'memo.txt';
      apply(DEFAULT_FONT, DEFAULT_SIZE);
    }

    function saveFile() {
      let fileName = window.prompt("保存するファイル名を入力してください", currentFileName);
      if (fileName === null) return;
      fileName = fileName.trim() || 'memo.txt';
      if (!fileName.includes('.')) fileName += '.txt';

      const data = `${edit.value.trimEnd()}\n\n##FONT:${fSel.value}\n##SIZE:${sSel.value}`;
      const blob = new Blob([data], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
      currentFileName = fileName;
      setTimeout(() => URL.revokeObjectURL(a.href), 100);
    }

    function loadFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      currentFileName = file.name;
      const reader = new FileReader();
      reader.onload = () => {
        let content = reader.result.replace(/\r\n/g, '\n');
        const fMatch = content.match(/##FONT:(.+)$/m);
        const sMatch = content.match(/##SIZE:(\d+)$/m);
        const f = fMatch ? fMatch[1].trim() : DEFAULT_FONT;
        const s = sMatch ? parseInt(sMatch[1]) : DEFAULT_SIZE;
        apply(f, s);
        edit.value = content.replace(/##FONT:.+$/gm, '').replace(/##SIZE:.+$/gm, '').trimEnd();
      };
      reader.readAsText(file);
      e.target.value = "";
    }

    edit.addEventListener('wheel', e => {
      if (e.ctrlKey) {
        e.preventDefault();
        const currentSize = parseInt(sSel.value) || DEFAULT_SIZE;
        const newSize = Math.min(Math.max(currentSize + (e.deltaY < 0 ? 2 : -2), 8), 50);
        apply(null, newSize);
      }
    }, { passive: false });

    async function detectBrowser() {
      const ua = navigator.userAgent;
      let browser = "不明なブラウザ";
      try {
        if (typeof navigator.brave?.isBrave === "function") {
          if (await navigator.brave.isBrave()) browser = "Brave";
        }
      } catch (e) {}
      if (browser === "不明なブラウザ") {
        if (ua.includes("Edg")) browser = "Microsoft Edge";
        else if (ua.includes("OPR") || ua.includes("Opera")) browser = "Opera";
        else if (ua.includes("Firefox")) browser = "Mozilla Firefox";
        else if (ua.includes("Safari") && !ua.includes("Chrome")) browser = "Safari";
        else if (ua.includes("Chrome")) browser = "Google Chrome";
        else if (ua.includes("NetFront")) browser = "NetFront";
        else if (ua.includes("AppleWebKit")) browser = "WebKit";
      }
      document.getElementById("browser-info").textContent = browser;
    }

    (async () => {
      await detectBrowser();
      apply(DEFAULT_FONT, DEFAULT_SIZE);
    })();
  </script>
</body>
</html>
