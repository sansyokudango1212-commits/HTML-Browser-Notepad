<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://translate.googleapis.com https://ja.wikipedia.org https://ja.wiktionary.org https://en.wikipedia.org https://en.wiktionary.org; worker-src 'self'; frame-ancestors 'none';">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <link rel="manifest" href="manifest.json">
  <meta name="google-site-verification" content="Z5LCrw2wiWOC0bTQynoScEQ9LTvHoEucbmQwoReCLXE" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>Notepad26</title>
  <meta name="description" content="学生が個人開発しているメモ帳。">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Kosugi+Maru&family=Noto+Sans+JP:wght@200;400;700&family=Noto+Serif+JP&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #121212;
      --text: #e0e0e0;
      --ui-bg: rgba(40, 40, 40, 0.5);
      --hover: rgba(255, 255, 255, 0.08);
      --dim: #888;
      --radius: 25px;
      --accent: #c9a181;
      --accent-rgb: 201, 161, 129;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Sans JP', 'Source Han Sans JP', 'ヒラギノ角ゴ ProN', sans-serif;
      font-weight: 200;
      height: 100vh;
      overflow: hidden;
    }
    select, input[type="text"] {
      border-radius: 8px; padding: 4px; font-size: 12px;
      font-family: inherit; border: 1px solid rgba(255,255,255,0.1);
      background: #333; color: var(--text);
    }
    select option { background: #2d2d2d; color: #fff; }

    .glass {
      background: var(--ui-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius);
      z-index: 10;
    }

    #lockScreen {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      transition: opacity 0.35s cubic-bezier(0.4,0,1,1);
    }
    #lockScreen.unlocking { opacity: 0; pointer-events: none; }
    #lockScreen.hidden    { display: none; }

    @keyframes lockCardUnlock {
      0%   { transform: translateY(0);    animation-timing-function: cubic-bezier(0.4,0,0.6,1); }
      18%  { transform: translateY(32px); animation-timing-function: cubic-bezier(0.8,0,1,1); }
      100% { transform: translateY(-200vh); }
    }
    #lockCard.unlocking {
      animation: lockCardUnlock 0.55s linear forwards;
    }

    #lockCard {
      position: relative;
      display: flex; align-items: center; gap: 28px;
      padding: 36px 40px 32px;
      width: min(420px, 92vw);
    }
    .lock-left {
      display: flex; flex-direction: column; align-items: center; gap: 10px; flex-shrink: 0;
    }
    .lock-icon {
      width: 72px; height: 72px; border-radius: 18px;
      object-fit: cover; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .lock-app-name { font-size: 15px; font-weight: 200; white-space: nowrap; }
    .lock-right {
      display: flex; flex-direction: column; gap: 10px; flex: 1; min-width: 0;
    }
    .lock-label { font-size: 11px; color: var(--dim); letter-spacing: 0.5px; }
    .lock-pw-input {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 20px; padding: 10px 18px;
      font-size: 16px; color: var(--text); font-family: inherit;
      outline: none; letter-spacing: 6px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .lock-pw-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.15);
    }
    .lock-pw-input.error {
      border-color: #e53935;
      animation: shake 0.32s cubic-bezier(0.36,0.07,0.19,0.97);
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%      { transform: translateX(-8px); }
      60%      { transform: translateX(8px); }
      80%      { transform: translateX(-4px); }
    }
    .lock-submit-btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 20px; padding: 10px 0;
      font-size: 14px; font-family: inherit; font-weight: 200; cursor: pointer;
      letter-spacing: 0.5px;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .lock-submit-btn:hover  { filter: brightness(1.15); }
    .lock-submit-btn:active { transform: scale(0.95); }
    .lock-error-msg { font-size: 11px; color: #e57373; text-align: center; min-height: 16px; }

    #pwUnlockModal { width: min(320px,88vw); padding: 32px 28px 24px; z-index: 230; }
    #pwUnlockModal .pwunlock-title {
      font-size: 15px; font-weight: 200; text-align: center;
      margin-bottom: 10px; color: var(--text);
    }
    #pwUnlockModal .pwunlock-desc {
      font-size: 12px; color: var(--dim); text-align: center;
      line-height: 1.6; margin-bottom: 20px;
    }
    #pwUnlockModal .pwunlock-btns { display: flex; gap: 10px; }
    #pwUnlockModal .pwunlock-btns button {
      flex: 1; padding: 10px 0; border-radius: 14px; border: none;
      cursor: pointer; font-size: 14px; font-family: inherit;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #pwUnlockModal .pwunlock-btns button:active { transform: scale(0.95); }
    #pwUnlockModal .btn-cancel { background: rgba(255,255,255,0.08); color: var(--text); }
    #pwUnlockModal .btn-danger {
      background: rgba(229,57,53,0.18); color: #e57373;
      border: 1px solid rgba(229,57,53,0.3);
    }
    #pwUnlockModal .btn-danger:hover { background: rgba(229,57,53,0.28); }

    header {
      position: fixed; top: var(--header-top, 12px); left: 50%; transform: translateX(-50%);
      padding: 4px; padding-top: 4px; display: flex; gap: 4px; align-items: center;
      width: fit-content; max-width: 95vw; justify-content: center;
      z-index: 9998; border-radius: var(--radius);
      overflow: visible;
      transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1), transform 0.22s cubic-bezier(0.4,0,0.2,1), border-radius 0.18s, padding-top 0.18s, top 0.38s cubic-bezier(0.4,0,0.2,1);
    }
    header:hover,
    header.header-expanded { border-radius: 20px; padding-top: 38px; }
    header.no-move:hover   { border-radius: var(--radius); padding-top: 4px; }
    header.returning {
      transition: left 0.38s cubic-bezier(0.4,0,0.2,1),
                  top  0.38s cubic-bezier(0.4,0,0.2,1),
                  opacity 0.22s cubic-bezier(0.4,0,0.2,1),
                  transform 0.38s cubic-bezier(0.4,0,0.2,1) !important;
    }
    #headerTopBar {
      position: absolute; left: 0; right: 0;
      top: 0; height: 38px;
      cursor: grab; pointer-events: none;
      border-radius: 20px 20px 0 0;
      display: flex; align-items: center;
      justify-content: center; padding: 0 12px;
      opacity: 0;
      transition: opacity 0.08s cubic-bezier(0.4,0,0.2,1);
    }
    header:hover #headerTopBar,
    header.header-expanded #headerTopBar {
      pointer-events: auto;
      opacity: 1;
      transition: opacity 0.18s cubic-bezier(0.4,0,0.2,1) 0.18s;
    }
    header.no-move #headerTopBar,
    header.no-move:hover #headerTopBar {
      opacity: 0 !important; pointer-events: none !important;
    }
    #headerTopBar::after {
      content: ''; position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 32px; height: 4px; border-radius: 2px;
      background: rgba(255,255,255,0.55);
      pointer-events: none;
    }
    #headerYellowBtn {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      width: 14px; height: 14px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffd966, #f0b429);
      border: 1px solid rgba(0,0,0,0.25); box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      cursor: pointer; padding: 0;
      transition: filter 0.15s;
    }
    #headerYellowBtn:hover  { filter: brightness(1.18); }
    #headerYellowBtn:active { filter: brightness(0.9); }
    #headerTopBar:active { cursor: grabbing; }
    header button {
      background: transparent; border: none; cursor: pointer;
      padding: 8px 16px; font-size: 13px; color: inherit;
      border-radius: 20px; font-family: inherit; white-space: nowrap;
      -webkit-user-select: none; user-select: none;
      transition: background 0.18s cubic-bezier(0.4,0,0.2,1),
                  transform 0.12s cubic-bezier(0.34,1.56,0.64,1), color 0.18s;
    }
    header button:hover  { background: var(--hover); }
    header button:active { transform: scale(0.88); background: rgba(255,255,255,0.13); }
    #headerShareBtn {
      max-width: 0; opacity: 0; padding-left: 0; padding-right: 0; pointer-events: none; overflow: hidden;
    }
    #headerShareBtn.animated {
      transition: max-width 0.26s cubic-bezier(0.34,1.2,0.64,1), opacity 0.2s cubic-bezier(0.4,0,0.2,1), padding 0.26s cubic-bezier(0.34,1.2,0.64,1), transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #headerShareBtn.visible { max-width: 120px; opacity: 1; padding-left: 16px; padding-right: 16px; pointer-events: auto; }
    #headerPageBtn {
      max-width: 0; opacity: 0; padding-left: 0; padding-right: 0;
      overflow: hidden; pointer-events: none;
    }
    #headerPageBtn.animated {
      transition: max-width 0.26s cubic-bezier(0.34,1.2,0.64,1), opacity 0.2s cubic-bezier(0.4,0,0.2,1), padding 0.26s cubic-bezier(0.34,1.2,0.64,1), transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #headerPageBtn.visible { max-width: 120px; opacity: 1; padding-left: 16px; padding-right: 16px; pointer-events: auto; }
    @media (max-width: 480px) {
      header { gap: 2px; padding: 4px 6px; }
      header button { padding: 6px 10px; font-size: 11px; }
    }

    #options {
      position: fixed; top: 50%; left: 50%; z-index: 170;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      width: max-content; min-width: 240px; max-width: min(340px, calc(100vw - 32px));
      padding: 12px; padding-top: 36px; border-radius: 18px;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4,0,0.2,1),
                  transform 0.38s cubic-bezier(0.34,1.3,0.64,1);
    }
    #options.show    { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
    #options.closing {
      opacity: 0; transform: translate(-50%, calc(-50% + 16px)) scale(0.9); pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.4,0,1,1), transform 0.18s cubic-bezier(0.4,0,1,1);
    }
    #options div { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: nowrap; }
    .label { width: 60px; color: var(--dim); font-size: 11px; white-space: nowrap; flex-shrink: 0; }
    .page-nav-mode-btn {
      flex: 1; padding: 5px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12);
      background: transparent; color: var(--dim); cursor: pointer;
      font-size: 11px; font-family: inherit;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .page-nav-mode-btn:hover  { background: rgba(255,255,255,0.08); color: var(--text); }
    .page-nav-mode-btn.active {
      background: rgba(var(--accent-rgb), 0.2);
      border-color: rgba(var(--accent-rgb), 0.5);
      color: var(--accent);
    }
    #clearAutoSaveBtn {
      background: rgba(229,57,53,0.12); border: 1px solid rgba(229,57,53,0.4);
      border-radius: 8px; cursor: pointer; padding: 0 7px; height: 26px;
      display: inline-flex; align-items: center; justify-content: center;
      transition: background 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #clearAutoSaveBtn:active { transform: scale(0.92); background: rgba(229,57,53,0.22); }
    .options-version {
      font-size: 10px; color: var(--dim); justify-content: center;
      border-top: 1px solid rgba(128,128,128,0.1); padding-top: 8px; margin-top: 8px;
      text-align: center; display: flex; flex-direction: column;
    }
    #pwLockRow { border-top: 1px solid rgba(128,128,128,0.1); padding-top: 8px; margin-top: 4px; }
    #pwLockRow + #bioRegisterRow { margin-top: 0; }
    #pwLockRow .label { white-space: nowrap; width: auto; }

    .close-dot {
      position: absolute; top: 12px; left: 12px;
      width: 14px; height: 14px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935);
      border: 1px solid rgba(0,0,0,0.25); box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      cursor: pointer; padding: 0; display: inline-block;
      transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), filter 0.15s;
    }
    .close-dot:hover  { transform: scale(1.2); filter: brightness(1.1); }
    .close-dot:active { transform: scale(0.88); }
    .close-dot:focus  { outline: none; }
    .info-dot {
      position: absolute; top: 12px; right: 12px;
      width: 14px; height: 14px; border-radius: 50%;
      background: rgba(255,255,255,0.18); border: 1px solid #494949;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25); cursor: pointer; padding: 0;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 9px; font-weight: bold; color: var(--text);
      font-style: italic; font-family: Georgia, serif; line-height: 1;
      transition: transform 0.15s;
    }
    .info-dot:hover  { transform: scale(1.1); }
    .info-dot:active { transform: scale(0.9); }
    .info-dot:focus  { outline: none; }

    /* 共通モーダルパネル */
    .panel-modal {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      opacity: 0; pointer-events: none;
      box-shadow: 0 16px 50px rgba(0,0,0,0.3);
      transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1), transform 0.26s cubic-bezier(0.34,1.4,0.64,1);
    }
    .panel-modal.show    { opacity: 1; transform: translate(-50%,-50%) scale(1); pointer-events: auto; }
    .panel-modal.closing {
      opacity: 0; transform: translate(-50%, calc(-50% + 16px)) scale(0.9); pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.4,0,1,1), transform 0.18s cubic-bezier(0.4,0,1,1);
    }

    .modal { width: fit-content; min-width: 280px; padding: 24px 30px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 180; }
    .modal p { margin: 0 0 15px; font-size: 14px; white-space: nowrap; font-weight: bold; }
    #fileNameInput {
      width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
      background: #333; color: inherit; font-family: inherit; font-size: 14px;
      margin-bottom: 20px; outline: none; text-align: center;
    }
    .modal-btns { display: flex; gap: 10px; width: 100%; }
    .modal-btns button {
      flex: 1; padding: 10px 0; border-radius: 15px; border: none; cursor: pointer;
      font-size: 14px; font-family: inherit;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .modal-btns button:active { transform: scale(0.93); filter: brightness(0.9); }
    .btn-main { background: var(--accent); color: white; }
    .btn-sub  { background: var(--hover); color: var(--text); }

    .save-meta-modal { width: min(320px,92vw); padding: 26px 24px 20px; border-radius: 22px; z-index: 200; box-shadow: 0 16px 50px rgba(0,0,0,0.35); }
    .save-meta-modal p { font-size: 15px; white-space: nowrap; font-weight: 200; }
    .save-meta-desc { font-size: 12px; color: var(--dim); text-align: center; line-height: 1.65; margin-bottom: 18px; }
    .save-meta-desc span { font-size: 10px; }
    .save-meta-remember { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 18px; font-size: 11px; color: var(--dim); }

    #pwSetModal { width: min(340px,92vw); padding: 28px 26px 22px; border-radius: 22px; z-index: 220; box-shadow: 0 16px 50px rgba(0,0,0,0.25); }
    #pwSetModal .pwset-title { font-size: 15px; font-weight: 200; margin-bottom: 18px; text-align: center; }
    .pwset-field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .pwset-field label { font-size: 11px; color: var(--dim); }
    .pwset-input {
      width: 100%; background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 14px;
      padding: 10px 16px; font-size: 14px; color: var(--text); font-family: inherit;
      outline: none; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .pwset-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(var(--accent-rgb),0.15); }
    .pwset-strength {
      font-size: 10px; padding: 3px 8px; border-radius: 6px;
      display: inline-block; margin-top: 4px;
    }
    .pwset-strength.weak   { background: rgba(229,57,53,0.15); color: #e57373; }
    .pwset-strength.medium { background: rgba(255,193,7,0.15);  color: #ffd54f; }
    .pwset-strength.strong { background: rgba(76,175,80,0.15);  color: #81c784; }
    #pwSetError    { font-size: 11px; color: #e57373; text-align: center; min-height: 16px; margin-bottom: 10px; }
    #pwSetProgress { font-size: 10px; color: var(--dim); text-align: center; min-height: 14px; margin-bottom: 8px; }
    .pwset-btns { display: flex; gap: 10px; }
    .pwset-btns button {
      flex: 1; padding: 10px 0; border-radius: 14px; border: none; cursor: pointer;
      font-size: 14px; font-family: inherit;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .pwset-btns button:active { transform: scale(0.95); }
    #pwSetSaveBtn   { background: var(--accent); color: #fff; font-weight: 700; }
    #pwSetCancelBtn { background: rgba(255,255,255,0.08); color: var(--text); }
    #pwSetSaveBtn:disabled { opacity: 0.4; cursor: not-allowed; }

    #devMessageModal { width: min(320px,88vw); padding: 28px 24px 22px; border-radius: 20px; z-index: 210; box-shadow: 0 12px 40px rgba(0,0,0,0.18); }
    .dev-title-main { text-align: center; font-weight: bold; font-size: 1.1em; margin-bottom: 8px; }
    #devMessageModal .dev-body { font-size: 13px; line-height: 1.85; white-space: pre-wrap; }
    #devMessageModal .dev-close {
      margin-top: 18px; display: block; width: 100%; padding: 9px 0;
      border-radius: 12px; border: none; background: var(--accent); color: #fff;
      font-family: inherit; font-size: 13px; cursor: pointer;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #devMessageModal .dev-close:hover  { filter: brightness(1.15); }
    #devMessageModal .dev-close:active { transform: scale(0.95); filter: brightness(0.9); }

    #bioPromptModal {
      width: min(300px, 88vw); padding: 28px 24px 22px;
      border-radius: 22px; z-index: 225; box-shadow: 0 16px 50px rgba(0,0,0,0.3);
    }

    textarea {
      position: absolute; inset: 0; border: none; outline: none;
      padding: 80px 30px 100px; background: transparent;
      color: inherit; line-height: 1.8; font-size: 18px;
      resize: none; width: 100%; height: auto;
      overflow: auto; scrollbar-width: none; -ms-overflow-style: none;
      transition: padding-top 0.3s ease;
    }
    textarea::-webkit-scrollbar { display: none; }

    @keyframes slideInRight  { from { opacity:0; transform:translateX(48px);  } to { opacity:1; transform:translateX(0); } }
    textarea.page-slide-in-right  { animation: slideInRight  0.26s cubic-bezier(0.34,1.2,0.64,1) forwards; }
    #penCanvas.page-slide-in-right  { animation: slideInRight  0.26s cubic-bezier(0.34,1.2,0.64,1) forwards; }

    footer {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      padding: 5px 14px; font-size: 11px; color: var(--dim);
      display: flex; gap: 8px; max-width: 90vw; justify-content: center;
      white-space: nowrap; border-radius: var(--radius);
      z-index: 150;
      transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), opacity 0.22s cubic-bezier(0.4,0,0.2,1);
    }
    footer.hidden { transform: translate(-50%, 50px); opacity: 0; pointer-events: none; }

    .ft-slot {
      position: relative; overflow: hidden;
      display: inline-block; vertical-align: middle; line-height: 1.4;
    }
    .ft-slot-inner { display: block; }
    @keyframes ftSlotOut {
      from { transform: translateY(0);     opacity: 1; filter: blur(0px); }
      to   { transform: translateY(-110%); opacity: 0; filter: blur(4px); }
    }
    @keyframes ftSlotIn {
      from { transform: translateY(110%);  opacity: 0; filter: blur(4px); }
      to   { transform: translateY(0);     opacity: 1; filter: blur(0px); }
    }
    .ft-slot-inner.slot-out { animation: ftSlotOut 0.08s cubic-bezier(0.4,0,1,1) forwards; }
    .ft-slot-inner.slot-in  { animation: ftSlotIn  0.14s cubic-bezier(0.34,1.3,0.64,1) forwards; }

    #penToggleBtn {
      position: fixed; bottom: 15px; right: 16px;
      width: 38px; height: 38px; border-radius: 50%; border: none;
      background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--dim); font-size: 17px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 120;
      box-shadow: 0 4px 14px rgba(0,0,0,0.18);
      transition: background 0.2s, color 0.2s, transform 0.2s cubic-bezier(0.34,1.56,0.64,1),
                  box-shadow 0.2s, border-color 0.2s;
      -webkit-user-select: none; user-select: none;
    }
    body.modal-open #penToggleBtn,
    body.modal-open #penToolbar { opacity: 0; pointer-events: none; transition: opacity 0.18s; }
    #penToggleBtn:hover  { background: var(--hover); }
    #penToggleBtn:active { transform: scale(0.88); }
    #penToggleBtn.pen-active {
      background: rgba(220,50,50,0.18);
      border-color: rgba(220,50,50,0.5);
      color: #e05050;
      box-shadow: 0 4px 18px rgba(220,50,50,0.22);
    }

    #penToolbar {
      position: fixed; bottom: 15px; right: 16px;
      display: flex; flex-direction: column-reverse; align-items: center; gap: 8px;
      z-index: 121; pointer-events: none;
      padding-bottom: 46px; /* penToggleBtn(38px) + gap */
    }

    .pen-toolbar-item {
      opacity: 0;
      transform: translateY(0) scale(0.6);
      pointer-events: none;
      transition:
        opacity   0.1s cubic-bezier(0.4,0,1,1),
        transform 0.1s cubic-bezier(0.4,0,1,1);
    }

    #penToolbar.show .pen-toolbar-item {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    #penToolbar.show .pen-toolbar-item:nth-child(1) {
      transition: opacity 0.22s cubic-bezier(0.34,1.4,0.64,1) 0.02s, transform 0.26s cubic-bezier(0.34,1.4,0.64,1) 0.02s;
    }
    #penToolbar.show .pen-toolbar-item:nth-child(2) {
      transition: opacity 0.22s cubic-bezier(0.34,1.4,0.64,1) 0.06s, transform 0.26s cubic-bezier(0.34,1.4,0.64,1) 0.06s;
    }
    #penToolbar.show .pen-toolbar-item:nth-child(3) {
      transition: opacity 0.22s cubic-bezier(0.34,1.4,0.64,1) 0.10s, transform 0.26s cubic-bezier(0.34,1.4,0.64,1) 0.10s;
    }
    #penToolbar.show .pen-toolbar-item:nth-child(4) {
      transition: opacity 0.22s cubic-bezier(0.34,1.4,0.64,1) 0.14s, transform 0.26s cubic-bezier(0.34,1.4,0.64,1) 0.14s;
    }

    .pen-tool-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: var(--dim);
      box-shadow: 0 3px 10px rgba(0,0,0,0.18);
      transition: background 0.15s, color 0.15s, border-color 0.15s,
                  transform 0.15s cubic-bezier(0.34,1.56,0.64,1);
      -webkit-user-select: none; user-select: none;
    }
    .pen-tool-btn:hover  { background: var(--hover); }
    .pen-tool-btn:active { transform: scale(0.88); }
    .pen-tool-btn.active {
      background: rgba(220,50,50,0.18);
      border-color: rgba(220,50,50,0.5);
      color: #e05050;
    }

    #penSizeWrap {
      background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 18px; padding: 6px 8px;
      display: flex; flex-direction: column; gap: 5px; align-items: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.18);
    }
    .pen-size-dot {
      border-radius: 50%; background: #e05050; cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), opacity 0.15s;
      opacity: 0.45;
    }
    .pen-size-dot:hover   { transform: scale(1.2); opacity: 0.8; }
    .pen-size-dot.active  { opacity: 1; transform: scale(1.15); }

    #penCanvas {
      position: fixed; inset: 0; z-index: 110;
      pointer-events: none; touch-action: none;
      cursor: crosshair;
    }
    #penCanvas.pen-mode { pointer-events: auto; }

    #penUndoBtn  { font-size: 15px; }
    #penClearBtn { font-size: 13px; }

    #penEraserBtn.eraser-active {
      background: rgba(255,255,255,0.18);
      border-color: rgba(255,255,255,0.55);
      color: var(--text);
    }

    #penCanvas.eraser-mode { cursor: none; }

    #eraserCursor {
      position: fixed; pointer-events: none; z-index: 112;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.12);
      display: none;
      transform: translate(-50%, -50%);
      transition: width 0.08s, height 0.08s;
    }
    #eraserCursor.visible { display: block; }
    #backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0); z-index: 9; display: none; pointer-events: none; transition: background 0.22s cubic-bezier(0.4,0,0.2,1); }
    #backdrop.show { display: block; pointer-events: auto; background: rgba(0,0,0,0.55); }

    .toast {
      position: fixed; right: 16px; bottom: 62px;
      min-width: 200px; max-width: 420px;
      background: var(--ui-bg); color: var(--text); z-index: 400;
      overflow: hidden;
      opacity: 0; filter: blur(6px);
      transform: translateY(120%) scale(0.96);
      transition: transform 0.28s cubic-bezier(0.34,1.2,0.64,1), opacity 0.24s cubic-bezier(0.34,1.2,0.64,1), filter 0.24s cubic-bezier(0.4,0,0.2,1);
      display: flex; align-items: center; padding: 10px 14px; gap: 10px; font-size: 13px;
    }
    .toast.show {
      transform: translateY(0) scale(1); opacity: 1; filter: blur(0px);
    }
    .toast .count { position: absolute; left: 0; bottom: 0; height: 3px; background: var(--accent); width: 100%; transition: width linear; }
    .toast .msg   { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    @media (max-width: 480px) {
      textarea, #searchHighlightMirror { padding: 72px 16px 90px; font-size: 16px; }
      #contextMenu { max-width: calc(100vw - 24px); }
    }

    @keyframes contextMenuIn { from { opacity:0; transform:scale(0.72); } to { opacity:1; transform:scale(1); } }
    #contextMenu {
      position: fixed; z-index: 1000; display: none;
      min-width: 120px; box-shadow: 0 4px 20px rgba(0,0,0,0.22);
      border-radius: 20px; overflow: hidden; padding: 4px; transform-origin: top left;
    }
    #contextMenu.animating { animation: contextMenuIn 0.16s cubic-bezier(0.34,1.4,0.64,1) forwards; }
    #contextMenu button {
      width: 100%; padding: 8px 16px; background: transparent; border: none;
      text-align: left; cursor: pointer; font-size: 14px; color: var(--text); font-family: inherit;
      border-radius: 16px; transition: background 0.15s, transform 0.1s cubic-bezier(0.34,1.56,0.64,1);
    }
    #contextMenu button:hover  { background: var(--hover); }
    #contextMenu button:active { transform: scale(0.95); background: rgba(255,255,255,0.12); }
    .ctx-divider { height: 1px; background: rgba(128,128,128,0.18); margin: 3px 8px; }

    #searchHighlightMirror {
      position: absolute; inset: 0; pointer-events: none; z-index: 1;
      padding: 80px 30px 100px; line-height: 1.8; font-size: 18px;
      white-space: pre-wrap; word-wrap: break-word;
      overflow: hidden; color: transparent; transition: padding-top 0.3s ease;
    }
    #searchHighlightMirror mark { border-radius: 3px; color: transparent; background: var(--accent); opacity: 0.18; }
    #searchHighlightMirror mark.current { opacity: 0.38; }

    #searchCount {
      position: absolute; top: 0; right: 0; height: 36px;
      display: flex; align-items: center; padding-right: 14px;
      font-size: 11px; pointer-events: none;
    }

    #searchPanel {
      position: fixed; top: 50%; left: 50%; z-index: 170;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      width: 300px; padding: 12px 16px 16px; padding-top: 40px; border-radius: 18px;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4,0,0.2,1),
                  transform 0.38s cubic-bezier(0.34,1.3,0.64,1);
    }
    #searchPanel.show    { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
    #searchPanel.closing {
      opacity: 0; transform: translate(-50%, calc(-50% + 16px)) scale(0.9); pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.4,0,1,1), transform 0.18s cubic-bezier(0.4,0,1,1);
    }
    #searchPanelDragHandle::after {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      width: 32px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.45);
      pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
    #searchPanelDragHandle:hover::after { opacity: 1; }
    .sp-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .sp-row:last-child { margin-bottom: 0; }
    #searchInput {
      flex: 1; border: none; outline: none; background: rgba(255,255,255,0.07);
      font-size: 14px; color: var(--text); font-family: inherit;
      padding: 7px 12px; border-radius: 10px;
    }
    #searchCount { font-size: 11px; color: var(--dim); white-space: nowrap; min-width: 44px; text-align: right; }
    .sp-btn {
      background: transparent; border: none; cursor: pointer; font-size: 13px;
      color: var(--dim); padding: 4px 10px; border-radius: 8px; font-family: inherit;
      transition: background 0.15s, color 0.15s, transform 0.1s cubic-bezier(0.34,1.56,0.64,1);
    }
    .sp-btn:hover  { background: var(--hover); color: var(--text); }
    .sp-btn:active { transform: scale(0.88); }

    #translatePanel {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      width: min(480px, 92vw); max-height: 70vh; z-index: 1100; border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.22);
      display: flex; flex-direction: column; opacity: 0; pointer-events: none; overflow: hidden;
      transition: opacity 0.3s cubic-bezier(0.4,0,0.2,1), transform 0.38s cubic-bezier(0.34,1.3,0.64,1);
    }
    #translatePanel.show    { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
    #translatePanel.closing {
      opacity: 0; transform: translate(-50%, calc(-50% + 16px)) scale(0.9); pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.4,0,1,1), transform 0.18s cubic-bezier(0.4,0,1,1);
    }
    .drag-handle { cursor: grab; user-select: none; -webkit-user-select: none; }
    .drag-handle:active { cursor: grabbing; }
    #optionsDragHandle::after, .swp-header::after {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      width: 32px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.45);
      pointer-events: none; opacity: 0; transition: opacity 0.2s cubic-bezier(0.4,0,0.2,1);
    }
    #optionsDragHandle:hover::after, .swp-header:hover::after { opacity: 1; }
    #translatePanel .tp-header {
      display: flex; align-items: center; padding: 11px 14px;
      border-bottom: 1px solid rgba(128,128,128,0.15); flex-shrink: 0; position: relative;
    }
    #translatePanel .tp-dot {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935);
      border: 1px solid rgba(0,0,0,0.2); box-shadow: 0 1px 4px rgba(0,0,0,0.2); cursor: pointer; transition: 0.15s; z-index: 1;
    }
    #translatePanel .tp-lang {
      position: absolute; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--dim);
    }
    #translatePanel .tp-lang select { border-radius: 10px; padding: 3px 6px; font-size: 12px; font-family: inherit; border: 1px solid rgba(255,255,255,0.1); background: #333; color: var(--text); cursor: pointer; }
    #translatePanel .tp-lang .tp-arrow { font-size: 13px; color: var(--dim); user-select: none; }
    #translatePanel .tp-body { padding: 14px 18px 10px; overflow-y: auto; flex: 1; scrollbar-width: none; }
    #translatePanel .tp-body::-webkit-scrollbar { display: none; }
    #translatePanel .tp-src { font-size: 13px; color: var(--dim); margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(128,128,128,0.12); line-height: 1.6; word-break: break-all; }
    #translatePanel .tp-result, #translatePanel .tp-result-text { font-size: 17px; line-height: 1.75; word-break: break-all; }
    #translatePanel .tp-result-text { margin: 0; }
    #translatePanel .tp-loading { text-align: center; padding: 24px 0; color: var(--dim); font-size: 13px; }
    #translatePanel .tp-error   { color: #e53935; font-size: 13px; padding: 16px 0; }
    #translatePanel .tp-powered { font-size: 10px; color: var(--dim); text-align: center; padding: 1px 1px 4px; border-top: 1px solid rgba(128,128,128,0.12); flex-shrink: 0; }

    #searchWebPanel {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      width: min(520px, 94vw); max-height: min(600px, 82vh); z-index: 1100; border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.22);
      display: flex; flex-direction: column; opacity: 0; pointer-events: none; overflow: hidden;
      transition: opacity 0.3s cubic-bezier(0.4,0,0.2,1), transform 0.38s cubic-bezier(0.34,1.3,0.64,1);
    }
    #searchWebPanel.show    { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
    #searchWebPanel.closing {
      opacity: 0; transform: translate(-50%, calc(-50% + 16px)) scale(0.9); pointer-events: none;
      transition: opacity 0.14s cubic-bezier(0.4,0,1,1), transform 0.18s cubic-bezier(0.4,0,1,1);
    }
    #searchWebPanel .swp-header { display: flex; align-items: center; padding: 10px 14px 8px; border-bottom: 1px solid rgba(128,128,128,0.15); flex-shrink: 0; gap: 8px; position: relative; }
    #searchWebPanel .swp-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935); border: 1px solid rgba(0,0,0,0.2); box-shadow: 0 1px 4px rgba(0,0,0,0.2); cursor: pointer; transition: 0.15s; }
    #searchWebPanel .swp-wiki-btn { background: transparent; border: none; cursor: pointer; font-size: 11px; color: var(--dim); padding: 3px 10px; border-radius: 10px; font-family: inherit; transition: 0.15s; white-space: nowrap; flex-shrink: 0; }
    #searchWebPanel .swp-wiki-btn:hover { background: var(--hover); color: var(--text); }
    #searchWebPanel .swp-body { flex: 1; overflow-y: auto; scrollbar-width: none; padding: 12px 16px 16px; }
    #searchWebPanel .swp-body::-webkit-scrollbar { display: none; }
    .result-anim-wrap { overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.38s cubic-bezier(0.4,0,0.2,1), opacity 0.18s cubic-bezier(0.4,0,0.2,1); }
    .result-anim-wrap.open { opacity: 1; }
    .result-anim-item { opacity: 0; transform: translateY(-8px); transition: opacity 0.26s cubic-bezier(0.4,0,0.2,1), transform 0.26s cubic-bezier(0.34,1.2,0.64,1); }
    .result-anim-item.visible { opacity: 1; transform: translateY(0); }
    .swp-empty   { text-align: center; padding: 32px 0; font-size: 13px; color: var(--dim); }
    .swp-loading { text-align: center; padding: 32px 0; font-size: 13px; color: var(--dim); }
    .swp-abstract { background: rgba(128,128,128,0.07); border-radius: 12px; padding: 12px 14px; margin-bottom: 14px; }
    .swp-abstract-heading { font-size: 14px; font-weight: bold; margin-bottom: 6px; }
    .swp-abstract-desc    { font-size: 12px; color: var(--accent); margin-bottom: 6px; font-weight: bold; }
    .swp-abstract-text    { font-size: 13px; line-height: 1.65; }
    .swp-abstract-src     { font-size: 11px; color: var(--dim); margin-top: 6px; }
    .swp-abstract-src a   { color: var(--accent); text-decoration: none; }
    .swp-abstract-src a:hover { text-decoration: underline; }
    .swp-results-label { font-size: 11px; color: var(--dim); margin-bottom: 8px; padding-left: 2px; }
    .swp-result-item { display: flex; flex-direction: column; gap: 3px; padding: 10px 12px; border-radius: 12px; cursor: pointer; text-decoration: none; transition: background 0.15s; margin-bottom: 4px; color: var(--text); }
    .swp-result-item:hover { background: var(--hover); }
    .swp-result-title { font-size: 13px; font-weight: bold; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .swp-result-desc  { font-size: 12px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: var(--text); font-family: 'Source Han Sans JP', 'Noto Sans JP', 'ヒラギノ角ゴ ProN', sans-serif; font-weight: 200; }
    .swp-result-url   { font-size: 11px; color: var(--dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .ios-toggle { position: relative; display: inline-block; width: 44px; height: 26px; flex-shrink: 0; }
    .ios-toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .ios-toggle-slider { position: absolute; cursor: pointer; inset: 0; background: rgba(120,120,128,0.32); border-radius: 13px; transition: background 0.3s cubic-bezier(0.4,0,0.2,1); }
    .ios-toggle-slider::before { content: ''; position: absolute; height: 22px; width: 22px; left: 2px; top: 2px; border-radius: 50%; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.24s cubic-bezier(0.34,1.3,0.64,1); }
    .ios-toggle input:checked + .ios-toggle-slider { background: #34c759; }
    .ios-toggle input:checked + .ios-toggle-slider::before { transform: translateX(18px); }
    .ios-toggle-sm { width: 28px; height: 17px; }
    .ios-toggle-sm .ios-toggle-slider { border-radius: 9px; }
    .ios-toggle-sm .ios-toggle-slider::before { height: 13px; width: 13px; left: 2px; top: 2px; }
    .ios-toggle-sm input:checked + .ios-toggle-slider::before { transform: translateX(11px); }

    .lock-bio-btn {
      width: 100%; background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 20px;
      padding: 10px 0; font-size: 14px; font-family: inherit;
      font-weight: 200; color: var(--text); cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: filter 0.15s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .lock-bio-btn:hover  { filter: brightness(1.15); }
    .lock-bio-btn:active { transform: scale(0.95); }
    .lock-bio-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    #bioRegisterRow { padding-top: 0; margin-top: 4px; }

    #bioPromptModal .bio-prompt-icon { font-size: 36px; text-align: center; margin-bottom: 8px; }
    #bioPromptModal .bio-prompt-title { font-size: 16px; font-weight: 700; text-align: center; margin-bottom: 6px; }
    #bioPromptModal .bio-prompt-desc { font-size: 12px; color: var(--dim); text-align: center; line-height: 1.65; margin-bottom: 20px; }
    #bioPromptModal .bio-prompt-btns { display: flex; flex-direction: column; gap: 8px; }
    #bioPromptModal .btn-bio {
      padding: 12px 0; border-radius: 16px; border: none; cursor: pointer;
      font-size: 14px; font-family: inherit; font-weight: 200;
      background: var(--accent); color: #fff;
      transition: filter 0.15s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #bioPromptModal .btn-bio:hover  { filter: brightness(1.12); }
    #bioPromptModal .btn-bio:active { transform: scale(0.96); }
    #bioPromptModal .btn-bio-skip {
      padding: 10px 0; border-radius: 16px; border: none; cursor: pointer;
      font-size: 13px; font-family: inherit; font-weight: 200;
      background: transparent; color: var(--dim);
      transition: color 0.15s;
    }
    #bioPromptModal .btn-bio-skip:hover { color: var(--text); }
    .swatch {
      width: 20px; height: 20px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent; flex-shrink: 0;
      transition: transform 0.18s cubic-bezier(0.34,1.56,0.64,1), border-color 0.18s;
    }
    .swatch:hover  { transform: scale(1.2); }
    .swatch:active { transform: scale(0.9); }
    .swatch.active { border-color: var(--text); }

    #diffOverlay { opacity: 0; transition: opacity 0.25s ease; }
    #diffOverlay.diff-overlay-visible { opacity: 1; }
    #diffContent { position: absolute; inset: 0; padding: 80px 30px 40px; overflow: auto; line-height: 1.8; font-size: 18px; white-space: pre-wrap; word-wrap: break-word; scrollbar-width: none; -ms-overflow-style: none; }
    #diffHeader {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      padding: 4px 8px; display: flex; align-items: center; gap: 6px;
      z-index: 310; border-radius: 25px;
      transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1), transform 0.22s cubic-bezier(0.4,0,0.2,1);
    }
    #diffHeader.diff-enter   { opacity: 0; transform: translateX(-50%) scale(0.82); }
    #diffHeader.diff-visible { opacity: 1; transform: translateX(-50%) scale(1); }
    #diffHeader .diff-label   { font-size: 12px; color: var(--dim); white-space: nowrap; }
    #diffHeader .diff-divider { width: 1px; height: 16px; background: rgba(128,128,128,0.25); display: inline-block; }
    #diffHeader .diff-legend  { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--dim); }
    #diffHeader .diff-legend-dot { display: inline-block; width: 14px; height: 14px; border-radius: 3px; }
    #diffHeader .diff-legend-dot.add { background: rgba(100,210,100,0.45); }
    #diffHeader .diff-legend-dot.del { background: rgba(255,80,80,0.45); }
    #diffHeader .diff-close-btn { background: transparent; border: none; cursor: pointer; font-size: 13px; color: var(--dim); padding: 2px 8px; border-radius: 20px; font-family: inherit; transition: 0.15s; }
    #diffHeader .diff-close-btn:hover { background: var(--hover); }
    header.diff-exit    { opacity: 0; transform: translateX(-50%) scale(0.82); pointer-events: none; }
    header.diff-restore { opacity: 1; transform: translateX(-50%) scale(1); pointer-events: auto; }

    body.no-anim *, body.no-anim *::before, body.no-anim *::after { transition: none !important; animation: none !important; }
    body.no-anim .glass, body.no-anim .toast, body.no-anim #options,
    body.no-anim #translatePanel, body.no-anim #searchWebPanel,
    body.no-anim #devMessageModal, body.no-anim .modal { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; background: rgba(30,30,30,0.97) !important; }

    #pageSwipeTrigger   { position: fixed; right: 0; top: 0; width: 24px; height: 100%; z-index: 300; }

    /* 右側ページパネルのプルタブ */
    #pagePullTab {
      position: fixed;
      right: 0; top: 50%; transform: translateY(-50%) translateX(100%);
      width: 36px; height: 72px;
      background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.18);
      border-right: none;
      border-radius: 18px 0 0 18px;
      z-index: 321;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      opacity: 0; pointer-events: none;
      transition: opacity 0.28s cubic-bezier(0.34,1.2,0.64,1),
                  transform 0.32s cubic-bezier(0.34,1.2,0.64,1),
                  background 0.15s;
      box-shadow: -2px 0 12px rgba(0,0,0,0.18);
    }
    #pagePullTab:hover  { background: rgba(60,60,60,0.7); }
    #pagePullTab:active { transform: translateY(-50%) translateX(0) scale(0.93); }
    #pagePullTab.visible { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateX(0); }
    #pagePullTab.panel-open {
      opacity: 0; pointer-events: none; transform: translateY(-50%) translateX(100%);
      transition: opacity 0.28s cubic-bezier(0.36,0,0.66,-0.2),
                  transform 0.32s cubic-bezier(0.36,0,0.66,-0.2),
                  background 0.15s;
    }
    #pagePullTab svg { opacity: 0.7; }
    #folderSwipeTrigger { position: fixed; left: 0; top: 0; width: 24px; height: 100%; z-index: 300; }

    /* サイドバーを開くプルタブ */
    #folderPullTab {
      position: fixed;
      left: 0; top: 50%; transform: translateY(-50%) translateX(-100%);
      width: 36px; height: 72px;
      background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.18);
      border-left: none;
      border-radius: 0 18px 18px 0;
      z-index: 321;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      opacity: 0; pointer-events: none;
      transition: opacity 0.28s cubic-bezier(0.34,1.2,0.64,1),
                  transform 0.32s cubic-bezier(0.34,1.2,0.64,1),
                  background 0.15s;
      box-shadow: 2px 0 12px rgba(0,0,0,0.18);
    }
    #folderPullTab:hover { background: rgba(60,60,60,0.7); }
    #folderPullTab:active { transform: translateY(-50%) translateX(0) scale(0.93); }
    #folderPullTab.visible { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateX(0); }
    #folderPullTab.panel-open {
      opacity: 0; pointer-events: none; transform: translateY(-50%) translateX(-100%);
      transition: opacity 0.28s cubic-bezier(0.36,0,0.66,-0.2),
                  transform 0.32s cubic-bezier(0.36,0,0.66,-0.2),
                  background 0.15s;
    }
    #folderPullTab svg { opacity: 0.7; }
    #pageOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0); z-index: 310; pointer-events: none; transition: background 0.28s cubic-bezier(0.4,0,0.2,1); }
    #pageOverlay.open { background: rgba(0,0,0,0.38); pointer-events: auto; }
    #pagePanel {
      position: fixed; top: 12px; right: 12px; bottom: 16px; width: min(300px, 82vw); height: auto;
      z-index: 320; display: flex; flex-direction: column;
      transform: translateX(calc(100% + 20px)); transition: transform 0.32s cubic-bezier(0.34,1.2,0.64,1);
      overflow: hidden; background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    #pagePanel.open { transform: translateX(0); }
    #pagePanelHeader { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 12px; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.07); }
    #pagePanelHeader .pph-title { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
    #pagePanelHeader .pph-add { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--accent); color: #fff; font-size: 18px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), filter 0.15s; }
    #pagePanelHeader .pph-add:hover  { filter: brightness(1.15); }
    #pagePanelHeader .pph-add:active { transform: scale(0.88); }
    #pagePanelHeader .pph-btns { display: flex; gap: 8px; align-items: center; }
    #pagePanelHeader .pph-edit { width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.10); color: var(--text); font-size: 14px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), background 0.15s; }
    #pagePanelHeader .pph-edit:hover  { background: rgba(255,255,255,0.18); }
    #pagePanelHeader .pph-edit:active { transform: scale(0.88); }
    #pageList { flex: 1; overflow-y: auto; padding: 8px 12px 24px; scrollbar-width: none; }
    #pageList::-webkit-scrollbar { display: none; }
    .page-card { display: flex; align-items: center; gap: 12px; padding: 11px 12px; border-radius: 14px; cursor: pointer; position: relative; margin-bottom: 3px; -webkit-user-select: none; user-select: none; height: 61px; box-sizing: border-box; z-index: 1; }
    .page-card:hover  { background: rgba(255,255,255,0.07); }
    .page-card:active { background: rgba(255,255,255,0.12); }
    .page-num { width: 30px; height: 30px; border-radius: 8px; background: rgba(255,255,255,0.09); border: 1px solid rgba(255,255,255,0.10); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: var(--dim); flex-shrink: 0; }
    .page-card.active .page-num { background: var(--accent); border-color: transparent; color: #fff; }
    #pageNumIndicator { position: absolute; left: 0; right: 0; height: 61px; border-radius: 14px; background: rgba(var(--accent-rgb), 0.15); pointer-events: none; z-index: 0; transition: top 0.32s cubic-bezier(0.34,1.2,0.64,1), opacity 0.18s cubic-bezier(0.4,0,0.2,1); opacity: 1; }
    .page-info { flex: 1; min-width: 0; }
    .page-title-text { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; cursor: text; }
    .page-preview { font-size: 11px; color: var(--dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; line-height: 1.3; }
    .page-del { width: 22px; height: 22px; border-radius: 50%; border: none; background: rgba(229,57,53,0.15); color: #e53935; font-size: 14px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: 0; pointer-events: none; transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1); }
    .page-card:hover .page-del { opacity: 1; pointer-events: auto; }
    .page-del:active { transform: scale(0.88); }
    #pageMaxMsg { font-size: 11px; color: var(--dim); text-align: center; padding: 8px 0 4px; }
    .page-card .page-info, .page-card .page-del { transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1); }
    #pageList.editing .page-info, #pageList.editing .page-del { opacity: 0; pointer-events: none; }
    .page-title-edit-input { position: absolute; left: 54px; right: 12px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.08); border: 1px solid rgba(var(--accent-rgb),0.5); border-radius: 8px; padding: 5px 10px; font-size: 14px; font-weight: 600; color: var(--text); font-family: inherit; outline: none; box-sizing: border-box; opacity: 0; pointer-events: none; transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1); }
    #pageList.editing .page-title-edit-input { opacity: 1; pointer-events: auto; }
    #pagePanel.dragging, #pageOverlay.dragging { transition: none; }

    /* ===== フォルダパネル（ページパネルと同等・左スライド） ===== */
    #folderOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0); z-index: 310; pointer-events: none; transition: background 0.28s cubic-bezier(0.4,0,0.2,1); }
    #folderOverlay.open { background: rgba(0,0,0,0.38); pointer-events: auto; }
    #folderPanel {
      position: fixed; top: 12px; left: 12px; bottom: 16px; width: min(300px, 82vw); height: auto;
      z-index: 320; display: flex; flex-direction: column;
      transform: translateX(calc(-100% - 20px)); transition: transform 0.32s cubic-bezier(0.34,1.2,0.64,1);
      overflow: hidden; background: var(--ui-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    #folderPanel.open { transform: translateX(0); }
    #folderPanelHeader { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 12px; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.07); }
    #folderPanelHeader .fph-title { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0; }
    #folderPanelHeader .fph-btns  { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
    .fph-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.10); color: var(--text); font-size: 14px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), background 0.15s; }
    .fph-btn:hover  { background: rgba(255,255,255,0.18); }
    .fph-btn:active { transform: scale(0.88); }
    .fph-btn.accent { background: var(--accent); color: #fff; }
    .fph-btn.accent:hover { filter: brightness(1.15); }
    #folderFileList { flex: 1; overflow-y: auto; padding: 8px 12px 24px; scrollbar-width: none; }
    #folderFileList::-webkit-scrollbar { display: none; }
    .folder-empty { text-align: center; padding: 40px 16px; font-size: 13px; color: var(--dim); line-height: 1.9; }
    .folder-file-item {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 10px; border-radius: 12px; cursor: pointer;
      margin-bottom: 2px; transition: background 0.15s;
    }
    .folder-file-item:hover  { background: rgba(255,255,255,0.07); }
    .folder-file-item.active { background: rgba(var(--accent-rgb), 0.15); }
    .folder-file-item.active .ffi-name { color: var(--accent); }
    .ffi-ext {
      width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 8px; font-weight: 700; letter-spacing: 0.3px;
      background: rgba(255,255,255,0.08); color: var(--dim);
    }
    .ffi-ext.ext-txt  { background: rgba(100,180,255,0.15); color: #64b4ff; }
    .ffi-ext.ext-html { background: rgba(255,140,60,0.15);  color: #ff8c3c; }
    .ffi-ext.ext-json { background: rgba(100,220,120,0.15); color: #64dc78; }
    .ffi-ext.ext-md   { background: rgba(180,130,255,0.15); color: #b482ff; }
    .ffi-ext.ext-css  { background: rgba(60,180,255,0.15);  color: #3cb4ff; }
    .ffi-ext.ext-js   { background: rgba(255,210,50,0.15);  color: #ffd232; }
    .ffi-ext.ext-xml  { background: rgba(255,100,100,0.15); color: #ff6464; }
    .ffi-ext.ext-csv  { background: rgba(80,220,180,0.15);  color: #50dcb4; }
    .ffi-info { flex: 1; min-width: 0; }
    .ffi-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
    .ffi-size { font-size: 11px; color: var(--dim); margin-top: 1px; line-height: 1.3; }
    .ffi-save-btn {
      width: 22px; height: 22px; border-radius: 6px; border: none; flex-shrink: 0;
      background: rgba(var(--accent-rgb), 0.18); color: var(--accent);
      cursor: pointer; display: none; align-items: center; justify-content: center;
      transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1), background 0.15s;
    }
    .folder-file-item.active .ffi-save-btn { display: flex; }
    .ffi-save-btn:hover  { background: rgba(var(--accent-rgb), 0.32); }
    .ffi-save-btn:active { transform: scale(0.88); }
    .ffi-save-btn.unsaved { background: rgba(255,180,50,0.2); color: #ffb432; }
    #folderWriteStatus {
      padding: 8px 14px; font-size: 10px; color: var(--dim); text-align: center;
      border-top: 1px solid rgba(255,255,255,0.06); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      transition: color 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    #folderWriteStatus .ws-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--dim); flex-shrink: 0;
      transition: background 0.35s cubic-bezier(0.4,0,0.2,1),
                  box-shadow 0.35s cubic-bezier(0.4,0,0.2,1),
                  transform  0.35s cubic-bezier(0.34,1.56,0.64,1);
    }
    #folderWriteStatus.writable .ws-dot {
      background: #64dc78;
      box-shadow: 0 0 6px rgba(100,220,120,0.7);
      transform: scale(1.25);
    }
    #folderWriteStatus.writable { color: #64dc78; }
    @keyframes wsSlideIn {
      from { opacity: 0; transform: translateY(5px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    #folderWriteStatus .ws-text-anim {
      animation: wsSlideIn 0.28s cubic-bezier(0.34,1.3,0.64,1) forwards;
    }

    /* 読み取り専用 → 書き込み可能 アンロックアニメーション */
    @keyframes wsDotUnlock {
      0%   { transform: scale(1);    box-shadow: 0 0 0px  rgba(100,220,120,0);   }
      30%  { transform: scale(2.2);  box-shadow: 0 0 12px rgba(100,220,120,0.9); }
      55%  { transform: scale(0.9);  box-shadow: 0 0 6px  rgba(100,220,120,0.5); }
      75%  { transform: scale(1.4);  box-shadow: 0 0 8px  rgba(100,220,120,0.7); }
      100% { transform: scale(1.25); box-shadow: 0 0 6px  rgba(100,220,120,0.7); }
    }
    @keyframes wsBarFlash {
      0%   { background: transparent; }
      25%  { background: rgba(100,220,120,0.12); }
      60%  { background: rgba(100,220,120,0.06); }
      100% { background: transparent; }
    }
    @keyframes wsRipple {
      0%   { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(4); opacity: 0;   }
    }
    #folderWriteStatus.ws-unlocking .ws-dot {
      animation: wsDotUnlock 0.55s cubic-bezier(0.34,1.3,0.64,1) forwards;
    }
    #folderWriteStatus.ws-unlocking {
      animation: wsBarFlash 0.6s cubic-bezier(0.4,0,0.2,1) forwards;
    }
    .ws-ripple {
      position: absolute;
      top: 50%; left: 50%;
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(100,220,120,0.5); pointer-events: none;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      animation: wsRipple 0.55s cubic-bezier(0.4,0,0.2,1) forwards;
    }
    .fph-btn.fph-exit { background: rgba(229,57,53,0.15); color: #e57373; }
    .fph-btn.fph-exit:hover  { background: rgba(229,57,53,0.28); color: #ef9a9a; }
    #folderPanel.dragging, #folderOverlay.dragging { transition: none; }

    /* ファイル/フォルダ選択チューザー */
    #openChooserModal {
      width: min(280px, 88vw); padding: 28px 22px 20px; border-radius: 22px; z-index: 220;
      box-shadow: 0 16px 50px rgba(0,0,0,0.3);
    }
    #openChooserModal .oc-title {
      font-size: 14px; font-weight: 200; text-align: center; margin-bottom: 16px; color: var(--dim);
    }
    .oc-btns { display: flex; flex-direction: column; gap: 10px; }
    .oc-btn {
      display: flex; align-items: center; gap: 12px;
      padding: 13px 16px; border-radius: 14px; border: none; cursor: pointer;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
      color: var(--text); font-family: inherit; font-size: 14px; font-weight: 200;
      text-align: left;
      transition: background 0.15s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .oc-btn:hover  { background: rgba(255,255,255,0.11); }
    .oc-btn:active { transform: scale(0.97); }
    .oc-btn .oc-icon { font-size: 22px; flex-shrink: 0; }
    .oc-btn .oc-label { display: flex; flex-direction: column; gap: 2px; }
    .oc-btn .oc-label strong { font-size: 14px; font-weight: 600; }
    .oc-btn .oc-label span { font-size: 11px; color: var(--dim); }
    .oc-cancel {
      margin-top: 8px; width: 100%; padding: 9px 0; border-radius: 12px; border: none;
      background: transparent; color: var(--dim); font-family: inherit; font-size: 13px; cursor: pointer;
      transition: color 0.15s;
    }
    .oc-cancel:hover { color: var(--text); }

    /* ===== フローティング丸タブバー (PC専用・VSCodeスタイル) ===== */
    #pageTabBar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 56px;
      z-index: 200; display: none;
      background: transparent;
      overflow-x: auto; overflow-y: hidden; scrollbar-width: none;
      align-items: center;
      padding: 8px 56px 8px 12px; gap: 6px;
      transform: translateY(-100%);
      opacity: 0;
      /* 閉じるアニメは速度調整のみ */
      transition: transform 0.12s cubic-bezier(0.4,0,1,1),
                  opacity   0.10s cubic-bezier(0.4,0,1,1);
      will-change: transform, opacity;
    }
    #pageTabBar::-webkit-scrollbar { display: none; }
    #pageTabBar.active  { display: flex; }
    /* 開くアニメ：iOS風スプリング（.tab-slide-in 付与時のtransitionで適用） */
    #pageTabBar.tab-slide-in {
      transform: translateY(0);
      opacity: 1;
      transition: transform 0.54s cubic-bezier(0.34, 1.28, 0.64, 1),
                  opacity   0.38s cubic-bezier(0.34, 1.28, 0.64, 1) !important;
    }

    /* 浮遊タブ本体 */
    .page-tab {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 0 10px 0 14px;
      height: 34px;
      min-width: 90px; max-width: 180px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
      cursor: pointer; flex-shrink: 0;
      font-family: inherit; color: rgba(255,255,255,0.3); font-size: 12px;
      transition: background 0.22s cubic-bezier(0.34,1.2,0.64,1), border-color 0.22s cubic-bezier(0.34,1.2,0.64,1), color 0.22s cubic-bezier(0.34,1.2,0.64,1);
      position: relative; overflow: hidden;
      -webkit-user-select: none; user-select: none;
    }
    /* 下端アクセントライン */
    .page-tab::after {
      content: ''; position: absolute;
      bottom: 0; left: 14%; right: 14%; height: 2px;
      background: var(--accent); border-radius: 2px;
      opacity: 0; transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1);
    }
    /* 削除中：インジケーター非表示（再描画後にフェードイン） */
    #pageTabBar.hide-indicators .page-tab::after { opacity: 0 !important; transition: none !important; }
    /* 追加アニメ：上からスライドイン（速い→遅い） */
    .page-tab-wrap.tab-add-enter .page-tab {
      transform: translateY(-14px);
      transition: none;
    }
    .page-tab-wrap.tab-add-active .page-tab {
      transform: translateY(0);
      transition: transform 0.24s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .page-tab:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.55);
    }
    .page-tab.active {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.09);
      color: rgba(255,255,255,0.80);
    }
    .page-tab.active::after { opacity: 1; }
    .page-tab-name {
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      font-size: 12px; font-weight: 400; line-height: 1;
    }
    /* タブインライン編集 */
    .page-tab-name-input {
      flex: 1; background: transparent; border: none; outline: none;
      color: rgba(255,255,255,0.85); font-size: 12px; font-family: inherit;
      font-weight: 400; line-height: 1; min-width: 0;
      caret-color: var(--accent);
    }
    .page-tab-close {
      position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
      width: 14px; height: 14px; border-radius: 3px; border: none;
      background: transparent; color: inherit; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 9px; line-height: 1; padding: 0;
      opacity: 0; transition: opacity 0.12s, background 0.12s, color 0.12s;
    }
    .page-tab:hover .page-tab-close,
    .page-tab.active .page-tab-close { opacity: 0.45; }
    .page-tab-close:hover { opacity: 1 !important; background: rgba(229,57,53,0.28); color: #e57373; }
    /* 閉じるボタン分の右パディング確保 */
    .page-tab { padding-right: 22px; }

    /* ＋ボタン：円形 */
    #pageTabAddBtn {
      width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: rgba(255,255,255,0.3); font-size: 17px; line-height: 1;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-family: inherit;
      position: relative; z-index: 100;
      isolation: isolate;
      transition: background 0.15s, color 0.15s, border-color 0.15s,
                  transform 0.38s cubic-bezier(0.4,0,0.2,1);
    }
    #pageTabAddBtn:hover {
      background: rgba(255,255,255,0.09); color: rgba(255,255,255,0.75);
      border-color: rgba(255,255,255,0.20); transform: scale(1.1);
    }
    /* 名前編集ボタン（右端固定） */
    #pageTabEditBtn {
      position: fixed; right: 10px; top: 11px;
      width: 32px; height: 32px; border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.35); font-size: 13px;
      cursor: pointer; display: none; align-items: center; justify-content: center;
      z-index: 202;
      transition: background 0.15s, color 0.15s, border-color 0.15s, transform 0.15s cubic-bezier(0.34,1.56,0.64,1);
    }
    #pageTabEditBtn.active-mode { display: flex; }
    #pageTabEditBtn.editing {
      background: rgba(229,57,53,0.18) !important;
      border-color: rgba(229,57,53,0.3) !important;
      color: #e57373 !important;
    }
    #pageTabEditBtn:hover { background: rgba(255,255,255,0.09); color: rgba(255,255,255,0.75); transform: scale(1.08); }

    /* ===== タブラッパー（幅アニメ専用） ===== */
    .page-tab-wrap {
      display: flex; align-items: center; flex-shrink: 0;
      position: relative; z-index: 1;
      /* overflow は削除アニメ中のみ inline で付与 */
    }
    /* ===== タブ名編集ポップアップ ===== */
    #tabNamePopup {
      position: fixed; z-index: 300;
      background: rgba(30,30,30,0.96); backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.12); border-radius: 14px;
      padding: 10px 12px; display: none; flex-direction: column; gap: 6px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.4);
      min-width: 180px;
      transform-origin: top center;
      animation: tabPopupIn 0.32s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    #tabNamePopup.open { display: flex; }
    @keyframes tabPopupIn {
      from { opacity:0; transform: translateY(-10px) scale(0.88); filter: blur(3px); }
      to   { opacity:1; transform: translateY(0)     scale(1);    filter: blur(0px); }
    }
    #tabNamePopup label {
      font-size: 10px; color: rgba(255,255,255,0.4); letter-spacing: 0.04em;
    }
    #tabNamePopupInput {
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px; color: rgba(255,255,255,0.9); font-family: inherit;
      font-size: 13px; padding: 7px 10px; outline: none; width: 100%; box-sizing: border-box;
      transition: border-color 0.15s;
    }
    #tabNamePopupInput:focus { border-color: var(--accent); }
    #tabNamePopupHint {
      font-size: 10px; color: rgba(255,255,255,0.28); text-align: right;
    }

    /* タブバーモード時のヘッダー・テキストエリア位置調整 */
    body.tab-bar-mode { --header-top: 68px; }
    /* header[data-dragged] の top はJSのclampで制御するためCSS固定は削除 */
    body.tab-bar-mode textarea,
    body.tab-bar-mode #searchHighlightMirror { padding-top: 120px !important; }
    @media (max-width: 480px) {
      body.tab-bar-mode textarea,
      body.tab-bar-mode #searchHighlightMirror { padding-top: 112px !important; }
    }

    /* ===== 言語切り替えオーバーレイ ===== */
    #langTransitionOverlay {
      position: fixed; inset: 0; z-index: 99999;
      display: flex; align-items: center; justify-content: center;
      background: var(--bg);
      opacity: 0; pointer-events: none;
      transition: opacity 0.32s cubic-bezier(0.4,0,0.2,1);
    }
    #langTransitionOverlay.fade-in  { opacity: 1; pointer-events: auto; }
    #langTransitionOverlay.fade-out { opacity: 0; pointer-events: none; }
    #langTransitionLabel {
      font-size: 15px; font-weight: 200; color: var(--dim);
      letter-spacing: 0.5px;
      animation: langLabelPulse 0.9s ease-in-out infinite alternate;
    }
    @keyframes langLabelPulse {
      from { opacity: 0.4; }
      to   { opacity: 1; }
    }
  </style>
</head>
<body>

  <div id="lockScreen" class="hidden">
    <div id="lockCard" class="glass">
      <div class="lock-left">
        <img src="apple-touch-icon.png" alt="Notepad26" class="lock-icon" onerror="this.style.display='none'">
        <div class="lock-app-name">Notepad26</div>
      </div>
      <div class="lock-right">
        <div class="lock-label" data-i18n="lock.label">パスワードを入力してください</div>
        <input id="lockPwInput" type="password" class="lock-pw-input"
               placeholder="パスワード" maxlength="64" autocomplete="current-password"
               data-i18n="lock.placeholder" data-i18n-attr="placeholder">
        <button class="lock-submit-btn" id="lockSubmitBtn" data-i18n="lock.submit">ロック解除</button>
        <button class="lock-bio-btn" id="lockBioBtn" style="display:none" data-i18n="lock.bio">🔑 パスキーでロック解除</button>
        <div class="lock-error-msg" id="lockErrorMsg"></div>
      </div>
    </div>
  </div>

  <div id="pwUnlockModal" class="glass panel-modal">
    <button class="close-dot" onclick="closePwUnlockModal()" aria-label="閉じる"></button>
    <div class="pwunlock-title" data-i18n="pwu.title">パスワードロック解除</div>
    <div class="pwunlock-desc"  data-i18n="pwu.desc">ロックを解除すると、このサイトに保存しているデータが無条件で他人に見られる可能性があります。</div>
    <div class="pwunlock-btns">
      <button class="btn-cancel" onclick="closePwUnlockModal()" data-i18n="common.cancel">キャンセル</button>
      <button class="btn-danger" onclick="confirmPwUnlock()"    data-i18n="pwu.confirm">解除する</button>
    </div>
  </div>

  <div id="pwSetModal" class="glass panel-modal">
    <button class="close-dot" onclick="closePwSetModal()" aria-label="閉じる"></button>
    <div class="pwset-title" data-i18n="pws.title">パスワードロック設定</div>
    <div class="pwset-field">
      <label data-i18n="pws.pw">パスワード</label>
      <input type="password" id="pwSetNew" class="pwset-input"
             placeholder="パスワードを入力..." maxlength="64" autocomplete="new-password"
             data-i18n="pws.pw.placeholder" data-i18n-attr="placeholder">
      <div id="pwStrength"></div>
    </div>
    <div class="pwset-field">
      <label data-i18n="pws.confirm">確認入力</label>
      <input type="password" id="pwSetConfirm" class="pwset-input"
             placeholder="もう一度入力..." maxlength="64" autocomplete="new-password"
             data-i18n="pws.confirm.placeholder" data-i18n-attr="placeholder">
    </div>
    <div id="pwSetProgress"></div>
    <div id="pwSetError"></div>
    <div class="pwset-btns">
      <button id="pwSetCancelBtn" onclick="closePwSetModal()" data-i18n="common.cancel">キャンセル</button>
      <button id="pwSetSaveBtn"   onclick="savePassword()" disabled data-i18n="pws.save">設定する</button>
    </div>
  </div>

  <div id="appContent">
  <header class="glass">
    <div id="headerTopBar">
      <button id="headerYellowBtn" title="メニューバーをリセット" aria-label="位置をリセット"></button>
    </div>
    <button onclick="act('new')"              data-i18n="hdr.new">新規</button>
    <button onclick="act('open')"             data-i18n="hdr.open">開く</button>
    <button onclick="act('save')"             data-i18n="hdr.save">保存</button>
    <button id="headerShareBtn" onclick="act('share')"          data-i18n="hdr.share">共有</button>
    <button id="headerPageBtn"  onclick="act('togglePagePanel')" data-i18n="hdr.pages">ページ</button>
    <button onclick="act('toggle')"           data-i18n="hdr.settings">設定</button>
  </header>
  <div id="searchPanel" class="glass">
    <div id="searchPanelDragHandle" class="drag-handle" style="position:absolute;top:0;left:0;right:0;height:36px;border-radius:18px 18px 0 0;"></div>
    <button class="close-dot" id="searchPanelCloseBtn" aria-label="閉じる"></button>
    <span id="searchCount" class="s-count"></span>
    <div class="sp-row">
      <input id="searchInput" type="text" placeholder="検索..." autocomplete="off" data-i18n="sp.placeholder" data-i18n-attr="placeholder">
    </div>
    <div class="sp-row" style="justify-content:center; gap:6px;">
      <button class="sp-btn" id="spPrevBtn" title="前へ" data-i18n="sp.prev">↑ 前へ</button>
      <button class="sp-btn" id="spNextBtn" title="次へ" data-i18n="sp.next">↓ 次へ</button>
    </div>
  </div>

  <div id="options" class="glass">
    <div id="optionsDragHandle" class="drag-handle" style="position:absolute;top:0;left:0;right:0;height:36px;border-radius:18px 18px 0 0;"></div>
    <button class="close-dot" onclick="act('toggle')" aria-label="閉じる"></button>
    <button class="info-dot" onclick="showDevMessage()" aria-label="開発者メッセージ">i</button>
    <div><span class="label" data-i18n="opt.font">フォント</span><select id="fSel"></select></div>
    <div><span class="label" data-i18n="opt.size">サイズ</span><select id="sSel"></select></div>
    <div><span class="label" data-i18n="opt.search">検索</span>
      <select id="dictSel">
        <option value="wikipedia">Wikipedia_JP</option>
        <option value="wiktionary">Wiktionary_JP</option>
      </select>
    </div>
    <div><span class="label" data-i18n="opt.translate">翻訳</span>
      <select id="translateSel">
        <option value="google">Google 翻訳</option>
        <option value="bing">Bing 翻訳</option>
      </select>
    </div>
    <div><span class="label" data-i18n="opt.theme">テーマ</span><div class="color-swatches" id="colorSwatches"></div></div>
    <div>
      <span class="label" data-i18n="opt.autosave">自動保存</span>
      <label class="ios-toggle"><input type="checkbox" id="autoSaveToggle"><span class="ios-toggle-slider"></span></label>
      <button id="clearAutoSaveBtn" title="保存済みデータを消去">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#e53935;display:block;">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/><path d="M14 11v6"/>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
        </svg>
      </button>
    </div>
    <div>
      <span class="label" data-i18n="opt.save">保存</span>
      <label class="ios-toggle"><input type="checkbox" id="saveMetaToggle"><span class="ios-toggle-slider"></span></label>
      <span style="font-size:10px; color:var(--dim); margin-left:4px; white-space:nowrap;" data-i18n="opt.savespan">文章情報を含める</span>
    </div>
    <div id="pageToggleRow" style="display:none">
      <span class="label" data-i18n="opt.page">ページ</span>
      <label class="ios-toggle"><input type="checkbox" id="pageBarToggle"><span class="ios-toggle-slider"></span></label>
    </div>
    <div id="pageNavModeRow" style="display:none">
      <span class="label" data-i18n="opt.pageview">ページ表示</span>
      <div style="display:flex;gap:4px;flex:1;">
        <button id="pageNavSlideBtn" class="page-nav-mode-btn active" title="スライドパネル方式" data-i18n="opt.sidebar">サイドバー</button>
        <button id="pageNavTabBtn"   class="page-nav-mode-btn"        title="タブバー方式"      data-i18n="opt.tab">タブ</button>
      </div>
    </div>
    <div>
      <span class="label" data-i18n="opt.movebar">バーの移動</span>
      <label class="ios-toggle"><input type="checkbox" id="headerMoveToggle"><span class="ios-toggle-slider"></span></label>
    </div>
    <div>
      <span class="label" data-i18n="opt.footer">下部バー</span>
      <label class="ios-toggle"><input type="checkbox" id="footerAlwaysToggle"><span class="ios-toggle-slider"></span></label>
      <span style="font-size:10px; color:var(--dim); margin-left:4px; white-space:nowrap;" data-i18n="opt.footerspan">常時表示</span>
    </div>
    <div id="pwLockRow">
      <span class="label" data-i18n="opt.pwlock">パスワードロック</span>
      <label class="ios-toggle"><input type="checkbox" id="pwLockToggle"><span class="ios-toggle-slider"></span></label>
    </div>
    <div id="bioRegisterRow" style="display:none">
      <span class="label" data-i18n="opt.passkey">パスキー</span>
      <label class="ios-toggle"><input type="checkbox" id="bioToggle"><span class="ios-toggle-slider"></span></label>
    </div>
    <div>
      <span class="label" data-i18n="opt.lang">言語</span>
      <div style="display:flex;gap:4px;flex:1;">
        <button id="langJaBtn" class="page-nav-mode-btn active" onclick="window.i18n.setLang('ja')">日本語</button>
        <button id="langEnBtn" class="page-nav-mode-btn"        onclick="window.i18n.setLang('en')">English</button>
      </div>
    </div>
    <div class="options-version">
      <span>Build 2602281941</span>
      <span>Version 26.2.5.1</span>
      <span><strong>↓Creator↓</strong><br>Claude Sonnet4.6<br>Claude Sonnet4.5<br>Trae_kimi-K2-0905<br>Vscode_Copilot<br>Chat GPT<br>Gemini<br>Cursor<br>Tikuwa</span>
    </div>
  </div>

  <div id="bioPromptModal" class="glass panel-modal">
    <div class="bio-prompt-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="15" r="4"/><path d="M12 15h8M17 15v-2"/></svg></div>
    <div class="bio-prompt-title" data-i18n="bio.title">パスキーを登録しますか？</div>
    <div class="bio-prompt-desc"  data-i18n="bio.desc">パスキーを登録することによりパスワードを打たずにシームレスなログインが可能になります。</div>
    <div class="bio-prompt-btns">
      <button class="btn-bio"      id="bioPromptRegisterBtn" data-i18n="bio.register">パスキーを登録する</button>
      <button class="btn-bio-skip" id="bioPromptSkipBtn"     data-i18n="bio.skip">あとで設定する</button>
    </div>
  </div>

  <div id="confirmModal" class="glass modal panel-modal" role="dialog" aria-modal="true">
    <p id="modalMsg" data-i18n="confirm.new">内容をすべて消去しますか？</p>
    <input type="text" id="fileNameInput" placeholder="ファイル名を入力..."
           data-i18n="confirm.filename" data-i18n-attr="placeholder" style="display:none">
    <div class="modal-btns">
      <button class="btn-sub" onclick="closeConfirm(false)" data-i18n="common.cancel">キャンセル</button>
      <button id="modalConfirmBtn" class="btn-main" onclick="closeConfirm(true)" data-i18n="common.ok">確定</button>
    </div>
  </div>

  <div id="saveMetaModal" class="glass modal panel-modal save-meta-modal">
    <button class="close-dot" id="saveMetaCloseBtn" style="left:13px;" aria-label="閉じる"></button>
    <p data-i18n="savemeta.title">ファイルを保存</p>
    <div class="save-meta-desc" data-i18n="savemeta.desc">フォント・サイズ情報をファイルに含めますか？<br><span>含めると次回読み込み時に設定が復元されます</span></div>
    <div class="save-meta-remember">
      <label class="ios-toggle ios-toggle-sm"><input type="checkbox" id="saveMetaRememberToggle"><span class="ios-toggle-slider"></span></label>
      <span data-i18n="savemeta.remember">この選択を記憶する</span>
    </div>
    <div class="modal-btns">
      <button id="saveMetaNoBtn"  class="btn-sub"  data-i18n="savemeta.no">情報なしで保存</button>
      <button id="saveMetaYesBtn" class="btn-main" data-i18n="savemeta.yes">情報ありで保存</button>
    </div>
  </div>

  <div id="translatePanel" class="glass">
    <div class="tp-header drag-handle" id="translateDragHandle">
      <button class="tp-dot" onclick="closePanel('translatePanel')" aria-label="閉じる"></button>
      <div class="tp-lang">
        <select id="tpSrcLang">
          <option value="auto" data-i18n="tp.lang.auto">自動検出</option>
          <option value="ja"    data-i18n="tp.lang.ja">日本語</option><option value="en" data-i18n="tp.lang.en">英語</option>
          <option value="zh-CN" data-i18n="tp.lang.zh">中国語</option><option value="ko" data-i18n="tp.lang.ko">韓国語</option>
          <option value="fr"    data-i18n="tp.lang.fr">フランス語</option><option value="de" data-i18n="tp.lang.de">ドイツ語</option>
          <option value="es"    data-i18n="tp.lang.es">スペイン語</option>
        </select>
        <span class="tp-arrow">→</span>
        <select id="tpTgtLang">
          <option value="ja"    data-i18n="tp.lang.ja">日本語</option><option value="en" data-i18n="tp.lang.en">英語</option>
          <option value="zh-CN" data-i18n="tp.lang.zh">中国語</option><option value="ko" data-i18n="tp.lang.ko">韓国語</option>
          <option value="fr"    data-i18n="tp.lang.fr">フランス語</option><option value="de" data-i18n="tp.lang.de">ドイツ語</option>
          <option value="es"    data-i18n="tp.lang.es">スペイン語</option>
        </select>
      </div>
    </div>
    <div class="tp-body">
      <div class="tp-src" id="tpSrc"></div>
      <div class="tp-result" id="tpResult"></div>
    </div>
    <div class="tp-powered" id="tpPowered">Powered by Google translation</div>
  </div>

  <div id="searchWebPanel" class="glass">
    <div class="swp-header drag-handle" id="searchWebDragHandle">
      <button class="swp-dot" onclick="closePanel('searchWebPanel')" aria-label="閉じる"></button>
      <button class="swp-wiki-btn" id="swpWikiBtn" data-i18n="swp.open">開く</button>
    </div>
    <div class="swp-body" id="swpBody"></div>
  </div>

  <div id="devMessageModal" class="glass panel-modal">
    <div class="dev-title-main">Information</div>
    <div class="dev-body">アプリを使っている人へ
このアプリのベースのバージョンはBuild2602281858です
26.2.5への互換性や後方互換性などの確認は行っていますがもし不具合があれば再度保存し直してもらえると幸いです
またそれより以前のバージョンをお使いの方は"--- DON'T EDIT BELOW ---"などのテキストが表示される場合がありますが、旧バージョンの仕様であり、気になる場合は該当テキストを削除してから保存し直すと消えるかと思います
これからもこのアプリをよろしくお願いします]

追記:今のところユーザー数0(2026/2/28)
もしかしたら使ってる人がいるかもの精神で開発中

 - Tikuwa - </div>
    <button class="dev-close" onclick="hideDevMessage()" data-i18n="common.close">閉じる</button>
  </div>

  <div id="backdrop" onclick="act('closeOverlays')"></div>
  <div id="contextMenu" class="glass">
    <button id="ctxCopy"    onclick="ctxCopyText()"              data-i18n="ctx.copy">コピー</button>
    <button id="ctxCut"     onclick="ctxCutText()"               data-i18n="ctx.cut">切り取り</button>
    <button id="ctxPaste"   onclick="ctxPasteText()"             data-i18n="ctx.paste">貼り付け</button>
    <div id="ctxDivider" class="ctx-divider"></div>
    <button id="ctxSearch"  onclick="searchWiki()"               data-i18n="ctx.search">検索</button>
    <button id="ctxTrans"   onclick="translateText()"            data-i18n="ctx.translate">翻訳</button>
    <button id="ctxShare"   onclick="ctxShareText()"             data-i18n="ctx.share">共有</button>
    <button id="ctxCompare" onclick="openCompareFromContextMenu()" data-i18n="ctx.compare">比較</button>
    <button id="ctxFind"    onclick="ctxOpenSearch()"            data-i18n="ctx.find">文字検索</button>
  </div>
  <div id="searchHighlightMirror"></div>
  <textarea id="edit" spellcheck="false"></textarea>
  <footer id="ft" class="glass">
    <span id="b-info"></span>
    <span id="f-info-label-wrap" class="ft-slot"><span id="f-info-label" class="ft-slot-inner"></span></span><span id="f-info-wrap" class="ft-slot"><span id="f-info-num" class="ft-slot-inner"></span></span><span id="f-info-unit" data-i18n="footer.unit"></span>
  </footer>
  </div>

  <!-- 赤ペン機能 -->
  <canvas id="penCanvas"></canvas>
  <button id="penToggleBtn" title="赤ペン" aria-label="赤ペンモード切替">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
      <path d="m15 5 4 4"/>
    </svg>
  </button>
  <div id="penToolbar">
    <!-- 太さ（item 1・一番下から最初に出る） -->
    <div id="penSizeWrap" class="pen-toolbar-item">
      <div class="pen-size-dot" data-size="3"  style="width:6px;height:6px;"  title="細い"></div>
      <div class="pen-size-dot" data-size="6"  style="width:10px;height:10px;" title="中"></div>
      <div class="pen-size-dot" data-size="12" style="width:16px;height:16px;" title="太い"></div>
    </div>
    <!-- Undo（item 2） -->
    <button class="pen-tool-btn pen-toolbar-item" id="penUndoBtn" title="一つ戻す">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 0 11H11"/></svg>
    </button>
    <!-- 消しゴム（item 3） -->
    <button class="pen-tool-btn pen-toolbar-item" id="penEraserBtn" title="消しゴム">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20H7L3 16l10-10 7 7-2.5 2.5"/><path d="M6.0 11.0 2.5 14.5"/></svg>
    </button>
    <!-- Clear（item 4） -->
    <button class="pen-tool-btn pen-toolbar-item" id="penClearBtn" title="全消去">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
    </button>
  </div>
  <!-- 消しゴムカーソル -->
  <div id="eraserCursor"></div>
  <input type="file" id="fileInput"        hidden accept=".txt,.html,.htm,.json,.md,.css,.js,.xml,.csv">
  <input type="file" id="compareFileInput" hidden accept=".txt">
  <div id="diffOverlay" style="display:none;position:fixed;inset:0;z-index:300;overflow:hidden;background:var(--bg);">
    <div id="diffHeader" class="glass diff-enter">
      <span class="diff-label"  data-i18n="diff.title">比較結果</span>
      <span class="diff-divider"></span>
      <span id="diffLegendAdd" class="diff-legend"><span class="diff-legend-dot add"></span><span data-i18n="diff.add">追加</span></span>
      <span id="diffLegendDel" class="diff-legend"><span class="diff-legend-dot del"></span><span data-i18n="diff.del">削除</span></span>
      <span class="diff-divider"></span>
      <button class="diff-close-btn" onclick="closeDiffOverlay()" data-i18n="diff.close">✕ 閉じる</button>
    </div>
    <div id="diffContent"></div>
  </div>
  <div id="toastContainer"></div>
  <div id="pageSwipeTrigger"></div>
  <!-- ページタブバー (PC専用・タブバーモード時に表示) -->
  <div id="pageTabBar"></div>
  <button id="pageTabEditBtn" title="ページ名を編集" style="transform:scaleX(-1);">✎</button>
  <!-- タブ名編集ポップアップ -->
  <div id="tabNamePopup">
    <label data-i18n="tab.label">ページ名</label>
    <input id="tabNamePopupInput" type="text" maxlength="20" placeholder="ページ名を入力..." autocomplete="off"
           data-i18n="tab.placeholder" data-i18n-attr="placeholder">
    <span id="tabNamePopupHint" data-i18n="tab.hint">Enter で確定 · Esc でキャンセル</span>
  </div>
  <div id="pagePullTab" aria-label="ページを開く"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
  <div id="folderSwipeTrigger"></div>
  <div id="folderPullTab" aria-label="サイドバーを開く"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></div>
  <div id="openChooserModal" class="glass panel-modal">
    <div class="oc-title" data-i18n="oc.title">開く方法を選択</div>
    <div class="oc-btns">
      <button class="oc-btn" id="ocFileBtn">
        <span class="oc-label">
          <strong data-i18n="oc.file.title">ファイルを開く</strong>
          <span data-i18n="oc.file.desc">.txt .html .json など</span>
        </span>
      </button>
      <button class="oc-btn" id="ocFolderBtn">
        <span class="oc-label">
          <strong data-i18n="oc.folder.title">フォルダを開く</strong>
          <span data-i18n="oc.folder.desc">サイドバーにファイル一覧を表示</span>
        </span>
      </button>
    </div>
    <button class="oc-cancel" id="ocCancelBtn" data-i18n="oc.cancel">キャンセル</button>
  </div>

  <div id="folderOverlay" onclick="closeFolderPanel()"></div>
  <div id="folderPanel">
    <div id="folderPanelHeader">
      <span class="fph-title" id="folderPanelTitle" data-i18n="folder.title">フォルダ</span>
      <div class="fph-btns">
        <button class="fph-btn" id="folderRefreshBtn" title="再読み込み">↺</button>
        <button class="fph-btn accent" id="folderOpenBtn" title="フォルダを変更">＋</button>
        <button class="fph-btn fph-exit" id="folderExitBtn" title="メモ帳に戻る">✕</button>
      </div>
    </div>
    <div id="folderFileList">
      <div class="folder-empty" data-i18n="folder.empty">フォルダを開くと<br>ファイルが表示されます</div>
    </div>
    <div id="folderWriteStatus">
      <span class="ws-dot"></span>
      <span id="folderWriteStatusText" data-i18n="folder.readonly">読み取り専用</span>
    </div>
  </div>

  <div id="pageOverlay" onclick="closePagePanel()"></div>
  <div id="pagePanel">
    <div id="pagePanelHeader">
      <span class="pph-title" data-i18n="pp.title">ページ</span>
      <div class="pph-btns">
        <button class="pph-edit" onclick="openTitleEdit()" style="transform:scaleX(-1);">✎</button>
        <button class="pph-add" onclick="addPage()">＋</button>
      </div>
    </div>
    <div id="pageList"><div id="pageNumIndicator"></div></div>
    <div id="pageMaxMsg"></div>
  </div>

  <script>
  /* ===== i18n (国際化) ===== */
  (function() {
    var LANG_KEY = 'np26_lang';
    var _lang = localStorage.getItem(LANG_KEY) || 'ja';

    var dict = {
      ja: {
        'hdr.new':'新規','hdr.open':'開く','hdr.save':'保存',
        'hdr.share':'共有','hdr.pages':'ページ','hdr.settings':'設定',
        'opt.font':'フォント','opt.size':'サイズ','opt.search':'検索',
        'opt.translate':'翻訳','opt.theme':'テーマ','opt.autosave':'自動保存',
        'opt.save':'保存','opt.page':'ページ','opt.pageview':'ページ表示',
        'opt.movebar':'バーの移動','opt.footer':'下部バー','opt.footerspan':'常時表示',
        'opt.savespan':'文章情報を含める','opt.pwlock':'パスワードロック',
        'opt.passkey':'パスキー','opt.lang':'言語',
        'opt.sidebar':'サイドバー','opt.tab':'タブ',
        'ctx.copy':'コピー','ctx.cut':'切り取り','ctx.paste':'貼り付け',
        'ctx.search':'検索','ctx.translate':'翻訳','ctx.share':'共有',
        'ctx.compare':'比較','ctx.find':'文字検索',
        'sp.placeholder':'検索...','sp.prev':'↑ 前へ','sp.next':'↓ 次へ',
        'tab.label':'ページ名','tab.placeholder':'ページ名を入力...',
        'tab.hint':'Enter で確定 · Esc でキャンセル',
        'pp.title':'ページ',
        'oc.title':'開く方法を選択',
        'oc.file.title':'ファイルを開く','oc.file.desc':'.txt .html .json など',
        'oc.folder.title':'フォルダを開く','oc.folder.desc':'サイドバーにファイル一覧を表示',
        'oc.cancel':'キャンセル',
        'lock.label':'パスワードを入力してください',
        'lock.placeholder':'パスワード','lock.submit':'ロック解除',
        'lock.empty':'暗証番号を入力してください',
        'lock.invalid':'パスワードが正しくありません',
        'lock.checking':'確認中...',
        'lock.bio.checking':'認証中...',
        'lock.bio':'🔑 パスキーでロック解除',
        'pwu.title':'パスワードロック解除',
        'pwu.desc':'ロックを解除すると、このサイトに保存しているデータが無条件で他人に見られる可能性があります。',
        'pwu.confirm':'解除する',
        'pws.title':'パスワードロック設定','pws.pw':'パスワード',
        'pws.pw.placeholder':'パスワードを入力...','pws.confirm':'確認入力',
        'pws.confirm.placeholder':'もう一度入力...','pws.save':'設定する',
        'bio.title':'パスキーを登録しますか？',
        'bio.desc':'パスキーを登録することによりパスワードを打たずにシームレスなログインが可能になります。',
        'bio.register':'パスキーを登録する','bio.skip':'あとで設定する',
        'confirm.new':'内容をすべて消去しますか？','confirm.filename':'ファイル名を入力...',
        'common.cancel':'キャンセル','common.ok':'確定','common.close':'閉じる',
        'savemeta.title':'ファイルを保存',
        'savemeta.desc':'フォント・サイズ情報をファイルに含めますか？',
        'savemeta.remember':'この選択を記憶する',
        'savemeta.no':'情報なしで保存','savemeta.yes':'情報ありで保存',
        'folder.empty':'フォルダを開くと\nファイルが表示されます',
        'folder.readonly':'読み取り専用',
        'folder.writable':'書き込み可能',
        'folder.no_files':'対応ファイルが見つかりません',
        'folder.save_overwrite':'ファイルに上書き保存',
        'diff.title':'比較結果','diff.add':'追加','diff.del':'削除','diff.close':'✕ 閉じる',
        'swp.open':'開く',
        'swp.loading':'検索中...',
        'swp.notfound_pre':'「','swp.notfound_mid':'」は','swp.notfound_suf':'に見つかりませんでした。',
        'swp.failed':'取得に失敗しました。',
        'swp.wiki_read':'Wikipedia で読む →',
        'swp.wikt_read':'Wiktionary で読む →',
        'swp.related':'関連語句',
        'swp.results':'検索結果',
        'tp.loading':'翻訳中…',
        'tp.no_result':'翻訳結果が取得できませんでした',
        'tp.failed':'翻訳に失敗しました。',
        'tp.lang.auto':'自動検出',
        'tp.lang.ja':'日本語','tp.lang.en':'英語',
        'tp.lang.zh':'中国語','tp.lang.ko':'韓国語',
        'tp.lang.fr':'フランス語','tp.lang.de':'ドイツ語','tp.lang.es':'スペイン語',
        'bio.registering':'登録中...',
        'toast.passkey_registered':'パスキーを登録しました',
        'toast.register_failed':'登録失敗: ',
        'toast.register_failed_unknown':'不明なエラー',
        'toast.register_failed_cancel':'キャンセルされました',
        'toast.pwlock_set':'パスワードロックを設定しました',
        'toast.pwlock_removed':'パスワードロックを解除しました',
        'toast.saved_prefix':'保存しました：',
        'toast.save_failed':'保存に失敗しました。',
        'toast.open_file_failed':'ファイルを開けませんでした',
        'toast.folder_not_supported':'フォルダ選択は対応していません（Chrome/Edge推奨）',
        'toast.share_not_supported':'この環境では共有できません',
        'toast.share_failed':'共有に失敗しました',
        'toast.copied':'コピーしました',
        'toast.share_copied':'共有不可のためコピーしました',
        'toast.cut_done':'切り取りました',
        'toast.autosave_prefix':'自動保存済み ',
        'toast.page_blocked_fileeditor':'ファイルエディタ起動中はページを使用できません',
        'toast.page_add_blocked_fileeditor':'ファイルエディタ中はページを追加できません',
        'toast.page_max_prefix':'ページは最大',
        'toast.page_max_suffix':'枚までです',
        'toast.page_last_delete_blocked':'最後のページは削除できません',
        'toast.fileeditor_enter_prefix':'ファイルエディタに移行しました ― ',
        'toast.file_loaded_suffix':' を読み込みました',
        'toast.load_failed_prefix':'読み込みに失敗しました: ',
        'toast.file_saved_suffix':' に保存しました',
        'toast.save_failed_detail_prefix':'保存に失敗しました: ',
        'toast.folder_picker_unsupported':'フォルダ選択に未対応ブラウザ',
        'toast.folder_open_failed':'フォルダを開けませんでした',
        'toast.folder_refreshed':'フォルダを再読み込みしました',
        'toast.folder_refresh_failed':'再読み込みに失敗しました',
        'toast.memo_returned':'メモ帳に戻りました',
        'toast.autosave_restored':'自動保存データを復元しました',
        'toast.autosave_cleared':'自動保存データを消去しました',
        'toast.passkey_require_password':'先にパスワードを登録してください',
        'toast.passkey_unlinked':'パスキー認証の連携を解除しました',
        'toast.font_size_prefix':'フォントサイズ: ',
        'toast.offline_error':'エラー: インターネット接続が遮断されました',
        'pws.strength_prefix':'強度: ',
        'pws.strength_weak':'弱い（6文字以上推奨）',
        'pws.strength_medium':'普通',
        'pws.strength_strong':'強い',
        'pws.error_mismatch':'パスワードが一致しません',
        'pws.error_tooshort':'4文字以上入力してください',
        'pws.progress_deriving':'鍵を導出中... (しばらくお待ちください)',
        'pws.progress_encrypting':'データを暗号化中...',
        'pws.error_failed':'設定に失敗しました: ',
        'pagemax.msg':'最大MAXページに達しました',
        'page.default':'ページ ',
        'page.placeholder':'ページ名...',
        'footer.unit':' 文字',
        'pp.empty':'空のページ',
        'folder.title':'フォルダ'
      },
      en: {
        'hdr.new':'New','hdr.open':'Open','hdr.save':'Save',
        'hdr.share':'Share','hdr.pages':'Pages','hdr.settings':'Settings',
        'opt.font':'Font','opt.size':'Size','opt.search':'Search',
        'opt.translate':'Translate','opt.theme':'Theme','opt.autosave':'Auto Save',
        'opt.save':'Save','opt.page':'Pages','opt.pageview':'Page View',
        'opt.movebar':'Move Bar','opt.footer':'Footer','opt.footerspan':'Always On',
        'opt.savespan':'Incl. metadata','opt.pwlock':'PW Lock',
        'opt.passkey':'Passkey','opt.lang':'Language',
        'opt.sidebar':'Sidebar','opt.tab':'Tab',
        'ctx.copy':'Copy','ctx.cut':'Cut','ctx.paste':'Paste',
        'ctx.search':'Search','ctx.translate':'Translate','ctx.share':'Share',
        'ctx.compare':'Compare','ctx.find':'Find',
        'sp.placeholder':'Search...','sp.prev':'↑ Prev','sp.next':'↓ Next',
        'tab.label':'Page Name','tab.placeholder':'Enter page name...',
        'tab.hint':'Enter to confirm · Esc to cancel',
        'pp.title':'Pages',
        'oc.title':'Choose how to open',
        'oc.file.title':'Open File','oc.file.desc':'.txt .html .json etc.',
        'oc.folder.title':'Open Folder','oc.folder.desc':'Show file list in sidebar',
        'oc.cancel':'Cancel',
        'lock.label':'Enter your password',
        'lock.placeholder':'Password','lock.submit':'Unlock',
        'lock.empty':'Please enter your passcode',
        'lock.invalid':'Incorrect password',
        'lock.checking':'Checking...',
        'lock.bio.checking':'Authenticating...',
        'lock.bio':'🔑 Unlock with Passkey',
        'pwu.title':'Remove Password Lock',
        'pwu.desc':'Removing the lock means anyone with access to this site could view your saved data.',
        'pwu.confirm':'Remove Lock',
        'pws.title':'Set Password Lock','pws.pw':'Password',
        'pws.pw.placeholder':'Enter password...','pws.confirm':'Confirm',
        'pws.confirm.placeholder':'Enter again...','pws.save':'Set Password',
        'bio.title':'Register Passkey?',
        'bio.desc':'Register a passkey to log in seamlessly without typing your password.',
        'bio.register':'Register Passkey','bio.skip':'Set up later',
        'confirm.new':'Clear all content?','confirm.filename':'Enter file name...',
        'common.cancel':'Cancel','common.ok':'OK','common.close':'Close',
        'savemeta.title':'Save File',
        'savemeta.desc':'Include font & size info in the file?',
        'savemeta.remember':'Remember this choice',
        'savemeta.no':'Save without info','savemeta.yes':'Save with info',
        'folder.empty':'Open a folder to\nshow files here',
        'folder.readonly':'Read only',
        'folder.writable':'Writable',
        'folder.no_files':'No supported files found',
        'folder.save_overwrite':'Overwrite file',
        'diff.title':'Diff Result','diff.add':'Added','diff.del':'Removed','diff.close':'✕ Close',
        'swp.open':'Open',
        'swp.loading':'Searching...',
        'swp.notfound_pre':'"','swp.notfound_mid':'" was not found on ','swp.notfound_suf':'.',
        'swp.failed':'Failed to retrieve.',
        'swp.wiki_read':'Read on Wikipedia →',
        'swp.wikt_read':'Read on Wiktionary →',
        'swp.related':'Related',
        'swp.results':'Search results',
        'tp.loading':'Translating…',
        'tp.no_result':'No translation result',
        'tp.failed':'Translation failed.',
        'tp.lang.auto':'Auto Detect',
        'tp.lang.ja':'Japanese','tp.lang.en':'English',
        'tp.lang.zh':'Chinese','tp.lang.ko':'Korean',
        'tp.lang.fr':'French','tp.lang.de':'German','tp.lang.es':'Spanish',
        'bio.registering':'Registering...',
        'toast.passkey_registered':'Passkey registered',
        'toast.register_failed':'Registration failed: ',
        'toast.register_failed_unknown':'Unknown error',
        'toast.register_failed_cancel':'Cancelled',
        'toast.pwlock_set':'Password lock enabled',
        'toast.pwlock_removed':'Password lock disabled',
        'toast.saved_prefix':'Saved: ',
        'toast.save_failed':'Save failed.',
        'toast.open_file_failed':'Failed to open file',
        'toast.folder_not_supported':'Folder picker not supported (Chrome/Edge recommended)',
        'toast.share_not_supported':'Sharing is not supported in this environment',
        'toast.share_failed':'Share failed',
        'toast.copied':'Copied',
        'toast.share_copied':'Sharing not available, copied instead',
        'toast.cut_done':'Cut',
        'toast.autosave_prefix':'Autosaved ',
        'toast.page_blocked_fileeditor':'Pages are unavailable while the file editor is open',
        'toast.page_add_blocked_fileeditor':'Cannot add pages while the file editor is open',
        'toast.page_max_prefix':'Maximum pages: ',
        'toast.page_max_suffix':'',
        'toast.page_last_delete_blocked':'The last page cannot be deleted',
        'toast.fileeditor_enter_prefix':'Switched to file editor — ',
        'toast.file_loaded_suffix':' loaded',
        'toast.load_failed_prefix':'Failed to load: ',
        'toast.file_saved_suffix':' saved',
        'toast.save_failed_detail_prefix':'Save failed: ',
        'toast.folder_picker_unsupported':'Folder picker not supported',
        'toast.folder_open_failed':'Failed to open folder',
        'toast.folder_refreshed':'Folder reloaded',
        'toast.folder_refresh_failed':'Reload failed',
        'toast.memo_returned':'Returned to memo',
        'toast.autosave_restored':'Autosave restored',
        'toast.autosave_cleared':'Autosave cleared',
        'toast.passkey_require_password':'Please register a password first',
        'toast.passkey_unlinked':'Passkey link removed',
        'toast.font_size_prefix':'Font size: ',
        'toast.offline_error':'Error: Internet connection lost',
        'pws.strength_prefix':'Strength: ',
        'pws.strength_weak':'Weak (6+ chars recommended)',
        'pws.strength_medium':'Medium',
        'pws.strength_strong':'Strong',
        'pws.error_mismatch':'Passwords do not match',
        'pws.error_tooshort':'Must be at least 4 characters',
        'pws.progress_deriving':'Deriving key... (please wait)',
        'pws.progress_encrypting':'Encrypting data...',
        'pws.error_failed':'Setup failed: ',
        'pagemax.msg':'Maximum MAX pages reached',
        'page.default':'Page ',
        'page.placeholder':'Page name...',
        'footer.unit':' chars',
        'pp.empty':'Empty page',
        'folder.title':'Folder'
      }
    };

    function apply() {
      document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key  = el.dataset.i18n;
        var attr = el.dataset.i18nAttr;
        /* フォルダパネルタイトルは実フォルダ名が入っているときスキップ */
        if (el.id === 'folderPanelTitle' && el.dataset.i18nLocked) return;
        var val  = (dict[_lang] && dict[_lang][key]) || dict['ja'][key] || key;
        if (attr) { el[attr] = val; } else { el.textContent = val; }
      });
      var jaBtn = document.getElementById('langJaBtn');
      var enBtn = document.getElementById('langEnBtn');
      if (jaBtn) jaBtn.classList.toggle('active', _lang === 'ja');
      if (enBtn) enBtn.classList.toggle('active', _lang === 'en');
    }

    window.i18n = {
      t: function(key) { return (dict[_lang] && dict[_lang][key]) || dict['ja'][key] || key; },
      lang: function() { return _lang; },
      setLang: function(lang) {
        if (lang === _lang) return;
        var overlay = document.getElementById('langTransitionOverlay');
        var label   = document.getElementById('langTransitionLabel');
        /* 切り替え先言語の「変更中」メッセージ */
        var msg = lang === 'en' ? 'Changing language...' : '言語を変更中...';
        if (label) label.textContent = msg;
        /* フェードイン */
        if (overlay) overlay.classList.add('fade-in');
        setTimeout(function() {
          /* 言語適用 */
          _lang = lang;
          localStorage.setItem(LANG_KEY, lang);
          apply();
          /* フェードアウト */
          setTimeout(function() {
            if (overlay) overlay.classList.remove('fade-in');
          }, 900);
        }, 380);
      },
      apply: apply
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', apply);
    } else {
      apply();
    }
  })();
  </script>

  <script>

  (function() {
    var ALLOWED = 'sansyokudango1212-commits.github.io';
    var host = window.location.hostname;
    if (host && host !== 'localhost' && host !== '127.0.0.1' && host !== '' && host !== ALLOWED) {
      window.location.replace('https://' + ALLOWED + '/HTML-Browser-Notepad/');
    }
  })();

  var CryptoEngine = (function() {
    var ITER     = 600000;
    var KEY_LEN  = 256;
    var SALT_LEN = 32;
    var IV_LEN   = 12;
    var TOKEN    = 'NOTEPAD26_AUTH_TOKEN_v1';

    function buf2hex(buf) {
      return Array.from(new Uint8Array(buf))
        .map(function(b) { return ('00' + b.toString(16)).slice(-2); }).join('');
    }
    function hex2buf(hex) {
      var arr = new Uint8Array(hex.length / 2);
      for (var i = 0; i < arr.length; i++) arr[i] = parseInt(hex.substr(i * 2, 2), 16);
      return arr.buffer;
    }
    async function deriveKey(password, salt) {
      var mat = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: salt, iterations: ITER, hash: 'SHA-256' },
        mat, { name: 'AES-GCM', length: KEY_LEN }, false, ['encrypt', 'decrypt']
      );
    }
    async function encrypt(plain, password, onProgress) {
      if (onProgress) onProgress('鍵導出中... (600,000回)');
      var salt = crypto.getRandomValues(new Uint8Array(SALT_LEN));
      var iv   = crypto.getRandomValues(new Uint8Array(IV_LEN));
      var key  = await deriveKey(password, salt);
      if (onProgress) onProgress('暗号化中...');
      var enc = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, new TextEncoder().encode(plain));
      return buf2hex(salt) + buf2hex(iv) + buf2hex(enc);
    }
    async function decrypt(hexData, password) {
      try {
        var salt  = hex2buf(hexData.slice(0, SALT_LEN * 2));
        var iv    = new Uint8Array(hex2buf(hexData.slice(SALT_LEN * 2, SALT_LEN * 2 + IV_LEN * 2)));
        var key   = await deriveKey(password, salt);
        var plain = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, hex2buf(hexData.slice(SALT_LEN * 2 + IV_LEN * 2)));
        return new TextDecoder().decode(plain);
      } catch(e) { return null; }
    }
    return {
      savePasswordToken: async function(password, onProgress) {
        localStorage.setItem('np26_pw_token', await encrypt(TOKEN, password, onProgress));
      },
      verifyPassword: async function(password) {
        var token = localStorage.getItem('np26_pw_token');
        if (!token) return false;
        return (await decrypt(token, password)) === TOKEN;
      },
      encryptPages: async function(pagesData, password, onProgress) {
        localStorage.setItem('np26_pages_enc', await encrypt(JSON.stringify(pagesData), password, onProgress));
        localStorage.removeItem('np26_pages');
      },
      decryptPages: async function(password) {
        var enc = localStorage.getItem('np26_pages_enc');
        if (!enc) return null;
        var plain = await decrypt(enc, password);
        if (!plain) return null;
        try { return JSON.parse(plain); } catch(e) { return null; }
      },
      clearPassword: function() { localStorage.removeItem('np26_pw_token'); },
      isEnabled: function() { return !!localStorage.getItem('np26_pw_token'); }
    };
  })();

  var BiometricEngine = (function() {
    var CRED_KEY  = 'np26_bio_credId';
    var PWENC_KEY = 'np26_bio_pw_enc'; 
    var RP_ID     = location.hostname || 'localhost';
    var RP_NAME   = 'Notepad26';

    function buf2b64(buf) { return btoa(String.fromCharCode.apply(null, new Uint8Array(buf))); }
    function b642buf(b64) { var s = atob(b64); var a = new Uint8Array(s.length); for (var i=0;i<s.length;i++) a[i]=s.charCodeAt(i); return a.buffer; }

    /* パスワードをデバイス固有キー(固定salt+AES-GCM)で暗号化して保存 */
    async function storePassword(password) {
      var salt = new TextEncoder().encode('np26_bio_salt_v1');
      var keyMat = await crypto.subtle.importKey('raw', salt, 'PBKDF2', false, ['deriveKey']);
      var key = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: new TextEncoder().encode(RP_ID), iterations: 1000, hash: 'SHA-256' },
        keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
      );
      var iv  = crypto.getRandomValues(new Uint8Array(12));
      var enc = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, new TextEncoder().encode(password));
      var combined = new Uint8Array(12 + enc.byteLength);
      combined.set(iv); combined.set(new Uint8Array(enc), 12);
      localStorage.setItem(PWENC_KEY, buf2b64(combined.buffer));
    }
    async function retrievePassword() {
      var stored = localStorage.getItem(PWENC_KEY); if (!stored) return null;
      try {
        var combined = new Uint8Array(b642buf(stored));
        var iv   = combined.slice(0, 12);
        var data = combined.slice(12);
        var salt = new TextEncoder().encode('np26_bio_salt_v1');
        var keyMat = await crypto.subtle.importKey('raw', salt, 'PBKDF2', false, ['deriveKey']);
        var key = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: new TextEncoder().encode(RP_ID), iterations: 1000, hash: 'SHA-256' },
          keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
        var dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, data);
        return new TextDecoder().decode(dec);
      } catch(e) { return null; }
    }

    return {
      isSupported: function() { return !!(window.PublicKeyCredential && navigator.credentials); },
      isRegistered: function() { return !!localStorage.getItem(CRED_KEY); },

      register: async function(password) {
        if (!this.isSupported()) throw new Error('この端末ではパスキー認証は利用できません。');
        var userId = crypto.getRandomValues(new Uint8Array(16));
        var cred = await navigator.credentials.create({
          publicKey: {
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            rp: { id: RP_ID, name: RP_NAME },
            user: { id: userId, name: 'user', displayName: 'Notepad26 User' },
            pubKeyCredParams: [
              { type: 'public-key', alg: -7  },  /* ES256 */
              { type: 'public-key', alg: -257 }   /* RS256 */
            ],
            authenticatorSelection: { userVerification: 'required' },
            timeout: 60000,
            attestation: 'none'
          }
        });
        localStorage.setItem(CRED_KEY, buf2b64(cred.rawId));
        await storePassword(password);
        return true;
      },

      authenticate: async function() {
        if (!this.isSupported() || !this.isRegistered()) return null;
        var credId = b642buf(localStorage.getItem(CRED_KEY));
        var cred = await navigator.credentials.get({
          publicKey: {
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            rpId: RP_ID,
            allowCredentials: [{ type: 'public-key', id: credId }],
            userVerification: 'required',
            timeout: 60000
          }
        });
        if (!cred) return null;
        return await retrievePassword();
      },

      clear: function() {
        localStorage.removeItem(CRED_KEY);
        localStorage.removeItem(PWENC_KEY);
      }
    };
  })();

  var sessionUnlocked = false;
  var sessionPassword = '';  // メモリのみ、外部送信なし

  var lockScreen    = document.getElementById('lockScreen');
  var lockPwInput   = document.getElementById('lockPwInput');
  var lockSubmitBtn = document.getElementById('lockSubmitBtn');
  var lockErrorMsg  = document.getElementById('lockErrorMsg');

  async function tryUnlock() {
    var pw = lockPwInput.value;
    if (!pw) { showLockError(window.i18n.t('lock.empty')); return; }
    lockSubmitBtn.disabled = true;
    lockSubmitBtn.textContent = window.i18n.t('lock.checking');
    var ok = await CryptoEngine.verifyPassword(pw);
    if (ok) {
      sessionUnlocked = true;
      sessionPassword = pw;
      var lockCard = document.getElementById('lockCard');
      if (lockCard) lockCard.classList.add('unlocking');
      setTimeout(function() {
        lockScreen.classList.add('unlocking');
      }, 320);
      setTimeout(function() {
        lockScreen.classList.add('hidden');
      }, 650);
      loadEncryptedPages(pw);
      return; /* 解除成功: ボタンのリセットは不要 */
    }
    showLockError(window.i18n.t('lock.invalid'));
    lockPwInput.classList.add('error');
    setTimeout(function() { lockPwInput.classList.remove('error'); }, 400);
    lockPwInput.value = '';
    lockPwInput.focus();
    lockSubmitBtn.disabled = false;
    lockSubmitBtn.textContent = window.i18n.t('lock.submit');
  }
  function showLockError(msg) {
    lockErrorMsg.textContent = msg;
    setTimeout(function() { lockErrorMsg.textContent = ''; }, 3000);
  }
  lockSubmitBtn.onclick = tryUnlock;

  document.getElementById('bioPromptRegisterBtn').addEventListener('click', async function() {
    var btn = this;
    btn.disabled = true; btn.textContent = window.i18n.t('bio.registering');
    try {
      await BiometricEngine.register(sessionPassword);
      closePanel('bioPromptModal');
      queueToast(window.i18n.t('toast.passkey_registered'), 2500);
      if (typeof window.updateBioUI === 'function') window.updateBioUI();
    } catch(e) {
      btn.disabled = false; btn.textContent = window.i18n.t('bio.register');
      queueToast(window.i18n.t('toast.register_failed') + (e.message || window.i18n.t('toast.register_failed_unknown')), 3000);
    }
  });
  document.getElementById('bioPromptSkipBtn').addEventListener('click', function() {
    closePanel('bioPromptModal');
  });

  var lockBioBtn = document.getElementById('lockBioBtn');
  if (lockBioBtn && BiometricEngine.isSupported() && BiometricEngine.isRegistered()) {
    lockBioBtn.style.display = '';
    lockBioBtn.addEventListener('click', async function() {
      lockBioBtn.disabled = true;
      lockBioBtn.textContent = window.i18n.t('lock.bio.checking');
      try {
        var pw = await BiometricEngine.authenticate();
        if (pw) {
          var ok = await CryptoEngine.verifyPassword(pw);
          if (ok) {
            sessionUnlocked = true; sessionPassword = pw;
            var lockCard = document.getElementById('lockCard');
            if (lockCard) lockCard.classList.add('unlocking');
            setTimeout(function() {
              lockScreen.classList.add('unlocking');
            }, 320);
            setTimeout(function() {
              lockScreen.classList.add('hidden');
            }, 650);
            loadEncryptedPages(pw);
            return;
          }
        }
        showLockError('認証に失敗しました');
      } catch(e) {
        showLockError('パスキーでの認証がキャンセルされました');
      }
      lockBioBtn.disabled = false;
      lockBioBtn.textContent = 'パスキーでロック解除';
    });
    setTimeout(function() { lockBioBtn.click(); }, 400);
  }

  lockPwInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') tryUnlock(); });

  (function checkInitialLock() {
    if (!CryptoEngine.isEnabled()) {
      sessionUnlocked = true;
    } else {
      lockScreen.classList.remove('hidden');
      setTimeout(function() { lockPwInput.focus(); }, 100);
    }
  })();

  var pwSetNew      = document.getElementById('pwSetNew');
  var pwSetConfirm  = document.getElementById('pwSetConfirm');
  var pwSetError    = document.getElementById('pwSetError');
  var pwSetProgress = document.getElementById('pwSetProgress');
  var pwSetSaveBtn  = document.getElementById('pwSetSaveBtn');
  var pwStrength    = document.getElementById('pwStrength');

  function getStrength(pw) {
    if (!pw) return null;
    var len = pw.length;
    if (len < 6)  return { level: 'weak',   labelKey: 'pws.strength_weak' };
    if (len < 8)  return { level: 'medium', labelKey: 'pws.strength_medium' };
    return { level: 'strong', labelKey: 'pws.strength_strong' };
  }
  function updatePwSaveBtn() {
    var pw1 = pwSetNew.value, pw2 = pwSetConfirm.value;
    var str = getStrength(pw1);
    if (str) { pwStrength.className = 'pwset-strength ' + str.level; pwStrength.textContent = window.i18n.t('pws.strength_prefix') + window.i18n.t(str.labelKey); }
    else     { pwStrength.className = 'pwset-strength'; pwStrength.textContent = ''; }
    var ok = pw1.length >= 4 && pw1 === pw2;
    pwSetSaveBtn.disabled = !ok;
    pwSetError.textContent = pw2.length > 0 && pw1 !== pw2 ? window.i18n.t('pws.error_mismatch') : '';
  }
  pwSetNew.oninput     = updatePwSaveBtn;
  pwSetConfirm.oninput = updatePwSaveBtn;

  function openPwSetModal() {
    pwSetNew.value = ''; pwSetConfirm.value = '';
    pwSetError.textContent = ''; pwSetProgress.textContent = '';
    pwStrength.textContent = ''; pwStrength.className = 'pwset-strength';
    pwSetSaveBtn.disabled = true;
    openPanel('pwSetModal');
    setTimeout(function() { pwSetNew.focus(); }, 80);
  }
  window.closePwSetModal = function() {
    closePanel('pwSetModal');
    setTimeout(function() {
      document.getElementById('pwLockToggle').checked = CryptoEngine.isEnabled();
    }, 300);
  };
  window.savePassword = async function() {
    var pw = pwSetNew.value;
    if (!pw || pw.length < 4) { pwSetError.textContent = window.i18n.t('pws.error_tooshort'); return; }
    pwSetSaveBtn.disabled = true;
    pwSetProgress.textContent = window.i18n.t('pws.progress_deriving');
    try {
      await CryptoEngine.savePasswordToken(pw, function(msg) {
        /* CryptoEngine内部のハードコード日本語を翻訳してから表示 */
        var translated = msg
          .replace('鍵導出中... (600,000回)', window.i18n.t('pws.progress_deriving'))
          .replace('暗号化中...', window.i18n.t('pws.progress_encrypting'));
        pwSetProgress.textContent = translated;
      });
      sessionPassword = pw;
      sessionUnlocked = true;
      pwSetProgress.textContent = window.i18n.t('pws.progress_encrypting');
      await CryptoEngine.encryptPages(pages, pw, function(msg) { pwSetProgress.textContent = msg; });
      closePanel('pwSetModal');
      queueToast(window.i18n.t('toast.pwlock_set'), 3000);
      if (BiometricEngine.isSupported()) {
        setTimeout(function() { openPanel('bioPromptModal'); }, 400);
      }
    } catch(e) {
      pwSetError.textContent = window.i18n.t('pws.error_failed') + e.message;
      pwSetSaveBtn.disabled = false;
    }
    pwSetProgress.textContent = '';
  };

  function openPwUnlockModal() { openPanel('pwUnlockModal'); }
  window.closePwUnlockModal = function() {
    closePanel('pwUnlockModal');
    setTimeout(function() {
      document.getElementById('pwLockToggle').checked = CryptoEngine.isEnabled();
    }, 300);
  };
  window.confirmPwUnlock = function() {
    closePanel('pwUnlockModal');
    CryptoEngine.clearPassword();
    if (sessionPassword) {
      CryptoEngine.decryptPages(sessionPassword).then(function(data) {
        if (data) {
          try { localStorage.setItem('np26_pages', JSON.stringify(data)); } catch(e) {}
        }
        localStorage.removeItem('np26_pages_enc');
        sessionPassword = '';
        queueToast(window.i18n.t('toast.pwlock_removed'), 3000);
      });
    } else {
      localStorage.removeItem('np26_pages_enc');
      queueToast(window.i18n.t('toast.pwlock_removed'), 3000);
    }
  };

  async function loadEncryptedPages(pw) {
    if (!localStorage.getItem('np26_pages_enc')) return;
    var data = await CryptoEngine.decryptPages(pw);
    if (!data || !Array.isArray(data) || data.length === 0) return;
    pages = data;
    curPageIdx = Math.min(curPageIdx, pages.length - 1);
    var p = pages[curPageIdx], edit = document.getElementById('edit');
    var fSel = document.getElementById('fSel'), sSel = document.getElementById('sSel');
    if (p && edit) {
      for (var i = 0; i < fSel.options.length; i++) {
        if (fSel.options[i].value === p.font) { fSel.selectedIndex = i; break; }
      }
      sSel.value = String(p.size || 18);
      applyStyles();
      edit.value = p.text || '';
      ActionHandlers.updateText(edit.value); render();
      if (typeof renderPageList === 'function') renderPageList();
    }
  }

  var $ = function(id) { return document.getElementById(id); };

  /* ページ切り替えスライドアニメーションのヘルパー */
  function slidePageIn(edit) {
    edit.classList.remove('page-slide-in-right');
    void edit.offsetWidth;
    edit.classList.add('page-slide-in-right');
    setTimeout(function() { edit.classList.remove('page-slide-in-right'); }, 350);
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function normalizeSize(size) {
    size = Math.round(size);
    if (size % 2 !== 0) size = (size < 18) ? size + 1 : size - 1;
    return Math.min(80, Math.max(12, size));
  }
  function sanitizeFileName(name) {
    name = (name || 'memo.txt').trim().replace(/[/\\:*?"<>|]/g, '');
    return name.toLowerCase().endsWith('.txt') ? name : name + '.txt';
  }

  function doFileSave(withMeta) {
    try {
      var text = $('edit').value;
      var fullText = withMeta
        ? '##FONT:"' + $('fSel').value + '"\n##SIZE:' + $('sSel').value + '\n' + text
        : text;
      var a = document.createElement('a');
      var blob = new Blob([fullText], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      a.href = url; a.download = sanitizeFileName(state.curFile); a.click(); URL.revokeObjectURL(url);
      queueToast(window.i18n.t('toast.saved_prefix') + state.curFile, 2500);
    } catch(e) { queueToast(window.i18n.t('toast.save_failed')); }
  }

  function openSaveMetaModal() {
    $('saveMetaRememberToggle').checked = false;
    state.isModalOpen = true; openPanel('saveMetaModal'); render();
  }
  function closeSaveMetaModal() {
    state.isModalOpen = false; closePanel('saveMetaModal'); render();
  }
  function debounce(fn, wait) {
    var t;
    return function() { var ctx = this, args = arguments; clearTimeout(t); t = setTimeout(function() { fn.apply(ctx, args); }, wait); };
  }
  function isFontAvailable(font) {
    if (!font) return false;
    try {
      var c = document.createElement('canvas'), ctx = c.getContext('2d');
      ctx.font = '72px monospace'; var w1 = ctx.measureText('abcdefg').width;
      ctx.font = '72px "' + font + '", monospace';
      return w1 !== ctx.measureText('abcdefg').width;
    } catch(e) { return false; }
  }
  function updateSelectValue(id, value) {
    var sel = $(id);
    for (var i = 0; i < sel.options.length; i++) {
      if (sel.options[i].value == value) { sel.selectedIndex = i; return; }
    }
    if (id === 'fSel' && isFontAvailable(value)) {
      sel.add(new Option(value, value)); sel.selectedIndex = sel.options.length - 1;
    }
  }
  function getDevice() {
    var ua = navigator.userAgent.toLowerCase();
    return (/mobi|android|iphone|ipad|ipod|windows phone|blackberry|silk/.test(ua) || (navigator.maxTouchPoints > 1 && window.screen.width <= 1024)) ? 'Mobile' : 'PC';
  }
  function getBrowser() {
    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('opr')     !== -1) return 'Opera';
    if (ua.indexOf('edg')     !== -1) return 'Edge';
    if (ua.indexOf('firefox') !== -1) return 'Firefox';
    if (ua.indexOf('chrome')  !== -1) return 'Chrome';
    if (ua.indexOf('safari')  !== -1) return 'Safari';
    return 'Browser';
  }

  var state = {
    curFile: 'memo.txt', browser: getBrowser(), device: getDevice(),
    text: '', isOptionsOpen: false, isModalOpen: false, isSearchOpen: false,
    modalType: 'new', isFooterHidden: false, hideTimer: null,
    accentColor: localStorage.getItem('accentColor') || '#c9a181',
    autoSave: localStorage.getItem('autoSave') === 'true',
    saveMeta: localStorage.getItem('saveMeta') !== 'false',
    footerAlways: localStorage.getItem('footerAlways') === 'true'
  };
  var supportedFonts = ['Arial','Noto Sans JP','Noto Serif JP','Zen Maru Gothic','Dela Gothic One','Kosugi Maru'];

  var toastQueue = [], isToastShowing = false, sizeToastTimer = null, hasShownOfflineToast = false;
  function queueToast(message, duration) {
    toastQueue.push({ message: message, duration: duration || 4000 });
    processToastQueue();
  }
  function processToastQueue() {
    if (isToastShowing || toastQueue.length === 0) return;
    isToastShowing = true;
    var item = toastQueue.shift();
    var el = document.createElement('div');
    el.className = 'glass toast';
    var msg = document.createElement('div'); msg.className = 'msg'; msg.textContent = item.message;
    var count = document.createElement('div'); count.className = 'count';
    el.appendChild(msg); el.appendChild(count);
    $('toastContainer').appendChild(el);
    setTimeout(function() {
      el.classList.add('show');
      /* transitionDuration を先に設定し、rAF で width 変更して確実にアニメーションを発火させる */
      count.style.transitionDuration = item.duration + 'ms';
      requestAnimationFrame(function() {
        requestAnimationFrame(function() { count.style.width = '0%'; });
      });
    }, 50);
    setTimeout(function() {
      el.classList.remove('show');
      setTimeout(function() { el.remove(); isToastShowing = false; processToastQueue(); }, 400);
    }, item.duration);
  }

  /* ファイル／フォルダ 選択チューザー */
  function openFileOrFolderChooser() {
    openPanel('openChooserModal');
  }
  (function initOpenChooser() {
    var SUPPORTED_EXTS_PICKER = [
      { description: 'テキストファイル', accept: {
        'text/plain':       ['.txt'],
        'text/html':        ['.html','.htm'],
        'application/json': ['.json'],
        'text/markdown':    ['.md'],
        'text/css':         ['.css'],
        'text/javascript':  ['.js'],
        'application/xml':  ['.xml'],
        'text/csv':         ['.csv']
      }}
    ];

    document.getElementById('ocFileBtn').onclick = async function() {
      closePanel('openChooserModal');
      if (window.showOpenFilePicker) {
        try {
          var handles = await window.showOpenFilePicker({ multiple: false, types: SUPPORTED_EXTS_PICKER });
          var handle = handles[0];
          var file = await handle.getFile();
          var text = await file.text();
          var edit = $('edit');
          state.curFile = file.name;
          edit.value = text;
          ActionHandlers.updateText(text);
          saveCurrentPage();
          render();
          /* フォルダパネルが開いていれば閉じる */
          if (window.closeFolderPanel) window.closeFolderPanel();
        } catch(e) {
          if (e.name !== 'AbortError') queueToast(window.i18n.t('toast.open_file_failed'), 2500);
        }
      } else {
        /* フォールバック */
        var fi = $('fileInput'); try { fi.value = ''; } catch(e2) {} fi.click();
      }
    };

    document.getElementById('ocFolderBtn').onclick = function() {
      closePanel('openChooserModal');
      /* フォルダパネルの openDirectory を呼ぶ */
      if (window.folderOpenDirectory) {
        window.folderOpenDirectory();
      } else {
        queueToast(window.i18n.t('toast.folder_not_supported'), 3000);
      }
    };

    document.getElementById('ocCancelBtn').onclick = function() {
      closePanel('openChooserModal');
    };
  })();

  var ActionHandlers = {
    new: function() { state.modalType = 'new'; state.isModalOpen = true; openPanel('confirmModal'); },
    open: function() {
      state.isModalOpen = false; state.isOptionsOpen = false; render();
      if (window.showOpenFilePicker) {
        (async function() {
          try {
            var handles = await window.showOpenFilePicker({ multiple: false, types: [{
              description: 'テキストファイル', accept: {
                'text/plain':       ['.txt'],
                'text/html':        ['.html','.htm'],
                'application/json': ['.json'],
                'text/markdown':    ['.md'],
                'text/css':         ['.css'],
                'text/javascript':  ['.js'],
                'application/xml':  ['.xml'],
                'text/csv':         ['.csv'],
                'text/x-python':    ['.py']
              }
            }]});
            var handle = handles[0];
            var file = await handle.getFile();
            var text = await file.text();
            var edit = $('edit');
            state.curFile = file.name;
            edit.value = text;
            ActionHandlers.updateText(text);
            saveCurrentPage(); render();
            if (window.closeFolderPanel) window.closeFolderPanel();
           
          } catch(e) {
            if (e.name !== 'AbortError') queueToast(window.i18n.t('toast.open_file_failed'), 2500);
          }
        })();
      } else {
        var fi = $('fileInput'); try { fi.value = ''; } catch(e) {} fi.click();
      }
    },
    save: function() {
      state.text = $('edit').value;
      if (localStorage.getItem('saveMetaRemembered') === 'true') {
        doFileSave(state.saveMeta);
      } else {
        openSaveMetaModal();
      }
    },
    togglePagePanel: function() {
      if (pagePanelOpen) { closePagePanel(); return; }
      openPagePanel();
    },
    toggleFolderPanel: function() {
      var panel = document.getElementById('folderPanel');
      if (panel && panel.classList.contains('open')) { if (window.closeFolderPanel) window.closeFolderPanel(); }
      else { if (window.openFolderPanel) window.openFolderPanel(); }
    },
    toggle: function() {
      if (state.isOptionsOpen) { state.isOptionsOpen = false; closePanel('options'); }
      else { state.isOptionsOpen = true; state.isModalOpen = false; hideContextMenu(); closePanel('translatePanel'); openPanel('options'); }
    },
    share: function() {
      if (!navigator.share) { queueToast(window.i18n.t('toast.share_not_supported'), 2000); return; }
      var title = (pages && pages[curPageIdx]) ? pages[curPageIdx].title : state.curFile;
      var text  = $('edit').value;
      navigator.share({ title: title, text: text })
        .catch(function(e) { if (e.name !== 'AbortError') queueToast(window.i18n.t('toast.share_failed'), 2000); });
    },
    toggleSearch: function() {
      state.isSearchOpen = !state.isSearchOpen;
      if (state.isSearchOpen) {
        openPanel('searchPanel');
        setTimeout(function() { $('searchInput').focus(); }, 50);
        doSearch(0);
      } else {
        closePanel('searchPanel');
        clearSearchHighlight();
        $('searchCount').textContent = '';
        updateTextareaPadding();
      }
    },
    searchNext: function() { doSearch(1); },
    searchPrev: function() { doSearch(-1); },
    closeOverlays: function() {
      if (state.isOptionsOpen) { state.isOptionsOpen = false; closePanel('options'); }
      if (state.isModalOpen)   { state.isModalOpen   = false; closePanel('confirmModal'); }
      closePanel('translatePanel'); closePanel('searchWebPanel'); closeSaveMetaModal();
    },
    updateText: function(val) {
      var lines = val.split(/\r?\n/), bodyLines = [], changed = false;
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.startsWith('##FONT:')) { updateSelectValue('fSel', line.replace('##FONT:','').replace(/"/g,'').trim()); changed = true; continue; }
        if (line.startsWith('##SIZE:')) { var s = parseInt(line.replace('##SIZE:','').trim()); if (!isNaN(s)) { updateSelectValue('sSel', normalizeSize(s)); changed = true; } continue; }
        bodyLines.push(line);
      }
      var processed = bodyLines.join('\n');
      if (changed) { state.text = processed; $('edit').value = state.text; applyStyles(); }
      else { state.text = val; }
      clearTimeout(state.hideTimer);
      var edit = $('edit');
      if (state.text.length > 0 && (edit.scrollHeight - (edit.scrollTop + edit.clientHeight) < 50)) {
        state.isFooterHidden = true;
        state.hideTimer = setTimeout(function() { state.isFooterHidden = false; render(); }, 1000);
      } else { state.isFooterHidden = false; }
    }
  };

  function updateTextareaPadding() {
    var edit = $('edit'), mirror = $('searchHighlightMirror');
    edit.style.paddingTop = '80px'; mirror.style.paddingTop = '80px';
    if (!state.isSearchOpen) {
      edit.readOnly = false; edit.style.caretColor = '';
    }
  }

  window.act = function(type) { ActionHandlers[type](); render(); };
  window.closeConfirm = function(yes) {
    if (yes && state.modalType === 'new') {
      $('edit').value = ''; ActionHandlers.updateText(''); state.curFile = 'memo.txt';
    }
    state.isModalOpen = false; closePanel('confirmModal'); render();
  };
  window.closePanel = closePanel;
  window.openPanel  = openPanel;

  var selectedText = '', contextMenu = null;
  var CLIP_KEY = 'notepad26_clipboard';
  function hideContextMenu() {
    if (contextMenu) { contextMenu.style.display = 'none'; contextMenu.classList.remove('animating'); }
  }
  function showContextMenu(x, y, hasSel) {
    if (!contextMenu) contextMenu = $('contextMenu');
    var isMob = state.device === 'Mobile';
    [$('ctxCopy'), $('ctxCut')].forEach(function(el) { if (el) el.style.display = (!isMob && hasSel) ? '' : 'none'; });
    [$('ctxDivider'), $('ctxSearch'), $('ctxTrans'), $('ctxCompare'), $('ctxShare')].forEach(function(el) { if (el) el.style.display = hasSel ? '' : 'none'; });
    var ctxFind = $('ctxFind'); if (ctxFind) ctxFind.style.display = '';
    var paste = $('ctxPaste'), hasClip = (localStorage.getItem(CLIP_KEY) || '').length > 0;
    paste.style.display = (!isMob && !hasSel) ? '' : 'none';
    paste.style.color = hasClip ? '' : 'var(--dim)'; paste.style.cursor = hasClip ? '' : 'default'; paste.style.pointerEvents = hasClip ? '' : 'none';
    contextMenu.classList.remove('animating');
    contextMenu.style.left = x + 'px'; contextMenu.style.top = y + 'px'; contextMenu.style.display = 'block';
    var rect = contextMenu.getBoundingClientRect(), fx = x, fy = y;
    if (rect.right  > window.innerWidth  - 8) fx = x - rect.width  - 4;
    if (rect.bottom > window.innerHeight - 8) fy = y - rect.height - 4;
    contextMenu.style.left = fx + 'px'; contextMenu.style.top = fy + 'px';
    contextMenu.style.transformOrigin = ((fy !== y) ? 'bottom' : 'top') + ' ' + ((fx !== x) ? 'right' : 'left');
    void contextMenu.offsetWidth; contextMenu.classList.add('animating');
  }
  function copyToClipboard(text, onDone) { localStorage.setItem(CLIP_KEY, text); if (onDone) onDone(); }
  window.ctxCopyText  = function() { if (!selectedText) { hideContextMenu(); return; } var t = selectedText; hideContextMenu(); copyToClipboard(t, function() { queueToast(window.i18n.t('toast.copied'), 1000); }); };
  window.ctxOpenSearch = function() {
    hideContextMenu();
    if (!state.isSearchOpen) { state.isSearchOpen = true; openPanel('searchPanel'); doSearch(0); }
    setTimeout(function() { $('searchInput').focus(); }, 60);
  };
  window.ctxShareText = function() {
    var text = selectedText;
    hideContextMenu();
    if (!text) return;
    if (!navigator.share) { copyToClipboard(text, function() { queueToast(window.i18n.t('toast.share_copied'), 2000); }); return; }
    navigator.share({ text: text })
      .catch(function(e) { if (e.name !== 'AbortError') queueToast(window.i18n.t('toast.share_failed'), 2000); });
  };
  window.ctxCutText   = function() {
    if (!selectedText) { hideContextMenu(); return; }
    var edit = $('edit'), s = edit.selectionStart, e = edit.selectionEnd, t = selectedText; hideContextMenu();
    copyToClipboard(t, function() { edit.setRangeText('', s, e, 'start'); ActionHandlers.updateText(edit.value); scheduleAutoSave(); render(); selectedText = ''; queueToast(window.i18n.t('toast.cut_done'), 1000); });
  };
  window.ctxPasteText = function() {
    var text = localStorage.getItem(CLIP_KEY) || ''; if (!text) { hideContextMenu(); return; }
    var edit = $('edit'); edit.setRangeText(text, edit.selectionStart, edit.selectionEnd, 'end');
    ActionHandlers.updateText(edit.value); scheduleAutoSave(); render(); hideContextMenu();
  };

  var swpCurrentPageUrl = '';
  var DICT_CONFIG = {
    wikipedia:  { get btnText() { return window.i18n.lang() === 'en' ? 'Open on Wiki' : 'Wikiで開く'; } },
    wiktionary: { get btnText() { return window.i18n.lang() === 'en' ? 'Open on Wikt' : 'Wiktで開く'; } }
  };
  function getCurrentDict() { return localStorage.getItem('dictEngine') || 'wikipedia'; }

  window.searchWiki = function() {
    if (!selectedText) { hideContextMenu(); return; }
    hideContextMenu();
    var dict = getCurrentDict(), query = selectedText, body = $('swpBody');
    $('swpWikiBtn').textContent = (DICT_CONFIG[dict] || DICT_CONFIG.wikipedia).btnText;
    body.innerHTML = '<div class="swp-loading">' + window.i18n.t('swp.loading') + '</div>';
    openPanel('searchWebPanel');
    if (dict === 'wiktionary') searchWiktionary(query); else searchWikipedia(query);
  };

  function animateResults(containerEl, html, expand) {
    containerEl.style.transition = 'opacity 0.16s ease'; containerEl.style.opacity = '0';
    setTimeout(function() {
      var wrap = document.createElement('div'); wrap.className = 'result-anim-wrap'; wrap.innerHTML = html;
      var items = wrap.children;
      for (var i = 0; i < items.length; i++) items[i].classList.add('result-anim-item');
      containerEl.innerHTML = ''; containerEl.appendChild(wrap);
      containerEl.style.opacity = '1'; containerEl.style.transition = '';
      if (expand === false) {
        wrap.style.maxHeight = 'none'; wrap.style.overflow = 'visible';
        requestAnimationFrame(function() {
          wrap.classList.add('open');
          wrap.querySelectorAll('.result-anim-item').forEach(function(el, i) { setTimeout(function() { el.classList.add('visible'); }, 30 + i * 40); });
        });
      } else {
        requestAnimationFrame(function() {
          wrap.style.maxHeight = 'none'; var h = wrap.scrollHeight; wrap.style.maxHeight = '0px';
          requestAnimationFrame(function() {
            wrap.classList.add('open'); wrap.style.maxHeight = h + 'px';
            wrap.querySelectorAll('.result-anim-item').forEach(function(el, i) { setTimeout(function() { el.classList.add('visible'); }, 60 + i * 50); });
            setTimeout(function() { wrap.style.transition = 'none'; wrap.style.maxHeight = 'none'; wrap.style.overflow = 'visible'; }, 680);
          });
        });
      }
    }, 175);
  }
  function animateSearchResults(html) { animateResults($('swpBody'), html, true); }

  function searchWikipedia(query) {
    var wikiBtn = $('swpWikiBtn');
    var lang = window.i18n.lang();
    var domain = lang === 'en' ? 'en.wikipedia.org' : 'ja.wikipedia.org';
    swpCurrentPageUrl = 'https://' + domain + '/wiki/' + encodeURIComponent(query);
    wikiBtn.onclick = function() { window.open(swpCurrentPageUrl, '_blank'); };
    fetch('https://' + domain + '/w/api.php?action=query&list=search&srsearch=' + encodeURIComponent(query) + '&srlimit=6&format=json&origin=*')
      .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
      .then(function(data) {
        var results = data.query && data.query.search;
        if (!results || !results.length) { animateSearchResults('<div class="swp-empty">' + window.i18n.t('swp.notfound_pre') + escapeHtml(query) + window.i18n.t('swp.notfound_mid') + 'Wikipedia' + window.i18n.t('swp.notfound_suf') + '</div>'); return; }
        swpCurrentPageUrl = 'https://' + domain + '/wiki/' + encodeURIComponent(results[0].title);
        wikiBtn.onclick = function() { window.open(swpCurrentPageUrl, '_blank'); };
        fetch('https://' + domain + '/api/rest_v1/page/summary/' + encodeURIComponent(results[0].title))
          .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
          .then(function(s) {
            var html = '';
            if (s && s.title) {
              var url = s.content_urls && s.content_urls.desktop ? s.content_urls.desktop.page : 'https://' + domain + '/wiki/' + encodeURIComponent(s.title);
              html += '<div class="swp-abstract"><div class="swp-abstract-heading">' + escapeHtml(s.title) + '</div>';
              if (s.description && s.description.indexOf('曖昧さ回避') === -1 && s.description !== 'Topics referred to by the same term') html += '<div class="swp-abstract-desc">' + escapeHtml(s.description) + '</div>';
              if (s.extract) html += '<div class="swp-abstract-text">' + escapeHtml(s.extract.slice(0, 400) + (s.extract.length > 400 ? '…' : '')) + '</div>';
              html += '<div class="swp-abstract-src"><a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">' + window.i18n.t('swp.wiki_read') + '</a></div></div>';
            }
            results.slice(1).forEach(function(item) {
              var u = 'https://' + domain + '/wiki/' + encodeURIComponent(item.title);
              var snip = item.snippet ? item.snippet.replace(/<[^>]+>/g,'') : '';
              html += '<a class="swp-result-item" href="' + escapeHtml(u) + '" target="_blank" rel="noopener"><div class="swp-result-title">' + escapeHtml(item.title) + '</div>';
              if (snip) html += '<div class="swp-result-desc">' + escapeHtml(snip) + '</div>';
              html += '<div class="swp-result-url">' + escapeHtml(u) + '</div></a>';
            });
            animateSearchResults(html || '<div class="swp-empty">' + window.i18n.t('swp.failed') + '</div>');
          });
      })
      .catch(function() { animateSearchResults('<div class="swp-empty">' + window.i18n.t('swp.failed') + '</div>'); });
  }

  function searchWiktionary(query) {
    var wikiBtn = $('swpWikiBtn');
    var lang = window.i18n.lang();
    var domain = lang === 'en' ? 'en.wiktionary.org' : 'ja.wiktionary.org';
    swpCurrentPageUrl = 'https://' + domain + '/wiki/' + encodeURIComponent(query);
    wikiBtn.onclick = function() { window.open(swpCurrentPageUrl, '_blank'); };
    fetch('https://' + domain + '/api/rest_v1/page/summary/' + encodeURIComponent(query))
      .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
      .then(function(data) {
        var html = '<div class="swp-abstract"><div class="swp-abstract-heading">' + escapeHtml(data.title || query) + '</div>';
        if (data.description && data.description.indexOf('曖昧さ回避') === -1 && data.description !== 'Topics referred to by the same term') html += '<div class="swp-abstract-desc">' + escapeHtml(data.description) + '</div>';
        if (data.extract) html += '<div class="swp-abstract-text">' + escapeHtml(data.extract.slice(0,500) + (data.extract.length > 500 ? '…' : '')) + '</div>';
        var pUrl = data.content_urls && data.content_urls.desktop ? data.content_urls.desktop.page : swpCurrentPageUrl;
        html += '<div class="swp-abstract-src"><a href="' + escapeHtml(pUrl) + '" target="_blank" rel="noopener">' + window.i18n.t('swp.wikt_read') + '</a></div></div>';
        fetch('https://' + domain + '/w/api.php?action=query&list=search&srsearch=' + encodeURIComponent(query) + '&srlimit=5&format=json&origin=*')
          .then(function(r) { return r.ok ? r.json() : { query: { search: [] } }; })
          .then(function(d) {
            var rels = (d.query && d.query.search) ? d.query.search.slice(1) : [];
            if (rels.length) {
              html += '<div class="swp-results-label">' + window.i18n.t('swp.related') + '</div>';
              rels.forEach(function(item) {
                var u = 'https://' + domain + '/wiki/' + encodeURIComponent(item.title);
                var snip = item.snippet ? item.snippet.replace(/<[^>]+>/g,'') : '';
                html += '<a class="swp-result-item" href="' + escapeHtml(u) + '" target="_blank" rel="noopener"><div class="swp-result-title">' + escapeHtml(item.title) + '</div>';
                if (snip) html += '<div class="swp-result-desc">' + escapeHtml(snip) + '</div></a>';
              });
            }
            animateSearchResults(html);
          });
      })
      .catch(function() {
        fetch('https://' + domain + '/w/api.php?action=query&list=search&srsearch=' + encodeURIComponent(query) + '&srlimit=6&format=json&origin=*')
          .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
          .then(function(d) {
            var results = d.query && d.query.search;
            if (!results || !results.length) { animateSearchResults('<div class="swp-empty">' + window.i18n.t('swp.failed') + '</div>'); return; }
            var html = '<div class="swp-results-label">' + window.i18n.t('swp.results') + '</div>';
            results.forEach(function(item) {
              var u = 'https://' + domain + '/wiki/' + encodeURIComponent(item.title);
              var snip = item.snippet ? item.snippet.replace(/<[^>]+>/g,'') : '';
              html += '<a class="swp-result-item" href="' + escapeHtml(u) + '" target="_blank" rel="noopener"><div class="swp-result-title">' + escapeHtml(item.title) + '</div>';
              if (snip) html += '<div class="swp-result-desc">' + escapeHtml(snip) + '</div></a>';
            });
            animateSearchResults(html);
          })
          .catch(function() { animateSearchResults('<div class="swp-empty">' + window.i18n.t('swp.failed') + '</div>'); });
      });
  }

  window.translateText = function() {
    if (!selectedText) { hideContextMenu(); return; }
    hideContextMenu();
    var src = selectedText, tpResult = $('tpResult');
    $('tpSrc').textContent = src.length > 120 ? src.slice(0,120) + '…' : src;
    openPanel('translatePanel');
    var doFetch = function() {
      var engine = localStorage.getItem('translateEngine') || 'google';
      $('tpPowered').textContent = engine === 'bing' ? 'Powered by Bing translation' : 'Powered by Google translation';
      var url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=' + $('tpSrcLang').value + '&tl=' + $('tpTgtLang').value + '&dt=t&q=' + encodeURIComponent(src);
      tpResult.innerHTML = '<div class="tp-loading">' + window.i18n.t('tp.loading') + '</div>';
      fetch(url)
        .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
        .then(function(data) {
          var result = '';
          if (data && data[0]) data[0].forEach(function(seg) { if (seg && seg[0]) result += seg[0]; });
          animateResults(tpResult, '<p class="tp-result-text">' + escapeHtml(result || window.i18n.t('tp.no_result')) + '</p>', false);
        })
        .catch(function() { animateResults(tpResult, '<div class="tp-error">' + window.i18n.t('tp.failed') + '</div>', false); });
    };
    $('tpSrcLang').onchange = doFetch; $('tpTgtLang').onchange = doFetch; doFetch();
  };

  function adjustOptionsScale() {
    var el = $('options'); if (!el || !el.classList.contains('show')) return;
    el.style.transform = 'translate(-50%, -50%) scale(1)';
    requestAnimationFrame(function() {
      var r = el.getBoundingClientRect();
      var margin = 16;
      var availH = window.innerHeight - margin * 2;
      if (r.height > availH) {
        var scale = availH / r.height;
        scale = Math.max(0.65, Math.min(0.98, scale));
        el.style.transform = 'translate(-50%, -50%) scale(' + scale + ')';
      } else {
        el.style.transform = '';
      }
    });
  }
  window.addEventListener('resize', adjustOptionsScale);

  function openPanel(id) {
    var el = $(id); if (!el) return;
    el.classList.remove('closing'); el.classList.add('show');
    if (id === 'options') {
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          adjustOptionsScale();
        });
      });
    }
  }
  function closePanel(id) {
    var el = $(id); if (!el || !el.classList.contains('show')) return;
    if (id === 'options' && !el.dataset.dragged) {
      el.style.transform = '';
    }
    if (el.dataset.dragged) {
      el.style.pointerEvents = 'none'; el.style.transition = 'opacity 0.25s cubic-bezier(0.4,0,1,1)';
      requestAnimationFrame(function() {
        el.style.opacity = '0';
        setTimeout(function() {
          el.classList.remove('show'); el.style.pointerEvents = ''; el.style.transition = ''; el.style.opacity = '';
          el.style.left = ''; el.style.top = ''; el.style.transform = ''; delete el.dataset.dragged;
        }, 280);
      });
    } else {
      el.classList.add('closing'); el.classList.remove('show');
      setTimeout(function() { el.classList.remove('closing'); }, 350);
    }
  }

  (function initDrag() {
    function makeDraggable(panelId, handleId) {
      var panel = $(panelId), handle = $(handleId); if (!panel || !handle) return;
      var isDragging = false, hasMoved = false, startX, startY, startLeft, startTop;
      function snapToPos() {
        var r = panel.getBoundingClientRect(); panel.style.transition = 'none';
        panel.style.left = r.left + 'px'; panel.style.top = r.top + 'px'; panel.style.transform = 'none';
        void panel.offsetWidth; panel.style.transition = '';
      }
      function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
      function tabBarMinTop() {
        if (document.body.classList.contains('tab-bar-mode')) return 56 + 16; /* タブバー高さ56px + 余白16px */
        return 8;
      }
      function onStart(cx, cy) {
        if (!panel.dataset.dragged) { snapToPos(); panel.dataset.dragged = '1'; }
        isDragging = true; hasMoved = false; startX = cx; startY = cy;
        startLeft = parseFloat(panel.style.left) || 0; startTop = parseFloat(panel.style.top) || 0;
        handle.style.cursor = 'grabbing';
      }
      function onMove(cx, cy) {
        if (!isDragging) return;
        var dx = cx - startX, dy = cy - startY;
        if (!hasMoved && Math.abs(dx) + Math.abs(dy) > 3) hasMoved = true;
        if (!hasMoved) return;
        panel.style.left = clamp(startLeft + dx, 8, window.innerWidth  - panel.offsetWidth  - 8) + 'px';
        panel.style.top  = clamp(startTop  + dy, tabBarMinTop(), window.innerHeight - panel.offsetHeight - 8) + 'px';
      }
      function onEnd() { if (!isDragging) return; isDragging = false; handle.style.cursor = ''; }
      new MutationObserver(function() {
        if (!panel.classList.contains('show') && !panel.classList.contains('closing')) {
          panel.style.left = ''; panel.style.top = ''; panel.style.transform = ''; delete panel.dataset.dragged;
        }
      }).observe(panel, { attributes: true, attributeFilter: ['class'] });
      handle.addEventListener('mousedown', function(e) {
        if (e.button !== 0 || ['BUTTON','SELECT','INPUT','LABEL'].indexOf(e.target.tagName) !== -1) return;
        e.preventDefault(); onStart(e.clientX, e.clientY);
      });
      document.addEventListener('mousemove', function(e) { onMove(e.clientX, e.clientY); });
      document.addEventListener('mouseup', onEnd);
      handle.addEventListener('touchstart', function(e) {
        if (['BUTTON','SELECT','INPUT','LABEL'].indexOf(e.target.tagName) !== -1) return;
        onStart(e.touches[0].clientX, e.touches[0].clientY);
      }, { passive: true });
      document.addEventListener('touchmove', function(e) { if (!isDragging) return; e.preventDefault(); onMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
      document.addEventListener('touchend', onEnd);
    }
    makeDraggable('options', 'optionsDragHandle');
    makeDraggable('translatePanel', 'translateDragHandle');
    makeDraggable('searchWebPanel', 'searchWebDragHandle');
    makeDraggable('searchPanel', 'searchPanelDragHandle');

    $('searchPanelCloseBtn').onclick = function() {
      state.isSearchOpen = false;
      closePanel('searchPanel');
      clearSearchHighlight();
      $('searchCount').textContent = '';
      updateTextareaPadding();
    };
    $('spPrevBtn').onclick = function() { doSearch(-1); };
    $('spNextBtn').onclick = function() { doSearch(1); };

    var headerMoveToggle = $('headerMoveToggle');
    headerMoveToggle.checked = localStorage.getItem('headerMoveEnabled') === 'true';
    state.headerMoveEnabled = headerMoveToggle.checked;
    var hdrEl = document.querySelector('header');
    if (hdrEl && !headerMoveToggle.checked) hdrEl.classList.add('no-move');
    headerMoveToggle.onchange = function() {
      state.headerMoveEnabled = headerMoveToggle.checked;
      localStorage.setItem('headerMoveEnabled', state.headerMoveEnabled);
      var h = document.querySelector('header');
      if (h) h.classList.toggle('no-move', !state.headerMoveEnabled);
    };

    var footerAlwaysToggle = $('footerAlwaysToggle');
    if (footerAlwaysToggle) {
      footerAlwaysToggle.checked = state.footerAlways;
      footerAlwaysToggle.onchange = function() {
        state.footerAlways = footerAlwaysToggle.checked;
        localStorage.setItem('footerAlways', state.footerAlways);
        render();
      };
    }

    (function() {
      var hdr = document.querySelector('header');
      var topBar = $('headerTopBar');
      var yellowBtn = $('headerYellowBtn');
      if (!hdr) return;

      var isDragging = false, didMove = false;
      /* 掴んだ瞬間のカーソルとヘッダー左上のオフセット差を記録 */
      var grabOffsetX = 0, grabOffsetY = 0;
      var hdrW = 0, hdrH = 0;

      function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
      function tabBarMinTop() {
        return document.body.classList.contains('tab-bar-mode') ? 56 + 16 : 8;
      }

      /* transition を一時停止してピクセル座標に固定 */
      function freezeHeader() {
        var r = hdr.getBoundingClientRect();
        hdr.style.transition = 'none';
        hdr.style.transform  = 'none';
        hdr.style.left = r.left + 'px';
        hdr.style.top  = r.top  + 'px';
        hdr.dataset.dragged = '1';
      }

      function onStart(cx, cy) {
        if (hdr.classList.contains('no-move')) return;
        /* 掴む瞬間に一度だけ座標を確定（リフローを最小化） */
        freezeHeader();
        hdrW = hdr.offsetWidth;
        hdrH = hdr.offsetHeight;
        grabOffsetX = cx - parseFloat(hdr.style.left);
        grabOffsetY = cy - parseFloat(hdr.style.top);
        isDragging = true;
        didMove    = false;
        hdr.classList.add('header-expanded');
        hdr.style.cursor = 'grabbing';
        hdr.style.userSelect = 'none';
      }

      function onMove(cx, cy) {
        if (!isDragging) return;
        didMove = true;
        /* 計算のみ・リフロー不要 */
        var newLeft = clamp(cx - grabOffsetX, 8, window.innerWidth  - hdrW - 8);
        var newTop  = clamp(cy - grabOffsetY, tabBarMinTop(), window.innerHeight - hdrH - 8);
        hdr.style.left = newLeft + 'px';
        hdr.style.top  = newTop  + 'px';
      }

      function onEnd() {
        if (!isDragging) return;
        isDragging = false;
        hdr.classList.remove('header-expanded');
        hdr.style.transition = '';
        hdr.style.cursor = 'grab';
        hdr.style.userSelect = '';
        /* ドラッグ後の誤クリックをキャンセル */
        if (didMove) {
          document.addEventListener('click', function cancelClick(e) {
            e.stopPropagation(); e.preventDefault();
            document.removeEventListener('click', cancelClick, true);
          }, true);
        }
      }

      /* ボタン等のインタラクティブ要素を除外 */
      function isInteractive(el) {
        while (el && el !== hdr) {
          var tag = el.tagName;
          if (tag === 'BUTTON' || tag === 'INPUT' || tag === 'SELECT' || tag === 'A') return true;
          el = el.parentElement;
        }
        return false;
      }

      hdr.style.cursor = 'grab';
      hdr.addEventListener('mousedown', function(e) {
        if (e.button !== 0 || isInteractive(e.target)) return;
        e.preventDefault();
        onStart(e.clientX, e.clientY);
      });
      document.addEventListener('mousemove', function(e) { onMove(e.clientX, e.clientY); });
      document.addEventListener('mouseup', onEnd);
      hdr.addEventListener('touchstart', function(e) {
        if (isInteractive(e.target)) return;
        onStart(e.touches[0].clientX, e.touches[0].clientY);
      }, { passive: true });
      document.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        onMove(e.touches[0].clientX, e.touches[0].clientY);
      }, { passive: false });
      document.addEventListener('touchend', onEnd);

      if (yellowBtn) {
        yellowBtn.onclick = function() {
          if (!hdr.dataset.dragged) return;
          var r = hdr.getBoundingClientRect();
          hdr.style.transition = 'none';
          hdr.style.left = r.left + 'px';
          hdr.style.top  = r.top  + 'px';
          hdr.style.transform = 'none';
          void hdr.offsetWidth;
          hdr.classList.add('returning');
          var defaultTop = document.body.classList.contains('tab-bar-mode') ? '68px' : '12px';
          hdr.style.left = '50%'; hdr.style.top = defaultTop;
          hdr.style.transform = 'translateX(-50%)';
          delete hdr.dataset.dragged;
          hdr.addEventListener('transitionend', function cleanup(e) {
            if (e.propertyName !== 'left' && e.propertyName !== 'top') return;
            hdr.removeEventListener('transitionend', cleanup);
            hdr.classList.remove('returning');
            hdr.style.left = ''; hdr.style.top = '';
            hdr.style.transform = ''; hdr.style.transition = '';
          });
        };
      }
    })();

    $('saveMetaCloseBtn').onclick = closeSaveMetaModal;
  })();

  var themeColors = [
    { color: '#c9a181', label: 'チタニウムデザート' },
    { color: '#c4bcad', label: 'チタニウムナチュラル' },
    { color: '#ecc9a6', label: 'ゴールド' },
    { color: '#f9c0b9', label: 'ゴールドローズ' },
  ];
  function applyAccentColor(color) {
    document.documentElement.style.setProperty('--accent', color);
    var hex = color.replace('#',''); if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    var r = parseInt(hex.substring(0,2),16), g = parseInt(hex.substring(2,4),16), b = parseInt(hex.substring(4,6),16);
    document.documentElement.style.setProperty('--accent-rgb', r+','+g+','+b);
    state.accentColor = color; localStorage.setItem('accentColor', color);
    document.querySelectorAll('.swatch').forEach(function(s) { s.classList.toggle('active', s.dataset.color === color); });
  }
  function applyStyles() {
    $('edit').style.fontFamily = $('fSel').value; $('edit').style.fontSize = $('sSel').value + 'px'; updateMirror();
  }

  var searchMatches = [], searchIndex = 0;
  function updateMirror() {
    var mirror = $('searchHighlightMirror'), edit = $('edit'); if (!mirror) return;
    mirror.style.fontFamily = edit.style.fontFamily || ''; mirror.style.fontSize = edit.style.fontSize || '18px';
    if (!state.isSearchOpen || !searchMatches.length) { mirror.innerHTML = ''; mirror.scrollTop = edit.scrollTop; return; }
    var query = $('searchInput').value; if (!query) { mirror.innerHTML = ''; return; }
    var text = edit.value, qLen = query.length, html = '', cursor = 0;
    searchMatches.forEach(function(pos, i) {
      html += escapeHtml(text.substring(cursor, pos));
      html += '<mark class="' + (i === searchIndex ? 'current' : '') + '">' + escapeHtml(text.substring(pos, pos + qLen)) + '</mark>';
      cursor = pos + qLen;
    });
    html += escapeHtml(text.substring(cursor));
    mirror.innerHTML = html; mirror.scrollTop = edit.scrollTop;
  }
  function doSearch(dir) {
    var query = $('searchInput').value, edit = $('edit'); searchMatches = [];
    if (!query) { $('searchCount').textContent = ''; updateMirror(); return; }
    var lText = edit.value.toLowerCase(), lQ = query.toLowerCase(), pos = 0;
    while ((pos = lText.indexOf(lQ, pos)) !== -1) { searchMatches.push(pos); pos += lQ.length; }
    if (!searchMatches.length) { $('searchCount').textContent = '0 / 0'; updateMirror(); return; }
    if      (dir ===  1) searchIndex = (searchIndex + 1) % searchMatches.length;
    else if (dir === -1) searchIndex = (searchIndex - 1 + searchMatches.length) % searchMatches.length;
    else                 searchIndex = 0;
    var matchPos = searchMatches[searchIndex];
    edit.setSelectionRange(matchPos, matchPos + query.length);
    var lh = parseFloat(getComputedStyle(edit).lineHeight) || 28;
    var ln = edit.value.substring(0, matchPos).split('\n').length - 1;
    var pt = parseInt(edit.style.paddingTop) || 80;
    edit.scrollTop = Math.max(0, ln * lh - (edit.clientHeight - pt) / 2);
    $('searchCount').textContent = (searchIndex + 1) + ' / ' + searchMatches.length;
    updateMirror();
  }
  function clearSearchHighlight() { searchMatches = []; searchIndex = 0; var m = $('searchHighlightMirror'); if (m) m.innerHTML = ''; }

  var autoSaveTimer = null, autoSaveIsInterval = false;
  var AUTO_SAVE_INTERVAL = 2 * 60 * 1000;
  function clearAutoSaveTimer() {
    if (autoSaveTimer === null) return;
    if (autoSaveIsInterval) clearInterval(autoSaveTimer); else clearTimeout(autoSaveTimer);
    autoSaveTimer = null; autoSaveIsInterval = false;
  }
  function doAutoSave() {
    if (!state.autoSave) return;
    /* ファイルエディタ中は自動保存をスキップ（仮ページを永続化しない） */
    if (window.folderFileActive) return;
    localStorage.setItem('autosave_text', $('edit').value);
    localStorage.setItem('autosave_file', state.curFile);
    localStorage.setItem('autosave_font', $('fSel') ? $('fSel').value : 'Arial');
    localStorage.setItem('autosave_size', $('sSel') ? $('sSel').value : '18');
    /* PBKDF2暗号化保存も自動保存と同タイミングで実施 */
    saveCurrentPage();
    var locale = (window.i18n.lang() === 'en') ? 'en-US' : 'ja-JP';
    queueToast(window.i18n.t('toast.autosave_prefix') + new Date().toLocaleTimeString(locale,{hour:'2-digit',minute:'2-digit'}), 2000);
  }
  function scheduleAutoSave() {
    if (!state.autoSave) return; clearAutoSaveTimer(); autoSaveIsInterval = false;
    autoSaveTimer = setTimeout(function() { doAutoSave(); autoSaveIsInterval = true; autoSaveTimer = setInterval(doAutoSave, AUTO_SAVE_INTERVAL); }, AUTO_SAVE_INTERVAL);
  }
  window.addEventListener('beforeunload', function() { if (state.autoSave) doAutoSave(); });

  var PAGES_KEY = 'np26_pages', PAGES_CUR = 'np26_cur_page', MAX_PAGES = 10;
  function genPageId() { return 'p' + Date.now() + Math.random().toString(36).slice(2,6); }
  function loadPages() {
    try {
      var raw = localStorage.getItem(PAGES_KEY);
      if (raw) {
        var arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.length) {
          arr.forEach(function(p) { if (p.titleLocked === undefined) p.titleLocked = false; });
          return arr;
        }
      }
    } catch(e) {}
    return [{ id: genPageId(), title: 'ページ 1', text: '', font: 'Arial', size: 18, titleLocked: false }];
  }
  function savePages() {
    try {
      if (CryptoEngine.isEnabled() && sessionPassword) {
        CryptoEngine.encryptPages(pages, sessionPassword).catch(function(e) { console.error('暗号化保存失敗:', e); });
      } else {
        localStorage.setItem(PAGES_KEY, JSON.stringify(pages));
      }
    } catch(e) {}
  }
  function getCurrentPageIdx() {
    var savedId = localStorage.getItem(PAGES_CUR);
    if (savedId) { var idx = pages.findIndex(function(p) { return p.id === savedId; }); if (idx !== -1) return idx; }
    return 0;
  }
  var pages = loadPages(), curPageIdx = getCurrentPageIdx();
  setTimeout(function() {
    if (window.penSetInitialPage && pages[curPageIdx]) {
      window.penSetInitialPage(pages[curPageIdx].id);
    }
  }, 0);

  function saveCurrentPage() {
    if (!pages[curPageIdx]) return;
    var edit = $('edit'), fSel = $('fSel'), sSel = $('sSel');
    pages[curPageIdx].text = edit ? edit.value : '';
    pages[curPageIdx].font = fSel ? fSel.value : 'Arial';
    pages[curPageIdx].size = sSel ? parseInt(sSel.value) : 18;
    /* 仮ページ（ファイルエディタ用）は localStorage に保存しない */
    if (pages[curPageIdx]._fileEditor) return;
    savePages();
  }
  function switchPage(idx) {
    if (titleEditMode) commitTitleEdit();
    if (idx === curPageIdx) return;
    /* 仮ページ（ファイルエディタ）への直接移動は禁止 */
    if (pages[idx] && pages[idx]._fileEditor) return;
    if (window.folderFileActive) { queueToast(window.i18n.t('toast.page_blocked_fileeditor'), 2200); return; }
    var edit = $('edit'), dir = idx > curPageIdx ? 'right' : 'left';
    var fromId = pages[curPageIdx] ? pages[curPageIdx].id : null;
    var penSlideIn = window.penPageSwitch ? window.penPageSwitch(fromId, pages[idx].id, dir) : null;
    saveCurrentPage();
    curPageIdx = idx; localStorage.setItem(PAGES_CUR, pages[curPageIdx].id);
    var p = pages[curPageIdx], fSel = $('fSel'), sSel = $('sSel');
    edit.value = p.text || '';
    for (var i = 0; i < fSel.options.length; i++) { if (fSel.options[i].value === p.font) { fSel.selectedIndex = i; break; } }
    sSel.value = String(p.size || 18); applyStyles(); ActionHandlers.updateText(edit.value); render(); renderPageList();
    requestAnimationFrame(function() { updatePageIndicator(true); });
    slidePageIn(edit);
    if (penSlideIn) penSlideIn();
  }
  window.addPage = function() {
    if (window.folderFileActive) { queueToast(window.i18n.t('toast.page_add_blocked_fileeditor'), 2000); return; }
    var realCount = pages.filter(function(p){return !p._fileEditor;}).length;
    if (realCount >= MAX_PAGES) { queueToast(window.i18n.t('toast.page_max_prefix') + MAX_PAGES + window.i18n.t('toast.page_max_suffix'), 2000); return; }
    var edit = $('edit');
    var fromId = pages[curPageIdx] ? pages[curPageIdx].id : null;
    var newId  = genPageId();
    var penSlideIn = window.penPageSwitch ? window.penPageSwitch(fromId, newId, 'right') : null;
    saveCurrentPage();
    var np = { id: newId, title: window.i18n.t('page.default') + (pages.length + 1), text: '', font: $('fSel').value || 'Arial', size: parseInt($('sSel').value) || 18, titleLocked: false };
    pages.push(np); curPageIdx = pages.length - 1; localStorage.setItem(PAGES_CUR, np.id);
    edit.value = ''; ActionHandlers.updateText(''); savePages(); render(); renderPageList();
    requestAnimationFrame(function() { updatePageIndicator(true); });
    slidePageIn(edit);
    if (penSlideIn) penSlideIn();
  };
  window.deletePage = function(idx, e) {
  e.stopPropagation();
  if (pages[idx] && pages[idx]._fileEditor) return;
  var realCount = pages.filter(function(p){ return !p._fileEditor; }).length;
  if (realCount <= 1) {
    queueToast(window.i18n.t('toast.page_last_delete_blocked'), 2000);
    return;
  }

  // --- Animate Tab Bar ---
  var tabBar = document.getElementById('pageTabBar');
  var tabs = Array.from(tabBar.children);
  var tabToRemove = tabs[idx];
  var firstRects = tabs.map(tab => tab.getBoundingClientRect());

  var animDuration = 0.32; // Close duration
  var animEase = 'cubic-bezier(0.45, 0, 0.55, 1)'; // slow→fast→slow

  tabToRemove.style.transition = `opacity ${animDuration}s ${animEase}, transform ${animDuration}s ${animEase}, max-width ${animDuration}s ${animEase}, padding ${animDuration}s ${animEase}, border ${animDuration}s ${animEase}`;
  tabToRemove.style.opacity = '0';
  tabToRemove.style.transform = 'scale(0.8)';
  tabToRemove.style.maxWidth = '0px';
  tabToRemove.style.paddingLeft = '0';
  tabToRemove.style.paddingRight = '0';
  tabToRemove.style.border = 'none';

  // --- Animate Side Panel List Item ---
  var pageList = document.getElementById('pageList');
  var cardToRemove = pageList.children[idx];
  if (cardToRemove) {
      cardToRemove.style.transition = `opacity ${animDuration}s ${animEase}, transform ${animDuration}s ${animEase}, max-height ${animDuration}s ${animEase}, margin ${animDuration}s ${animEase}, padding ${animDuration}s ${animEase}, border ${animDuration}s ${animEase}`;
      cardToRemove.style.opacity = '0';
      cardToRemove.style.transform = 'scale(0.8)';
      cardToRemove.style.maxHeight = '0px';
      cardToRemove.style.margin = '0';
      cardToRemove.style.padding = '0';
      cardToRemove.style.border = 'none';
  }

  requestAnimationFrame(() => {
    // Update data model and re-render
    var deletedId = pages[idx].id;
    var wasCurrentPage = (idx === curPageIdx);
    var fromId = wasCurrentPage ? deletedId : null;

    pages.splice(idx, 1);
    if (idx < curPageIdx) curPageIdx--;
    if (curPageIdx >= pages.length) curPageIdx = pages.length - 1;
    localStorage.setItem(PAGES_CUR, pages[curPageIdx].id);

    var p = pages[curPageIdx], edit = $('edit');
    var penSlideIn = (wasCurrentPage && window.penPageSwitch)
      ? window.penPageSwitch(fromId, pages[curPageIdx].id, 'left')
      : null;

    edit.value = p.text || '';
    $('fSel').value = p.font || 'Arial';
    $('sSel').value = String(p.size || 18);

    applyStyles();
    ActionHandlers.updateText(edit.value);
    savePages();
    render(); // This re-renders the tabBar
    renderPageList();
    if (penSlideIn) penSlideIn();

    // --- Animate remaining tabs (FLIP) ---
    var newTabs = Array.from(document.getElementById('pageTabBar').children);
    var lastRects = newTabs.map(tab => tab.getBoundingClientRect());

    newTabs.forEach((tab, i) => {
      var firstIdx = i < idx ? i : i + 1;
      var firstRect = firstRects[firstIdx];
      var lastRect = lastRects[i];

      var deltaX = firstRect.left - lastRect.left;
      var deltaY = firstRect.top - lastRect.top;

      if (deltaX !== 0 || deltaY !== 0) {
        tab.style.transition = 'none';
        tab.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
        tab.getBoundingClientRect(); // Reflow
        tab.style.transition = `transform ${animDuration}s ${animEase}`;
        tab.style.transform = 'translate(0, 0)';
      }
    });

    // Clean up styles
    setTimeout(() => {
      newTabs.forEach(tab => {
        tab.style.transition = '';
        tab.style.transform = '';
      });
    }, animDuration * 1000);

  });
};

  var titleEditMode = false;
  function openTitleEdit() {
    if (titleEditMode) { closeTitleEdit(false); return; }
    titleEditMode = true;
    var list = $('pageList'), inputs = list.querySelectorAll('.page-title-edit-input');
    inputs.forEach(function(inp, i) { inp.value = pages[i].title || (window.i18n.t('page.default') + (i + 1)); });
    list.classList.add('editing');
    var btn = document.querySelector('.pph-edit');
    if (btn) { btn.textContent = '✕'; btn.style.transform = ''; btn.style.background = 'rgba(229,57,53,0.18)'; btn.style.color = '#e57373'; }
    setTimeout(function() { if (inputs[curPageIdx]) { inputs[curPageIdx].focus(); inputs[curPageIdx].select(); } }, 50);
  }
  function resetEditBtn() {
    var btn = document.querySelector('.pph-edit');
    if (btn) { btn.textContent = '✎'; btn.style.transform = 'scaleX(-1)'; btn.style.background = ''; btn.style.color = ''; }
  }
  function commitTitleEdit() {
    if (!titleEditMode) return;
    var list = $('pageList'), inputs = list.querySelectorAll('.page-title-edit-input');
    inputs.forEach(function(inp, i) {
      var edited = inp.value.trim().slice(0, 20);
      pages[i].title       = edited || (window.i18n.t('page.default') + (i + 1));
      pages[i].titleLocked = edited.length > 0; /* 入力があればロック */
    });
    savePages(); titleEditMode = false; list.classList.remove('editing'); resetEditBtn(); render();
    setTimeout(function() { renderPageList(); }, 240);
  }
  function cancelTitleEdit() {
    if (!titleEditMode) return;
    titleEditMode = false; $('pageList').classList.remove('editing'); resetEditBtn();
    setTimeout(function() { renderPageList(); }, 240);
  }
  function closeTitleEdit(save) { if (save) commitTitleEdit(); else cancelTitleEdit(); }
  
  function renderPageList() {
    var list = $('pageList'); if (!list) return;
    list.innerHTML = '';
    /* 仮ページ（ファイルエディタ用）はページ一覧から除外して表示 */
    var displayNum = 0;
    pages.forEach(function(p, i) {
      if (p._fileEditor) return;
      displayNum++;
      var card = document.createElement('div');
      card.className = 'page-card' + (i === curPageIdx ? ' active' : '');
      card.onclick = function() { switchPage(i); };
      var num = document.createElement('div'); num.className = 'page-num'; num.textContent = String(displayNum);
      var info = document.createElement('div'); info.className = 'page-info';
      var titleEl = document.createElement('div'); titleEl.className = 'page-title-text'; titleEl.textContent = p.title || (window.i18n.t('page.default') + (i+1));
      var preview = document.createElement('div'); preview.className = 'page-preview';
      preview.textContent = (p.text || '').replace(/\n/g,' ').trim().slice(0,40) || window.i18n.t('pp.empty');
      info.appendChild(titleEl); info.appendChild(preview);
      var del = document.createElement('button'); del.className = 'page-del'; del.textContent = '✕';
      del.onclick = function(e) { deletePage(i, e); };
      var inp = document.createElement('input'); inp.type = 'text'; inp.className = 'page-title-edit-input'; inp.maxLength = 20;
      inp.value = p.title || (window.i18n.t('page.default') + (i+1)); inp.placeholder = window.i18n.t('page.placeholder');
      inp.onclick = function(e) { e.stopPropagation(); };
      (function(pageIdx, inputEl) {
        inputEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter')  { e.preventDefault(); commitTitleEdit(); }
          if (e.key === 'Escape') { cancelTitleEdit(); }
          e.stopPropagation();
        });
      })(i, inp);
      card.appendChild(num); card.appendChild(info); card.appendChild(del); card.appendChild(inp);
      list.appendChild(card);
    });
    var realCount = pages.filter(function(p){return !p._fileEditor;}).length;
    var msg = $('pageMaxMsg'); if (msg) msg.textContent = realCount >= MAX_PAGES ? window.i18n.t('pagemax.msg').replace('MAX', MAX_PAGES) : '';
    updatePageIndicator(false);
    /* タブバーモード時はタブも更新 */
    if (window.renderPageTabs) window.renderPageTabs();
  }
  function updatePageIndicator(animate) {
    var indicator = $('pageNumIndicator'), list = $('pageList'); if (!indicator || !list) return;
    var cards = list.querySelectorAll('.page-card'); if (!cards[curPageIdx]) return;
    var top = cards[curPageIdx].offsetTop;
    if (!animate) {
      indicator.style.transition = 'none'; indicator.style.top = top + 'px'; indicator.style.opacity = '1';
      requestAnimationFrame(function() { indicator.style.transition = ''; });
    } else { indicator.style.top = top + 'px'; indicator.style.opacity = '1'; }
  }

  /* ===== ページタブバー描画 ===== */
  /* ===== タブバー アニメーション付き描画 ===== */
  var _tabAddPending = false;

  /* ===== タブバー描画（ラッパー方式）===== */
  window.renderPageTabs = function() {
    /* ファイルエディタ起動中はファイルタブを表示 */
    if (window.folderFileActive && window.renderFolderTabs) {
      window.renderFolderTabs();
      return;
    }
    var bar = $('pageTabBar'); if (!bar || !bar.classList.contains('active')) return;
    var doAddAnim = _tabAddPending;
    _tabAddPending = false;

    bar.innerHTML = '';
    pages.forEach(function(p, i) {
      if (p._fileEditor) return;
      var isNew = doAddAnim && (i === curPageIdx);

      var wrap = document.createElement('div');
      wrap.className = 'page-tab-wrap';
      wrap.dataset.wrapIdx = String(i);

      var tab = document.createElement('button');
      tab.className = 'page-tab' + (i === curPageIdx ? ' active' : '');
      tab.dataset.pageIdx = String(i);

      var nameSpan = document.createElement('span');
      nameSpan.className = 'page-tab-name';
      nameSpan.textContent = (p.title || (window.i18n.t('page.default') + (i + 1))).slice(0, 18);

      var closeBtn = document.createElement('button');
      closeBtn.className = 'page-tab-close';
      closeBtn.innerHTML = '&#x2715;';
      closeBtn.title = 'ページを削除';
      closeBtn.addEventListener('click', function(e) { deletePage(i, e); });

      tab.appendChild(nameSpan);
      tab.appendChild(closeBtn);
      tab.addEventListener('click', function() { switchPage(i); });
      wrap.appendChild(tab);
      if (isNew) {
        wrap.classList.add('tab-add-enter');
      }
      bar.appendChild(wrap);
    });

    var addBtn = document.createElement('button');
    addBtn.id = 'pageTabAddBtn';
    addBtn.textContent = '+';
    addBtn.title = 'ページを追加';
    addBtn.addEventListener('click', function() { addPage(); });
    bar.appendChild(addBtn);

    if (doAddAnim) {
      var newWrap = bar.querySelector('.tab-add-enter');
      if (newWrap) {
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            newWrap.classList.remove('tab-add-enter');
            newWrap.classList.add('tab-add-active');
            newWrap.querySelector('.page-tab').addEventListener('transitionend', function onDone(ev) {
              if (ev.propertyName !== 'transform') return;
              newWrap.classList.remove('tab-add-active');
              newWrap.querySelector('.page-tab').removeEventListener('transitionend', onDone);
            });
          });
        });
      }
    }

    /* 削除後の再描画時 — インジケーターをフェードイン */
    if (bar.classList.contains('hide-indicators')) {
      /* 次フレームで hide を外してフェードイン */
      requestAnimationFrame(function() {
        bar.classList.remove('hide-indicators');
      });
    }

    requestAnimationFrame(function() {
      var activeEl = bar.querySelector('.page-tab.active');
      if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    });
  };

  /* ===== タブバー切り替えアニメーション (ページ↔ファイル) ===== */
  window.animateTabSwitch = function(renderFn) {
    var bar = $('pageTabBar');
    if (!bar || !bar.classList.contains('active')) { if (renderFn) renderFn(); return; }
    /* フェーズ1: 現タブを上へスライドアウト */
    bar.style.transition = 'transform 0.18s cubic-bezier(0.55,0,1,0.45), opacity 0.14s ease';
    bar.style.transform  = 'translateY(-100%)';
    bar.style.opacity    = '0';
    setTimeout(function() {
      /* フェーズ2: 新コンテンツを描画（まだ上に隠れた状態） */
      if (renderFn) renderFn();
      bar.style.transition = 'none';
      bar.style.transform  = 'translateY(-100%)';
      bar.style.opacity    = '0';
      bar.offsetWidth; /* reflow */
      /* フェーズ3: 上から下へスライドイン */
      bar.style.transition = 'transform 0.40s cubic-bezier(0.34,1.28,0.64,1), opacity 0.28s ease';
      bar.style.transform  = 'translateY(0)';
      bar.style.opacity    = '1';
      setTimeout(function() {
        bar.style.transition = '';
        bar.style.transform  = '';
        bar.style.opacity    = '';
      }, 430);
    }, 210);
  };

  /* addPage ラッパー：+ボタンを先にアニメしてからタブ追加 */
  (function() {
    var origAdd = window.addPage;
    window.addPage = function() {
      var bar = $('pageTabBar');
      if (!bar || !bar.classList.contains('active')) {
        /* タブバーモードでなければ即実行 */
        origAdd();
        return;
      }
      var existingAddBtn = bar.querySelector('#pageTabAddBtn');
      if (!existingAddBtn) { origAdd(); return; }

      /* タブ1枚分の幅を推定（min-width 90px + gap 6px） */
      var ANIM_DUR = 320; /* ms */
      var SLIDE_PX = 96;

      /* +ボタンを右へスライド */
      existingAddBtn.style.transition = 'none';
      existingAddBtn.getBoundingClientRect();
      existingAddBtn.style.transition = 'transform ' + ANIM_DUR + 'ms cubic-bezier(0.45,0,0.55,1)';
      existingAddBtn.style.transform  = 'translateX(' + SLIDE_PX + 'px)';

      /* アニメ完了後にタブを追加 */
      setTimeout(function() {
        _tabAddPending = true;
        origAdd();
      }, ANIM_DUR);
    };
  })();

  /* ===== タブ名ポップアップ編集 ===== */
  (function() {
    var popup   = $('tabNamePopup');
    var input   = $('tabNamePopupInput');
    var editBtn = $('pageTabEditBtn');
    var _targetIdx = -1;
    var _popupOpen = false;

    function openPopup(tabEl, pageIdx) {
      if (!popup || !input) return;
      _targetIdx = pageIdx;
      _popupOpen = true;

      /* ポップアップ位置：タブの真下 */
      var rect = tabEl.getBoundingClientRect();
      var popW = 210;
      var left = Math.min(rect.left, window.innerWidth - popW - 12);
      popup.style.left = Math.max(8, left) + 'px';
      popup.style.top  = (rect.bottom + 6) + 'px';

      input.value = (pages[pageIdx] && pages[pageIdx].title) || (window.i18n.t('page.default') + (pageIdx + 1));
      popup.classList.add('open');
      /* animation restart */
      popup.style.animation = 'none';
      popup.getBoundingClientRect();
      popup.style.animation = '';
      setTimeout(function() { input.focus(); input.select(); }, 20);

      /* ✎→✕ */
      if (editBtn) {
        editBtn.textContent = '✕';
        editBtn.style.transform = '';
        editBtn.classList.add('editing');
      }
    }

    function commitPopup() {
      if (!_popupOpen) return;
      var val = input.value.trim().slice(0, 20);
      if (_targetIdx >= 0 && pages[_targetIdx]) {
        pages[_targetIdx].title       = val || (window.i18n.t('page.default') + (_targetIdx + 1));
        pages[_targetIdx].titleLocked = val.length > 0;
        savePages();
        /* タブ名を即更新 */
        var bar = $('pageTabBar');
        if (bar) {
          var nameEl = bar.querySelector('[data-page-idx="' + _targetIdx + '"] .page-tab-name');
          if (nameEl) nameEl.textContent = pages[_targetIdx].title.slice(0, 18);
        }
        /* ページパネルのリストも同期 */
        renderPageList();
        /* フッターバー（下部バー）も即時更新 */
        render();
      }
      closePopup();
    }

    function closePopup() {
      if (!popup) return;
      _popupOpen = false;
      _targetIdx = -1;
      popup.classList.remove('open');
      if (editBtn) {
        editBtn.textContent = '✎';
        editBtn.style.transform = 'scaleX(-1)';
        editBtn.classList.remove('editing');
      }
    }

    if (input) {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter')  { e.preventDefault(); commitPopup(); }
        if (e.key === 'Escape') { e.preventDefault(); closePopup(); }
        e.stopPropagation();
      });
      /* blur では閉じない：Enter / Escape / 鉛筆ボタンのみで終了 */
    }

    /* 編集ボタン：ポップアップのトグル */
    if (editBtn) {
      editBtn.addEventListener('click', function() {
        if (_popupOpen) { commitPopup(); return; }
        var bar = $('pageTabBar'); if (!bar) return;
        var activeTab = bar.querySelector('.page-tab.active'); if (!activeTab) return;
        var idx = parseInt(activeTab.dataset.pageIdx);
        if (!isNaN(idx)) openPopup(activeTab, idx);
      });
    }

    /* 外クリックでは閉じない：Enter / Escape / 鉛筆ボタンのみで終了 */

    /* 外部から名前更新されたらタブも更新（ページパネル側の編集対応） */
    window._syncTabName = function(idx) {
      var bar = $('pageTabBar'); if (!bar) return;
      var nameEl = bar.querySelector('[data-page-idx="' + idx + '"] .page-tab-name');
      if (nameEl && pages[idx]) nameEl.textContent = (pages[idx].title || (window.i18n.t('page.default') + (idx + 1))).slice(0, 18);
    };
  })();

  /* switchPage をラップしてタブバーのアクティブ状態を同期 */
  (function() {
    var origSwitch = switchPage;
    switchPage = function(idx) {
      origSwitch(idx);
      if (document.body.classList.contains('tab-bar-mode')) {
        var bar = $('pageTabBar');
        if (bar) {
          bar.querySelectorAll('.page-tab').forEach(function(t) {
            var ti = parseInt(t.dataset.pageIdx);
            t.classList.toggle('active', ti === idx);
          });
          var activeTab = bar.querySelector('.page-tab.active');
          if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
    };
  })();

  /* ===== ページナビモード適用 ===== */
  window.applyPageNavMode = function(mode) {
    var tabBar     = $('pageTabBar');
    var pullTab    = $('pagePullTab');
    var swipeTrig  = $('pageSwipeTrigger');
    var hdrPageBtn = $('headerPageBtn');
    var slideBtn   = $('pageNavSlideBtn');
    var tabBtn     = $('pageNavTabBtn');
    if (mode === 'tabbar') {
      tabBar.classList.add('active');
      window.renderPageTabs();
      /* 上からスライドイン (transform: translateY(-100%) → 0) */
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          tabBar.classList.add('tab-slide-in');
        });
      });
      document.body.classList.add('tab-bar-mode');
      if (pullTab)   { pullTab.style.display = 'none'; pullTab.classList.remove('visible','panel-open'); }
      if (swipeTrig) swipeTrig.style.display = 'none';
      if (hdrPageBtn) hdrPageBtn.classList.remove('visible');
      if (slideBtn)  slideBtn.classList.remove('active');
      if (tabBtn)    tabBtn.classList.add('active');
      if (pagePanelOpen) closePagePanel();
      var editBtn = $('pageTabEditBtn'); if (editBtn) editBtn.classList.add('active-mode');
    } else {
      /* スライドアウト後に非表示 */
      tabBar.classList.remove('tab-slide-in');
      document.body.classList.remove('tab-bar-mode');
      var onEnd = function() {
        tabBar.removeEventListener('transitionend', onEnd);
        tabBar.classList.remove('active');
      };
      tabBar.addEventListener('transitionend', onEnd);
      if (pullTab)   { pullTab.style.display = ''; }
      if (swipeTrig) swipeTrig.style.display = '';
      var pageBarToggle = $('pageBarToggle');
      if (hdrPageBtn && pageBarToggle && pageBarToggle.checked) hdrPageBtn.classList.add('visible');
      if (slideBtn) slideBtn.classList.add('active');
      if (tabBtn)   tabBtn.classList.remove('active');
      var editBtn2 = $('pageTabEditBtn'); if (editBtn2) editBtn2.classList.remove('active-mode','editing');
    }
  };

  var pagePanelOpen = false;
  function openPagePanel() {
    if (pagePanelOpen) return;
    /* ファイルエディタ中はページウィンドウを開かない（全ルート共通ガード） */
    if (window.folderFileActive) { queueToast(window.i18n.t('toast.page_blocked_fileeditor'), 2200); return; }
    pagePanelOpen = true;
    renderPageList(); $('pagePanel').classList.add('open'); $('pageOverlay').classList.add('open');
    var tab = $('pagePullTab'); if (tab) { tab.classList.remove('visible'); tab.classList.add('panel-open'); }
  }
  window.closePagePanel = function() {
    if (!pagePanelOpen) return; pagePanelOpen = false;
    $('pagePanel').classList.remove('open'); $('pageOverlay').classList.remove('open');
    var tab = $('pagePullTab'); if (tab) { tab.classList.remove('panel-open'); }
  };
  /* ページパネル: ウィンドウ外にマウスが行っても閉じない (mouseleave廃止) */

  (function initSwipe() {
    var panel = $('pagePanel'), overlay = $('pageOverlay');
    var EDGE = 32, THRESH = 60, touching = false, startX = 0, startY = 0, startedFromEdge = false, panelW = 0;
    document.addEventListener('touchstart', function(e) {
      var t = e.touches[0]; startX = t.clientX; startY = t.clientY;
      panelW = panel.offsetWidth; startedFromEdge = false; touching = false;
      if (!pagePanelOpen && window.innerWidth - startX < EDGE) { startedFromEdge = true; touching = true; }
      else if (pagePanelOpen) { touching = true; }
    }, { passive: true });
    document.addEventListener('touchmove', function(e) {
      if (!touching) return;
      var t = e.touches[0], dx = startX - t.clientX, dy = Math.abs(t.clientY - startY);
      if (!startedFromEdge && dy > Math.abs(dx) * 1.5) { touching = false; return; }
      var GAP = 20;
      if (!pagePanelOpen && startedFromEdge) {
        var open = Math.min(dx > 0 ? 0 : Math.abs(dx), panelW);
        var tx = Math.max(0, panelW + GAP - open);
        panel.classList.add('dragging'); overlay.classList.add('dragging');
        panel.style.transform = 'translateX(' + tx + 'px)';
        overlay.style.background = 'rgba(0,0,0,' + (0.38 * open / panelW) + ')';
        overlay.style.pointerEvents = 'auto';
      } else if (pagePanelOpen && dx > 0) {
        var tx2 = Math.min(dx, panelW + GAP);
        panel.classList.add('dragging'); overlay.classList.add('dragging');
        panel.style.transform = 'translateX(' + tx2 + 'px)';
        overlay.style.background = 'rgba(0,0,0,' + (0.38 * Math.max(0, 1 - tx2/panelW)) + ')';
      }
    }, { passive: true });
    document.addEventListener('touchend', function(e) {
      if (!touching) return; touching = false;
      panel.classList.remove('dragging'); overlay.classList.remove('dragging');
      panel.style.transform = ''; overlay.style.background = ''; overlay.style.pointerEvents = '';
      var dx = startX - e.changedTouches[0].clientX;
      if (!pagePanelOpen && startedFromEdge && dx > THRESH) openPagePanel();
      else if (pagePanelOpen && dx > THRESH) closePagePanel();
      startedFromEdge = false;
    }, { passive: true });
    /* 右端近接でpagePullTabを出現、離れたら非表示 */
    var trigger = $('pageSwipeTrigger');
    if (trigger) {
      trigger.addEventListener('mouseenter', function() {
        if (pagePanelOpen) return;
        var tab = $('pagePullTab'); if (tab) tab.classList.add('visible');
      });
      trigger.addEventListener('mouseleave', function() {
        var tab = $('pagePullTab');
        if (tab && !tab.matches(':hover')) tab.classList.remove('visible');
      });
    }
    /* タブ自体からmouseleaveしたら非表示 */
    var pageTab = $('pagePullTab');
    if (pageTab) {
      pageTab.addEventListener('click', function() { openPagePanel(); });
      pageTab.addEventListener('mouseleave', function() { pageTab.classList.remove('visible'); });
    }
  })();

  /* ========================================================
     フォルダパネル機能（ページパネルと同等の動作）
     File System Access API (showDirectoryPicker) を使用
     Chrome / Edge 対応。Firefox / Safari は非対応。
  ======================================================== */
  (function initFolderPanel() {
    var SUPPORTED_EXTS = ['txt','html','htm','json','md','css','js','xml','csv'];
    var folderPanelOpen = false;
    var dirHandle   = null;
    var fileHandles = [];
    var activeIdx   = -1;
    var isWritable  = false;
    var hasUnsaved  = false;

    /* ファイル表示中かどうかをグローバルに公開（switchPage の被り防止に使用） */
    window.folderFileActive = false;

    var panel      = $('folderPanel');
    var overlay    = $('folderOverlay');
    var fileList   = $('folderFileList');
    var titleEl    = $('folderPanelTitle');
    var writeStatus= $('folderWriteStatus');
    var writeText  = $('folderWriteStatusText');
    var openBtn    = $('folderOpenBtn');
    var refreshBtn = $('folderRefreshBtn');

    window.openFolderPanel = function() {
      if (folderPanelOpen) return;
      folderPanelOpen = true;
      var tab = $('folderPullTab'); if (tab) { tab.classList.remove('visible'); tab.classList.add('panel-open'); }
      panel.classList.add('open');
      overlay.classList.add('open');
    };
    window.closeFolderPanel = function() {
      if (!folderPanelOpen) return;
      folderPanelOpen = false;
      var tab = $('folderPullTab'); if (tab) { tab.classList.remove('panel-open'); }
      panel.classList.remove('open');
      overlay.classList.remove('open');
      /* フォルダ名ロック解除してデフォルトタイトルに戻す */
      if (titleEl) { delete titleEl.dataset.i18nLocked; titleEl.textContent = window.i18n.t('folder.title'); }
    };

    /* --- ファイルサイズ整形 --- */
    function fmtSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    /* --- 拡張子クラス --- */
    function extClass(ext) {
      var map = { txt:'ext-txt', html:'ext-html', htm:'ext-html', json:'ext-json',
                  md:'ext-md', css:'ext-css', js:'ext-js', xml:'ext-xml', csv:'ext-csv' };
      return map[ext] || '';
    }

    /* --- 書き込み権限チェック --- */
    async function checkWritable(handle) {
      try {
        var perm = await handle.queryPermission({ mode: 'readwrite' });
        if (perm === 'granted') return true;
        perm = await handle.requestPermission({ mode: 'readwrite' });
        return perm === 'granted';
      } catch(e) { return false; }
    }

    /* --- ステータスバー更新（アニメーション付き） --- */
    function updateWriteStatus() {
      var newClass = isWritable ? 'writable' : '';
      var newText  = isWritable ? window.i18n.t('folder.writable') : window.i18n.t('folder.readonly');
      if (writeStatus.className === newClass && writeText.textContent === newText) return;

      var prevWritable = writeStatus.classList.contains('writable');
      var becomingWritable = isWritable && !prevWritable;

      /* テキストをスライドインさせる */
      writeText.classList.remove('ws-text-anim');
      void writeText.offsetWidth;
      writeText.textContent = newText;
      writeText.classList.add('ws-text-anim');
      writeStatus.className = newClass;
      setTimeout(function() { writeText.classList.remove('ws-text-anim'); }, 400);

      /* 読み取り専用 → 書き込み可能のときだけアンロックアニメーション */
      if (becomingWritable) {
        writeStatus.classList.add('ws-unlocking');
        var dot = writeStatus.querySelector('.ws-dot');
        if (dot) {
          dot.style.position = 'relative';
          var ripple = document.createElement('span');
          ripple.className = 'ws-ripple';
          dot.appendChild(ripple);
          setTimeout(function() {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
          }, 600);
        }
        setTimeout(function() { writeStatus.classList.remove('ws-unlocking'); }, 650);
      }
    }

    /* --- ファイルリスト描画 --- */
    function renderFileList() {
      if (!fileHandles.length) {
        fileList.innerHTML = '<div class="folder-empty">' + window.i18n.t('folder.no_files') + '</div>';
        return;
      }
      fileList.innerHTML = '';
      fileHandles.forEach(function(f, i) {
        var item = document.createElement('div');
        item.className = 'folder-file-item' + (i === activeIdx ? ' active' : '');
        if (i === activeIdx) item.dataset.active = 'true';
        else delete item.dataset.active;

        var extBadge = document.createElement('div');
        extBadge.className = 'ffi-ext ' + extClass(f.ext);
        extBadge.textContent = f.ext.toUpperCase();

        var info = document.createElement('div');
        info.className = 'ffi-info';
        var nameEl = document.createElement('div');
        nameEl.className = 'ffi-name';
        nameEl.textContent = f.name;
        var sizeEl = document.createElement('div');
        sizeEl.className = 'ffi-size';
        sizeEl.textContent = f.size !== undefined ? fmtSize(f.size) : '';
        info.appendChild(nameEl);
        info.appendChild(sizeEl);

        var saveBtn = document.createElement('button');
        saveBtn.className = 'ffi-save-btn' + (hasUnsaved && i === activeIdx ? ' unsaved' : '');
        saveBtn.title = window.i18n.t('folder.save_overwrite');
        saveBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>';
        saveBtn.onclick = function(e) { e.stopPropagation(); if (isWritable) saveToFile(i); };

        item.appendChild(extBadge);
        item.appendChild(info);
        if (isWritable) item.appendChild(saveBtn);
        item.onclick = function() { loadFile(i); };
        fileList.appendChild(item);
      });
      /* タブバーモードのとき、アクティブ状態を同期 */
      if (window.folderFileActive && document.body.classList.contains('tab-bar-mode')) {
        var bar = $('pageTabBar');
        if (bar) {
          bar.querySelectorAll('.page-tab').forEach(function(t, i) {
            t.classList.toggle('active', i === activeIdx);
          });
        }
      }
    }

    /* --- ファイル読み込み --- */
    function loadFile(idx) {
      var f = fileHandles[idx]; if (!f) return;

      /* 既にアクティブな項目を再クリックしたらアニメーションを再生しない */
      var items = fileList ? fileList.querySelectorAll('.folder-file-item') : [];
      var targetItem = items[idx];
      if (targetItem && targetItem.dataset.active === 'true') return;

      /* ──────────────────────────────────────────
         アニメーションを先に開始し、その間にファイルを読み込む
         これにより async/await 後の rAF タイミング問題を回避する
         ────────────────────────────────────────── */
      var wasInFileEditor = window.folderFileActive;
      var dir = (!wasInFileEditor || activeIdx < 0 || idx > activeIdx) ? 'right' : 'left';
      var edit = $('edit');

      /* ① out アニメーション開始（同期・即座に） */
      edit.classList.remove('page-slide-in-right');
      void edit.offsetWidth; /* reflow で確実に前クラスをリセット */

      /* ② out アニメーション中（160ms）にファイルを非同期読み込み */
      var loadPromise = f.handle.getFile().then(function(file) {
        return file.text().then(function(text) { return { file: file, text: text }; });
      });

      /* ③ 160ms 後にコンテンツ差し替え → in アニメーション */
      setTimeout(function() {
        loadPromise.then(function(result) {
          var newText = result.text;
          var file    = result.file;

          /* 仮ページが存在しなければ作成 */
          var fpIdx = pages.findIndex(function(p) { return p._fileEditor; });
          if (fpIdx === -1) {
            saveCurrentPage();
            var fp = {
              id: genPageId(),
              title: f.name,
              text: newText,
              font: pages[curPageIdx] ? pages[curPageIdx].font : 'Arial',
              size: pages[curPageIdx] ? pages[curPageIdx].size : 18,
              titleLocked: true,
              _fileEditor: true
            };
            pages.push(fp);
            fpIdx = pages.length - 1;
          } else {
            pages[fpIdx].text  = newText;
            pages[fpIdx].title = f.name;
          }
          curPageIdx = fpIdx;
          localStorage.setItem(PAGES_CUR, pages[curPageIdx].id);

          window.folderFileActive = true;
          /* タブバーモードでない場合のみ設定行を非表示にする */
          if (!document.body.classList.contains('tab-bar-mode')) {
            var navModeRow = $('pageNavModeRow');
            if (navModeRow) navModeRow.style.display = 'none';
          }
          edit.value = newText;
          ActionHandlers.updateText(newText);
          render();
          activeIdx = idx; hasUnsaved = false;
          f.size = file.size;
          renderFileList();
          /* タブバーモードならファイルをタブとして表示 */
          if (document.body.classList.contains('tab-bar-mode') && window.renderFolderTabs) {
            if (!wasInFileEditor && window.animateTabSwitch) {
              /* 初回移行：ページタブ→ファイルタブ（アニメーション付き） */
              window.animateTabSwitch(window.renderFolderTabs);
            } else {
              window.renderFolderTabs();
            }
          }
          if (!wasInFileEditor) {
            queueToast(window.i18n.t('toast.fileeditor_enter_prefix') + f.name, 2400);
          } else {
            queueToast(f.name + window.i18n.t('toast.file_loaded_suffix'), 1800);
          }
         

          /* in アニメーション */
          slidePageIn(edit);
        }).catch(function(e) { queueToast(window.i18n.t('toast.load_failed_prefix') + f.name, 2500); });
      }, 160);
    }

    /* --- ファイル保存 --- */
    async function saveToFile(idx) {
      var f = fileHandles[idx]; if (!f || !isWritable) return;
      try {
        var writable = await f.handle.createWritable();
        await writable.write($('edit').value);
        await writable.close();
        hasUnsaved = false; renderFileList();
        queueToast(f.name + window.i18n.t('toast.file_saved_suffix'), 1800);
      } catch(e) { queueToast(window.i18n.t('toast.save_failed_detail_prefix') + (e.message || e), 2500); }
    }

    /* --- フォルダを開く --- */
    async function openDirectory() {
      if (!window.showDirectoryPicker) {
        queueToast(window.i18n.t('toast.folder_picker_unsupported'), 3500);
        return;
      }
      try {
        var handle = await window.showDirectoryPicker({ mode: 'readwrite' });
        dirHandle  = handle; isWritable = await checkWritable(handle);
        fileHandles = []; activeIdx = -1; hasUnsaved = false;
        var entries = [];
        for await (var entry of handle.values()) {
          if (entry.kind !== 'file') continue;
          var parts = entry.name.split('.');
          var ext = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
          if (!SUPPORTED_EXTS.includes(ext)) continue;
          var file = await entry.getFile();
          entries.push({ name: entry.name, handle: entry, ext: ext, size: file.size });
        }
        entries.sort(function(a, b) { return a.name.localeCompare(b.name, 'ja'); });
        fileHandles = entries;
        titleEl.textContent = handle.name; titleEl.dataset.i18nLocked = "1";
        updateWriteStatus(); renderFileList(); openFolderPanel();
      } catch(e) { if (e.name !== 'AbortError') queueToast(window.i18n.t('toast.folder_open_failed'), 2500); }
    }
    window.folderOpenDirectory = openDirectory;

    /* --- 再読み込み --- */
    async function refreshDirectory() {
      if (!dirHandle) { openDirectory(); return; }
      try {
        /* 書き込み権限を再チェック（権限状態が変わっている可能性がある） */
        var prevWritable = isWritable;
        isWritable = await checkWritable(dirHandle);
        fileHandles = [];
        for await (var entry of dirHandle.values()) {
          if (entry.kind !== 'file') continue;
          var parts = entry.name.split('.');
          var ext = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
          if (!SUPPORTED_EXTS.includes(ext)) continue;
          var file = await entry.getFile();
          fileHandles.push({ name: entry.name, handle: entry, ext: ext, size: file.size });
        }
        fileHandles.sort(function(a, b) { return a.name.localeCompare(b.name, 'ja'); });
        if (prevWritable !== isWritable) updateWriteStatus();
        renderFileList();
        queueToast(window.i18n.t('toast.folder_refreshed'), 1500);
      } catch(e) { queueToast(window.i18n.t('toast.folder_refresh_failed'), 2500); }
    }

    /* 編集内容が変わったら unsaved フラグ */
    $('edit').addEventListener('input', function() {
      if (activeIdx >= 0 && isWritable) {
        hasUnsaved = true;
        var items = fileList.querySelectorAll('.folder-file-item');
        if (items[activeIdx]) {
          var btn = items[activeIdx].querySelector('.ffi-save-btn');
          if (btn) btn.classList.add('unsaved');
        }
      }
    });

    /* --- ファイルタブ描画（タブバーモード用） --- */
    function renderFolderTabs() {
      var bar = $('pageTabBar');
      if (!bar || !bar.classList.contains('active')) return;
      bar.innerHTML = '';
      fileHandles.forEach(function(f, i) {
        var wrap = document.createElement('div');
        wrap.className = 'page-tab-wrap';

        var tab = document.createElement('button');
        tab.className = 'page-tab' + (i === activeIdx ? ' active' : '');

        var extBadgeSpan = document.createElement('span');
        extBadgeSpan.style.cssText = 'font-size:9px;opacity:0.5;margin-right:2px;flex-shrink:0;';
        extBadgeSpan.textContent = f.ext.toUpperCase();

        var nameSpan = document.createElement('span');
        nameSpan.className = 'page-tab-name';
        nameSpan.textContent = f.name.slice(0, 20);

        tab.appendChild(extBadgeSpan);
        tab.appendChild(nameSpan);
        (function(idx) {
          tab.addEventListener('click', function() { loadFile(idx); });
        })(i);
        wrap.appendChild(tab);
        bar.appendChild(wrap);
      });
      requestAnimationFrame(function() {
        var activeEl = bar.querySelector('.page-tab.active');
        if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      });
    }
    window.renderFolderTabs = renderFolderTabs;

    openBtn.onclick    = openDirectory;
    refreshBtn.onclick = refreshDirectory;

    /* --- メモ帳に戻る（バツボタン） --- */
    var exitBtn = $('folderExitBtn');
    if (exitBtn) {
      exitBtn.onclick = function() {
        /* 仮ページを削除して元のページに戻る */
        var fpIdx = pages.findIndex(function(p) { return p._fileEditor; });
        var returnIdx = 0;
        if (fpIdx !== -1) {
          pages.splice(fpIdx, 1);
          /* 削除後のインデックス補正 */
          if (curPageIdx >= pages.length) curPageIdx = pages.length - 1;
          if (curPageIdx < 0) curPageIdx = 0;
          returnIdx = curPageIdx;
        }
        window.folderFileActive = false;
        activeIdx = -1; hasUnsaved = false;
        /* ファイルエディタ終了時にページ表示行を復元し、タブバーを復元 */
        var navModeRow = $('pageNavModeRow');
        if (navModeRow) navModeRow.style.display = '';
        if (document.body.classList.contains('tab-bar-mode')) {
          /* タブバーモードのまま → ファイルタブ→ページタブ（アニメーション付き） */
          if (window.animateTabSwitch && window.renderPageTabs) {
            requestAnimationFrame(function() { window.animateTabSwitch(window.renderPageTabs); });
          }
        } else if (localStorage.getItem('pageNavMode') === 'tabbar') {
          /* スライドモード中だったが設定はタブ → タブバーを復元 */
          requestAnimationFrame(function() { window.applyPageNavMode('tabbar'); });
        }
        renderFileList();

        var p = pages[returnIdx];
        if (!p) { window.closeFolderPanel(); queueToast(window.i18n.t('toast.memo_returned'), 1500); return; }

        var edit = $('edit'), fSel = $('fSel'), sSel = $('sSel');
        edit.value = p.text || '';
        for (var i = 0; i < fSel.options.length; i++) { if (fSel.options[i].value === p.font) { fSel.selectedIndex = i; break; } }
        sSel.value = String(p.size || 18);
        curPageIdx = returnIdx;
        localStorage.setItem(PAGES_CUR, p.id);
        ActionHandlers.updateText(edit.value);
        applyStyles();
        savePages(); render(); renderPageList();
        requestAnimationFrame(function() { updatePageIndicator(true); });
        slidePageIn(edit);
        window.closeFolderPanel();
        queueToast(window.i18n.t('toast.memo_returned'), 1500);
      };
    }

    /* ===== ページパネルと同等のスワイプ操作（左端から右スワイプで開く） ===== */
    (function initFolderSwipe() {
      var EDGE = 32, THRESH = 60, touching = false;
      var startX = 0, startY = 0, startedFromEdge = false, panelW = 0;

      document.addEventListener('touchstart', function(e) {
        var t = e.touches[0]; startX = t.clientX; startY = t.clientY;
        panelW = panel.offsetWidth; startedFromEdge = false; touching = false;
        if (!folderPanelOpen && startX < EDGE) { startedFromEdge = true; touching = true; }
        else if (folderPanelOpen) { touching = true; }
      }, { passive: true });

      document.addEventListener('touchmove', function(e) {
        if (!touching) return;
        var t = e.touches[0], dx = t.clientX - startX, dy = Math.abs(t.clientY - startY);
        if (!startedFromEdge && dy > Math.abs(dx) * 1.5) { touching = false; return; }
        var GAP = 20;
        if (!folderPanelOpen && startedFromEdge) {
          var open = Math.min(dx > 0 ? dx : 0, panelW);
          var tx = -(panelW + GAP - open);
          panel.classList.add('dragging'); overlay.classList.add('dragging');
          panel.style.transform = 'translateX(' + tx + 'px)';
          overlay.style.background = 'rgba(0,0,0,' + (0.38 * open / panelW) + ')';
          overlay.style.pointerEvents = 'auto';
        } else if (folderPanelOpen && dx < 0) {
          var tx2 = Math.max(dx, -(panelW + GAP));
          panel.classList.add('dragging'); overlay.classList.add('dragging');
          panel.style.transform = 'translateX(' + tx2 + 'px)';
          overlay.style.background = 'rgba(0,0,0,' + (0.38 * Math.max(0, 1 + tx2 / panelW)) + ')';
        }
      }, { passive: true });

      document.addEventListener('touchend', function(e) {
        if (!touching) return; touching = false;
        panel.classList.remove('dragging'); overlay.classList.remove('dragging');
        panel.style.transform = ''; overlay.style.background = ''; overlay.style.pointerEvents = '';
        var dx = e.changedTouches[0].clientX - startX;
        if (!folderPanelOpen && startedFromEdge && dx > THRESH) openFolderPanel();
        else if (folderPanelOpen && dx < -THRESH) closeFolderPanel();
        startedFromEdge = false;
      }, { passive: true });

      /* 左端近接でfolderPullTabを出現、離れたら非表示 */
      var folderTrigger = $('folderSwipeTrigger');
      if (folderTrigger) {
        folderTrigger.addEventListener('mouseenter', function() {
          if (folderPanelOpen) return;
          var tab = $('folderPullTab'); if (tab) tab.classList.add('visible');
        });
        folderTrigger.addEventListener('mouseleave', function() {
          var tab = $('folderPullTab');
          if (tab && !tab.matches(':hover')) tab.classList.remove('visible');
        });
      }
      /* タブ自体からmouseleaveしたら非表示 */
      var pullTab = $('folderPullTab');
      if (pullTab) {
        pullTab.addEventListener('click', function() { openFolderPanel(); });
        pullTab.addEventListener('mouseleave', function() { pullTab.classList.remove('visible'); });
      }
    })();
  })();

  var ftNumTimer   = null;
  var ftLastNum    = null;
  var ftLabelTimer = null;
  var ftLastLabel  = null;

  function updateFtLabel(newLabel) {
    var wrap  = $('f-info-label-wrap');
    var inner = $('f-info-label');
    if (!wrap || !inner) return;
    if (newLabel === ftLastLabel) return;
    ftLastLabel = newLabel;
    if (!state.footerAlways) {
      inner.textContent = newLabel;
      return;
    }
    clearTimeout(ftLabelTimer);
    var oldWidth = wrap.offsetWidth;
    wrap.style.transition = 'none';
    wrap.style.width = oldWidth + 'px';
    inner.classList.remove('slot-in');
    inner.classList.add('slot-out');
    ftLabelTimer = setTimeout(function() {
      // テキストを更新して自然幅を測定（inner は invisible なので flash なし）
      inner.textContent = newLabel;
      wrap.style.width = '';
      var newWidth = wrap.offsetWidth;
      // 旧幅に戻してから transition 付きで新幅へ
      wrap.style.width = oldWidth + 'px';
      wrap.style.transition = 'none';
      wrap.offsetWidth; /* reflow */
      wrap.style.transition = 'width 0.32s cubic-bezier(0.45, 0, 0.55, 1)';
      wrap.style.width = newWidth + 'px';
      inner.classList.remove('slot-out');
      inner.classList.add('slot-in');
      setTimeout(function() {
        inner.classList.remove('slot-in');
        wrap.style.transition = '';
        wrap.style.width = '';
      }, 340);
    }, 120);
  }

  function updateFtNum(newNum) {
    var wrap  = $('f-info-wrap');
    var inner = $('f-info-num');
    if (!wrap || !inner) return;
    var numStr = String(newNum);
    if (numStr === ftLastNum) return;
    ftLastNum = numStr;

    if (!state.footerAlways) {
      inner.textContent = numStr;
      return;
    }
    clearTimeout(ftNumTimer);
    wrap.style.width = wrap.offsetWidth + 'px';
    inner.classList.remove('slot-in');
    inner.classList.add('slot-out');
    ftNumTimer = setTimeout(function() {
      inner.textContent = numStr;
      inner.classList.remove('slot-out');
      wrap.style.width  = '';
      inner.classList.add('slot-in');
      setTimeout(function() { inner.classList.remove('slot-in'); }, 300);
    }, 160);
  }

  function render() {
    var edit = $('edit'), isAnyOpen = state.isOptionsOpen || state.isModalOpen;
    if (isAnyOpen) { clearTimeout(state.hideTimer); state.isFooterHidden = false; }
    var pageTitle = (pages && pages[curPageIdx])
      ? (pages[curPageIdx].title || (window.i18n.t('page.default') + (curPageIdx + 1))).slice(0, 20)
      : state.curFile.slice(0, 20);
    var charCount = edit.value.length;

    $('b-info').textContent = state.browser + '_' + state.device;

    updateFtLabel(pageTitle + ' · ');
    updateFtNum(charCount);

    edit.placeholder        = state.browser + '_' + state.device + ' >';
    $('backdrop').className = isAnyOpen ? 'show' : '';
    document.body.classList.toggle('modal-open', isAnyOpen);
    if (state.footerAlways) {
      $('ft').className = 'glass';
    } else {
      $('ft').className = 'glass' + (state.isFooterHidden ? ' hidden' : '');
    }
  }

  /* 低スペック検出（モバイルは除外） */
  (function() {
    if (state.device === 'Mobile') return;
    var WARMUP = 4000, MEASURE = 8000, DROP_THRESH = 80, DROP_LIMIT = 60;
    setTimeout(function() {
      var drops = 0, last = performance.now(), elapsed = 0, prev = last;
      function check(now) {
        elapsed += now - prev; prev = now;
        if (now - last > DROP_THRESH) drops++;
        last = now;
        if (elapsed < MEASURE) requestAnimationFrame(check);
        else if (drops > DROP_LIMIT) document.body.classList.add('no-anim');
      }
      requestAnimationFrame(check);
    }, WARMUP);
  })();

  function showDevMessage() { openPanel('devMessageModal'); }
  function hideDevMessage() { closePanel('devMessageModal'); }

  (function init() {
    var fSel = $('fSel'), sSel = $('sSel'), edit = $('edit');

    supportedFonts.forEach(function(f) { fSel.add(new Option(f, f)); });
    for (var j = 12; j <= 80; j += 2) sSel.add(new Option(j + 'px', j));
    sSel.value = 18;

    var translateSel = $('translateSel');
    translateSel.value = localStorage.getItem('translateEngine') || 'google';
    translateSel.onchange = function() {
      localStorage.setItem('translateEngine', translateSel.value);
      $('tpPowered').textContent = translateSel.value === 'bing' ? 'Powered by Bing translation' : 'Powered by Google translation';
    };

    var dictSel = $('dictSel');
    dictSel.value = localStorage.getItem('dictEngine') || 'wikipedia';
    dictSel.onchange = function() { localStorage.setItem('dictEngine', dictSel.value); };

    var swatchContainer = $('colorSwatches');
    themeColors.forEach(function(t) {
      var s = document.createElement('button'); s.className = 'swatch'; s.dataset.color = t.color;
      s.style.background = t.color; s.title = t.label;
      s.onclick = function(e) { e.preventDefault(); e.stopPropagation(); hideContextMenu(); applyAccentColor(t.color); };
      swatchContainer.appendChild(s);
    });
    applyAccentColor(state.accentColor);

    var autoSaveToggle = $('autoSaveToggle');
    autoSaveToggle.checked = state.autoSave;
    if (state.autoSave) {
      var saved = localStorage.getItem('autosave_text'), savedFile = localStorage.getItem('autosave_file');
      var savedFont = localStorage.getItem('autosave_font'), savedSize = localStorage.getItem('autosave_size');
      if (saved && saved.length > 0 && !edit.value) {
        if (savedFile) state.curFile = savedFile;
        if (savedFont && $('fSel')) $('fSel').value = savedFont;
        if (savedSize && $('sSel')) $('sSel').value = savedSize;
        applyStyles();
        edit.value = saved;
        ActionHandlers.updateText(edit.value); queueToast(window.i18n.t('toast.autosave_restored'), 3000);
      }
    }
    autoSaveToggle.onchange = function() {
      state.autoSave = autoSaveToggle.checked; localStorage.setItem('autoSave', state.autoSave);
      if (!state.autoSave) clearAutoSaveTimer(); else scheduleAutoSave();
    };
    $('clearAutoSaveBtn').onclick = function() {
      localStorage.removeItem('autosave_text'); localStorage.removeItem('autosave_file');
      localStorage.removeItem('autosave_font'); localStorage.removeItem('autosave_size');
      queueToast(window.i18n.t('toast.autosave_cleared'), 2000);
    };

    var saveMetaToggle = $('saveMetaToggle');
    saveMetaToggle.checked = state.saveMeta;
    saveMetaToggle.onchange = function() {
      state.saveMeta = saveMetaToggle.checked;
      localStorage.setItem('saveMeta', state.saveMeta);
      localStorage.removeItem('saveMetaRemembered');
    };

    $('saveMetaYesBtn').onclick = function() {
      var remember = $('saveMetaRememberToggle').checked;
      if (remember) {
        state.saveMeta = true;
        localStorage.setItem('saveMeta', 'true');
        localStorage.setItem('saveMetaRemembered', 'true');
        $('saveMetaToggle').checked = true;
      }
      closeSaveMetaModal();
      doFileSave(true);
    };
    $('saveMetaNoBtn').onclick = function() {
      var remember = $('saveMetaRememberToggle').checked;
      if (remember) {
        state.saveMeta = false;
        localStorage.setItem('saveMeta', 'false');
        localStorage.setItem('saveMetaRemembered', 'true');
        $('saveMetaToggle').checked = false;
      }
      closeSaveMetaModal();
      doFileSave(false);
    };

    var bioRegisterRow = $('bioRegisterRow');
    var bioToggle      = $('bioToggle');
    window.updateBioUI = function updateBioUI() {
      if (!BiometricEngine.isSupported() || !CryptoEngine.isEnabled()) {
        if (bioRegisterRow) bioRegisterRow.style.display = 'none';
        return;
      }
      if (bioRegisterRow) bioRegisterRow.style.display = '';
      if (bioToggle) bioToggle.checked = BiometricEngine.isRegistered();
    };
    updateBioUI();
    if (bioToggle) {
      bioToggle.addEventListener('change', async function() {
        if (bioToggle.checked) {
          bioToggle.disabled = true;
          try {
            if (!sessionPassword) { queueToast(window.i18n.t('toast.passkey_require_password'), 2500); bioToggle.checked = false; bioToggle.disabled = false; return; }
            await BiometricEngine.register(sessionPassword);
            queueToast(window.i18n.t('toast.passkey_registered'), 2000);
          } catch(e) {
            queueToast(window.i18n.t('toast.register_failed') + (e.message || window.i18n.t('toast.register_failed_cancel')), 3000);
            bioToggle.checked = false;
          }
          bioToggle.disabled = false;
        } else {
          BiometricEngine.clear();
          queueToast(window.i18n.t('toast.passkey_unlinked'), 2000);
          updateBioUI();
        }
      });
    }

    var pwLockToggle = $('pwLockToggle');
    pwLockToggle.checked = CryptoEngine.isEnabled();
    pwLockToggle.onchange = function() {
      if (pwLockToggle.checked) { openPwSetModal(); }
      else { openPwUnlockModal(); }
      setTimeout(updateBioUI, 300);
    };

    var isMob = state.device === 'Mobile', headerPageBtn = $('headerPageBtn');
    var pageBarToggle = $('pageBarToggle'), pageToggleRow = $('pageToggleRow');
    function applyPageBarSetting(show) {
      if (!headerPageBtn) return;
      headerPageBtn.classList.add('animated');
      if (show) { requestAnimationFrame(function() { requestAnimationFrame(function() { headerPageBtn.classList.add('visible'); }); }); }
      else headerPageBtn.classList.remove('visible');
    }
    if (isMob) {
      if (headerPageBtn) headerPageBtn.classList.add('animated', 'visible');
      if (pageToggleRow) pageToggleRow.style.display = 'none';
    } else {
      if (pageToggleRow) pageToggleRow.style.display = '';
      var pageBarOn = localStorage.getItem('pageBarVisible') === 'true';
      if (pageBarToggle) {
        pageBarToggle.checked = pageBarOn;
        pageBarToggle.onchange = function() { localStorage.setItem('pageBarVisible', pageBarToggle.checked); applyPageBarSetting(pageBarToggle.checked); };
      }
      if (pageBarOn && headerPageBtn) { headerPageBtn.classList.add('visible'); requestAnimationFrame(function() { headerPageBtn.classList.add('animated'); }); }
      else if (headerPageBtn) headerPageBtn.classList.add('animated');

      /* ページナビゲーション方式 (スライド / タブバー) */
      var pageNavModeRow  = $('pageNavModeRow');
      var pageNavSlideBtn = $('pageNavSlideBtn');
      var pageNavTabBtn   = $('pageNavTabBtn');
      if (pageNavModeRow) pageNavModeRow.style.display = '';
      var savedNavMode = localStorage.getItem('pageNavMode') || 'slide';
      if (savedNavMode === 'tabbar') {
        /* ページボタンが visible になる前にタブバーモードを適用 */
        requestAnimationFrame(function() { window.applyPageNavMode('tabbar'); });
      }
      if (pageNavSlideBtn) {
        pageNavSlideBtn.addEventListener('click', function() {
          localStorage.setItem('pageNavMode', 'slide');
          window.applyPageNavMode('slide');
        });
      }
      if (pageNavTabBtn) {
        pageNavTabBtn.addEventListener('click', function() {
          localStorage.setItem('pageNavMode', 'tabbar');
          window.applyPageNavMode('tabbar');
        });
      }
    }

    var searchInput = $('searchInput');
    searchInput.oninput = function() { doSearch(0); };
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { e.preventDefault(); e.stopPropagation(); doSearch(e.key === 'ArrowDown' ? 1 : -1); setTimeout(function() { searchInput.focus(); }, 0); }
      if (e.key === 'Enter')  { e.preventDefault(); doSearch(e.shiftKey ? -1 : 1); }
      if (e.key === 'Escape') {
        if (state.isSearchOpen) {
          state.isSearchOpen = false; closePanel('searchPanel');
          clearSearchHighlight(); $('searchCount').textContent = ''; updateTextareaPadding();
        }
      }
    });

    var upd = debounce(function() { ActionHandlers.updateText(edit.value); scheduleAutoSave(); saveCurrentPage(); render(); }, 150);
    edit.oninput  = upd;
    edit.onclick  = function() { hideContextMenu(); upd(); };
    edit.onscroll = function() { hideContextMenu(); updateMirror(); };
    if (window.ResizeObserver) new ResizeObserver(function() { updateMirror(); }).observe(edit);
    fSel.onchange = applyStyles; sSel.onchange = applyStyles;
    edit.addEventListener('wheel', function(e) {
      if (!e.ctrlKey) return; e.preventDefault();
      var cur = parseInt(sSel.value, 10) || 18, nz = normalizeSize(cur + (e.deltaY < 0 ? 2 : -2));
      if (nz !== cur) {
        sSel.value = String(nz); applyStyles();
        clearTimeout(sizeToastTimer); sizeToastTimer = setTimeout(function() { queueToast(window.i18n.t('toast.font_size_prefix') + nz + 'px', 1000); }, 600);
      }
    }, { passive: false });

    $('fileInput').onchange = function(e) {
      var file = e.target.files[0]; if (!file) return;
      state.curFile = file.name;
      var reader = new FileReader();
      reader.onload = function() { edit.value = reader.result; ActionHandlers.updateText(edit.value); saveCurrentPage(); render(); };
      reader.readAsText(file);
    };

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (pagePanelOpen) { closePagePanel(); return; }
        if (state.isOptionsOpen || state.isModalOpen) { ActionHandlers.closeOverlays(); render(); }
        hideDevMessage();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); ActionHandlers.toggleSearch(); render(); }
    });

    var ctxJustOpened = false;
    edit.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      var text = window.getSelection().toString().trim();
      selectedText = text;
      /* 選択テキストがある場合のみ右クリックメニューを表示 */
      if (!text) return;
      ctxJustOpened = true;
      showContextMenu(e.clientX, e.clientY, true);
      setTimeout(function() { ctxJustOpened = false; }, 100);
    });
    edit.addEventListener('mouseup', function(e) {
      if (e.button !== 0) return;
      setTimeout(function() {
        if (contextMenu && !contextMenu.contains(e.target)) hideContextMenu();
      }, 20);
    });

    
    function handleOutside(e) {
      if (ctxJustOpened) return;
      if (contextMenu && contextMenu.style.display !== 'none') { if (!contextMenu.contains(e.target)) hideContextMenu(); return; }
      if (state.isOptionsOpen) {
        var devModal = $('devMessageModal'); if (devModal && devModal.classList.contains('show')) return;
        var hBtns = document.querySelectorAll('header button');
        for (var bi = 0; bi < hBtns.length; bi++) { if (hBtns[bi] === e.target || hBtns[bi].contains(e.target)) return; }
        var optEl = $('options'); if (optEl && !optEl.contains(e.target)) { ActionHandlers.closeOverlays(); render(); }
        return;
      }
      var tp = $('translatePanel'); if (tp && tp.classList.contains('show') && !tp.contains(e.target)) closePanel('translatePanel');
      var swp = $('searchWebPanel'); if (swp && swp.classList.contains('show') && !swp.contains(e.target)) closePanel('searchWebPanel');
    }
    document.addEventListener('mousedown',  handleOutside);
    document.addEventListener('touchstart', handleOutside, { passive: true });

    
    window.addEventListener('offline', function() { if (!hasShownOfflineToast) { hasShownOfflineToast = true; queueToast(window.i18n.t('toast.offline_error'), 5000); } });
    window.addEventListener('online',  function() { hasShownOfflineToast = false; });

    
    var p = pages[curPageIdx];
    if (p && !edit.value && p.text) {
      /* スタイルを先に適用してからテキストをセット（逆順だとリレイアウト時にフラッシュが出る） */
      for (var i = 0; i < fSel.options.length; i++) { if (fSel.options[i].value === p.font) { fSel.selectedIndex = i; break; } }
      sSel.value = String(p.size || 18);
      applyStyles();
      edit.value = p.text;
    } else {
      applyStyles();
    }

    if (navigator.share) {
      var shareBtn = $('headerShareBtn');
      if (shareBtn) {
        shareBtn.classList.add('visible');
        /* transitionは次フレーム以降に有効化してロード時アニメーションを防ぐ */
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            shareBtn.classList.add('animated');
          });
        });
      }
    }
    ActionHandlers.updateText(edit.value); render();
  })();

  function computeDiff(aLines, bLines) {
    var n = aLines.length, m = bLines.length, max = n + m;
    if (max === 0) return [];
    var v = new Array(2 * max + 1).fill(0), trace = [];
    outer:
    for (var d = 0; d <= max; d++) {
      trace.push(v.slice());
      for (var k = -d; k <= d; k += 2) {
        var idx = k + max, x;
        x = (k === -d || (k !== d && v[idx-1] < v[idx+1])) ? v[idx+1] : v[idx-1] + 1;
        var y = x - k;
        while (x < n && y < m && aLines[x] === bLines[y]) { x++; y++; }
        v[idx] = x;
        if (x >= n && y >= m) { trace.push(v.slice()); break outer; }
      }
    }
    var ops = [], x = n, y = m;
    for (var dd = trace.length - 1; dd >= 0; dd--) {
      var vv = trace[dd], kk = x - y, ki = kk + max;
      var pk = (kk === -dd || (kk !== dd && vv[ki-1] < vv[ki+1])) ? kk + 1 : kk - 1;
      var px = vv[pk + max], py = px - pk;
      while (x > px && y > py) { x--; y--; ops.push({ op: '=', line: aLines[x] }); }
      if (dd > 0) {
        if      (x > px) { x--; ops.push({ op: '-', line: aLines[x] }); }
        else if (y > py) { y--; ops.push({ op: '+', line: bLines[y] }); }
      }
    }
    return ops.reverse();
  }
  function stripMeta(text) { return text.replace(/^##FONT:.*\n?/m,'').replace(/^##SIZE:.*\n?/m,''); }
  window.openCompareFromContextMenu = function() { hideContextMenu(); $('compareFileInput').click(); };
  $('compareFileInput').onchange = function(e) {
    var file = e.target.files[0]; if (!file) return;
    var reader = new FileReader();
    reader.onload = function() { showDiff($('edit').value, reader.result); };
    reader.readAsText(file);
  };
  function showDiff(origText, newText) {
    var aLines = stripMeta(origText).split(/\r?\n/), bLines = stripMeta(newText).split(/\r?\n/), ops = computeDiff(aLines, bLines);
    var edit = $('edit'), diffContent = $('diffContent');
    diffContent.style.fontSize = edit.style.fontSize || '18px'; diffContent.style.fontFamily = edit.style.fontFamily || 'sans-serif';
    var addCount = 0, delCount = 0, html = '';
    ops.forEach(function(op) {
      var safe = escapeHtml(op.line);
      if      (op.op === '+') { addCount++; html += '<span style="background:rgba(100,210,100,0.3);display:block;">+ ' + safe + '</span>'; }
      else if (op.op === '-') { delCount++; html += '<span style="background:rgba(255,80,80,0.3);display:block;">- '  + safe + '</span>'; }
      else                    {             html += '<span style="opacity:0.7;display:block;">　' + safe + '</span>'; }
    });
    diffContent.innerHTML = html;
    $('diffLegendAdd').innerHTML = '<span class="diff-legend-dot add"></span>' + window.i18n.t('diff.add') + ' ' + addCount + (window.i18n.lang() === 'en' ? ' line' + (addCount !== 1 ? 's' : '') : '行');
    $('diffLegendDel').innerHTML = '<span class="diff-legend-dot del"></span>' + window.i18n.t('diff.del') + ' ' + delCount + (window.i18n.lang() === 'en' ? ' line' + (delCount !== 1 ? 's' : '') : '行');
    $('diffOverlay').style.display = 'block';
    var mainHeader = document.querySelector('header');
    mainHeader.classList.remove('diff-restore');
    requestAnimationFrame(function() { requestAnimationFrame(function() { mainHeader.classList.add('diff-exit'); }); });
    var hdr = $('diffHeader'); hdr.classList.remove('diff-visible'); hdr.classList.add('diff-enter');
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        $('diffOverlay').classList.add('diff-overlay-visible');
        diffContent.style.paddingTop = (hdr.getBoundingClientRect().bottom + 16) + 'px';
        setTimeout(function() { hdr.classList.remove('diff-enter'); hdr.classList.add('diff-visible'); }, 220);
      });
    });
  }
  window.closeDiffOverlay = function() {
    var mainHeader = document.querySelector('header'), hdr = $('diffHeader'), overlay = $('diffOverlay');
    hdr.classList.remove('diff-visible'); hdr.classList.add('diff-enter'); overlay.classList.remove('diff-overlay-visible');
    setTimeout(function() {
      mainHeader.classList.remove('diff-exit');
      requestAnimationFrame(function() { requestAnimationFrame(function() { mainHeader.classList.add('diff-restore'); }); });
    }, 120);
    setTimeout(function() {
      overlay.style.display = 'none'; hdr.classList.remove('diff-enter','diff-visible');
      mainHeader.classList.remove('diff-exit','diff-restore');
    }, 350);
  };
  (function initPen() {
    var canvas       = $('penCanvas');
    var toggleBtn    = $('penToggleBtn');
    var toolbar      = $('penToolbar');
    var undoBtn      = $('penUndoBtn');
    var clearBtn     = $('penClearBtn');
    var eraserBtn    = $('penEraserBtn');
    var eraserCursor = $('eraserCursor');
    if (!canvas || !toggleBtn) return;

    var ctx          = canvas.getContext('2d');
    var penActive    = false;
    var eraserMode   = false;
    var drawing      = false;
    var penSize      = 6;
    var eraserSize   = 24;
    var strokes      = [];
    var activeStroke = null;

    var currentPageId = 'p0';
    var strokesMap    = {};  /* ページID → ストローク配列 */

    window.penPageSwitch = function(fromId, toId, dir) {
      /* 現在のページのストロークを保存 */
      strokesMap[fromId] = strokes.slice();
      canvas.classList.remove('page-slide-in-right');
      return function() {
        /* 切り替え先ページのストロークを復元 */
        strokes = (strokesMap[toId] || []).slice();
        currentPageId = toId;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        redrawAll();
        canvas.classList.add('page-slide-in-right');
        setTimeout(function() { canvas.classList.remove('page-slide-in-right'); }, 280);
      };
    };

    function resizeCanvas() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      redrawAll();
    }
    window.addEventListener('resize', resizeCanvas);

    function redrawAll() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      strokes.forEach(function(s) { drawStroke(s); });
    }

    function drawStroke(stroke) {
      if (!stroke || !stroke.points.length) return;
      ctx.save();
      if (stroke.type === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)';
        ctx.fillStyle   = 'rgba(0,0,0,1)';
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = stroke.color;
        ctx.fillStyle   = stroke.color;
      }
      ctx.lineWidth = stroke.size;
      ctx.lineCap   = 'round';
      ctx.lineJoin  = 'round';
      if (stroke.points.length === 1) {
        ctx.beginPath();
        ctx.arc(stroke.points[0].x, stroke.points[0].y, stroke.size / 2, 0, Math.PI * 2);
        ctx.fill();
      } else {
        ctx.beginPath();
        ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
        for (var i = 1; i < stroke.points.length; i++) {
          var p0 = stroke.points[i - 1];
          var p1 = stroke.points[i];
          ctx.quadraticCurveTo(p0.x, p0.y, (p0.x + p1.x) / 2, (p0.y + p1.y) / 2);
        }
        ctx.lineTo(stroke.points[stroke.points.length - 1].x,
                   stroke.points[stroke.points.length - 1].y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function activatePen() {
      penActive = true;
      canvas.classList.add('pen-mode');
      toggleBtn.classList.add('pen-active');
      toolbar.classList.add('show');
      resizeCanvas();
    }
    function deactivatePen() {
      penActive  = false;
      drawing    = false;
      eraserMode = false;
      canvas.classList.remove('pen-mode', 'eraser-mode');
      toggleBtn.classList.remove('pen-active');
      eraserBtn.classList.remove('eraser-active');
      eraserCursor.classList.remove('visible');
      /* 閉じるアニメーション：transitionはCSSデフォルト(0.18s)に戻してから show を外す */
      toolbar.classList.remove('show');
    }
    toggleBtn.addEventListener('click', function() {
      if (penActive) deactivatePen(); else activatePen();
    });

    function setEraserMode(on) {
      eraserMode = on;
      if (on) {
        canvas.classList.add('eraser-mode');
        eraserBtn.classList.add('eraser-active');
        updateEraserCursor(null);
      } else {
        canvas.classList.remove('eraser-mode');
        eraserBtn.classList.remove('eraser-active');
        eraserCursor.classList.remove('visible');
      }
    }
    eraserBtn.addEventListener('click', function() { setEraserMode(!eraserMode); });

    /* 消しゴムカーソル */
    function updateEraserCursor(pos) {
      if (!eraserMode) { eraserCursor.classList.remove('visible'); return; }
      var sz = eraserSize + 4;
      eraserCursor.style.width  = sz + 'px';
      eraserCursor.style.height = sz + 'px';
      if (pos) {
        eraserCursor.style.left = pos.x + 'px';
        eraserCursor.style.top  = pos.y + 'px';
        eraserCursor.classList.add('visible');
      }
    }

    var sizeDots = document.querySelectorAll('.pen-size-dot');
    sizeDots.forEach(function(dot) {
      if (parseInt(dot.dataset.size) === penSize) dot.classList.add('active');
      dot.addEventListener('click', function() {
        var sz = parseInt(dot.dataset.size);
        if (eraserMode) {
          eraserSize = sz * 4;
          updateEraserCursor(null);
        } else {
          penSize = sz;
        }
        sizeDots.forEach(function(d) { d.classList.remove('active'); });
        dot.classList.add('active');
      });
    });

    function getPos(e) {
      if (e.touches) {
        var t = e.touches[0] || e.changedTouches[0];
        return { x: t.clientX, y: t.clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }

    function startDraw(e) {
      if (!penActive) return;
      drawing = true;
      var pos  = getPos(e);
      var type = eraserMode ? 'eraser' : 'pen';
      var size = eraserMode ? eraserSize : penSize;
      activeStroke = { type: type, points: [pos], size: size, color: 'rgba(220,50,50,0.85)' };
      drawStroke(activeStroke);
    }

    function moveDraw(e) {
      if (!drawing || !activeStroke) return;
      if (e.cancelable) e.preventDefault();
      var pos = getPos(e);
      updateEraserCursor(pos);
      activeStroke.points.push(pos);
      var pts = activeStroke.points, n = pts.length;
      ctx.save();
      if (activeStroke.type === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)';
      } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = activeStroke.color;
      }
      ctx.lineWidth = activeStroke.size;
      ctx.lineCap = 'round'; ctx.lineJoin = 'round';
      ctx.beginPath();
      if (n >= 3) {
        var p0 = pts[n-3], p1 = pts[n-2], p2 = pts[n-1];
        ctx.moveTo((p0.x+p1.x)/2, (p0.y+p1.y)/2);
        ctx.quadraticCurveTo(p1.x, p1.y, (p1.x+p2.x)/2, (p1.y+p2.y)/2);
      } else if (n === 2) {
        ctx.moveTo(pts[0].x, pts[0].y);
        ctx.lineTo(pts[1].x, pts[1].y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function endDraw() {
      if (!drawing || !activeStroke) return;
      drawing = false;
      strokes.push(activeStroke);
      strokesMap[currentPageId] = strokes.slice();
      activeStroke = null;
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', function(e) {
      moveDraw(e);
      if (eraserMode) updateEraserCursor(getPos(e));
    });
    canvas.addEventListener('mouseup',    endDraw);
    canvas.addEventListener('mouseleave', function() {
      endDraw();
      eraserCursor.classList.remove('visible');
    });
    canvas.addEventListener('mouseenter', function(e) {
      if (eraserMode) updateEraserCursor(getPos(e));
    });
    canvas.addEventListener('touchstart', function(e) {
      if (e.cancelable) e.preventDefault();
      startDraw(e);
      if (eraserMode) updateEraserCursor(getPos(e));
    }, { passive: false });
    canvas.addEventListener('touchmove',  function(e) { moveDraw(e); }, { passive: false });
    canvas.addEventListener('touchend',   function() {
      endDraw();
      eraserCursor.classList.remove('visible');
    }, { passive: true });

    undoBtn.addEventListener('click', function() {
      if (!strokes.length) return;
      strokes.pop();
      strokesMap[currentPageId] = strokes.slice();
      redrawAll();
    });

    clearBtn.addEventListener('click', function() {
      strokes = [];
      strokesMap[currentPageId] = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.lineCap   = 'round';
    ctx.lineJoin  = 'round';

    window.penSetInitialPage = function(pageId) {
      currentPageId = pageId;
      strokes = (strokesMap[pageId] || []).slice();
      redrawAll();
    };
  })();

  </script>

  <!-- Service Worker 登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js')
          .then(function(reg) {
            /* console.log('[SW] 登録完了:', reg.scope); */
          })
          .catch(function(err) {
            /* console.warn('[SW] 登録失敗:', err); */
          });
      });
    }
  </script>

  <div id="langTransitionOverlay"><span id="langTransitionLabel"></span></div>
</body>
</html>

