<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>Notepad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff; --text: #333; --ui-bg: rgba(255, 255, 255, 0.5);
      --hover: rgba(0,0,0,0.05); --dim: #888; --radius: 25px;
      --accent: #007aff;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #121212; --text: #e0e0e0; --ui-bg: rgba(40, 40, 40, 0.5); --hover: rgba(255,255,255,0.08); }
      select, input[type="text"] { background: #333; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: sans-serif; height: 100vh; overflow: hidden;
    }

    .glass {
      background: var(--ui-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2); z-index: 10;
    }
    header, #options, footer, .modal, .toast { border-radius: var(--radius); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    header { 
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      padding: 4px; display: flex; gap: 4px; width: fit-content;
      max-width: 95vw;
      justify-content: center;
    }
    header button { 
      background: transparent; border: none; cursor: pointer; 
      padding: 8px 16px; font-size: 13px; color: inherit;
      border-radius: 20px; transition: 0.2s; font-family: inherit;
      white-space: nowrap;
    }
    header button:hover { background: var(--hover); }

    @media (max-width: 480px) {
      header { gap: 2px; padding: 4px 6px; }
      header button { padding: 6px 10px; font-size: 11px; }
    }

    #options {
      position: fixed; top: 68px; left: 50%; transform: translateX(-50%);
      width: 280px; padding: 0 20px; overflow: hidden; max-height: 0; opacity: 0;
      pointer-events: none;
    }
    #options.show { max-height: 250px; padding: 16px 20px; opacity: 1; pointer-events: auto; }
    #options div { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .label { width: 60px; color: var(--dim); font-size: 11px; }

    .modal {
      position: fixed; top: 50%; left: 50%; 
      transform: translate(-50%, -50%) scale(0.9);
      width: fit-content; min-width: 280px; padding: 24px 30px; text-align: center; opacity: 0; pointer-events: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 100;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal.show { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1); 
      pointer-events: auto; 
    }
    .modal p { margin: 0 0 15px 0; font-size: 14px; white-space: nowrap; font-weight: bold; }
    
    #fileNameInput {
      width: 100%; border-radius: 12px;
      border: 1px solid rgba(128,128,128,0.2); background: rgba(255,255,255,0.1);
      color: inherit; font-family: inherit; font-size: 14px; margin-bottom: 20px;
      outline: none; text-align: center;
    }

    .modal-btns { display: flex; gap: 10px; width: 100%; }
    .modal-btns button { 
      flex: 1; padding: 10px 0; border-radius: 15px; border: none; cursor: pointer; 
      font-size: 14px; font-family: inherit; transition: 0.2s;
    }
    .btn-main { background: var(--accent); color: white; }
    .btn-sub { background: var(--hover); color: var(--text); }

    textarea {
      position: absolute; inset: 0;
      border: none; outline: none; box-sizing: border-box;
      padding: 80px 30px 100px 30px;
      background: transparent; color: inherit; line-height: 1.8; font-size: 18px; resize: none;
      width: 100%; height: auto; overflow: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    textarea::-webkit-scrollbar { width: 0; height: 0; display: none; }

    footer {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      padding: 8px 24px; font-size: 11px; color: var(--dim); display: flex; gap: 15px;
      max-width: 90vw; justify-content: center;
    }
    footer.hidden { transform: translate(-50%, 50px); opacity: 0; pointer-events: none; }
    
    #backdrop { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.15); 
      z-index: 9; display: none; 
    }
    #backdrop.show { display: block; }

    /* トースト通知共通スタイル */
    .toast {
      position: fixed; right: 16px; top: 12px; min-width: 260px; max-width: 420px;
      background: var(--ui-bg); color: var(--text); z-index: 200; overflow: hidden;
      transform: translateX(120%); transition: transform 0.36s cubic-bezier(0.2,0,0.2,1), opacity 0.2s; opacity: 0;
      display: flex; align-items: center; padding: 10px 14px; gap: 10px; font-size: 13px;
    }
    .toast.show { transform: translateX(0); opacity: 1; }
    
    /* モバイル向けに通知の長さをヘッダーと同じにする */
    @media (max-width: 480px) {
      .toast {
        left: 50%;
        right: auto;
        transform: translate(-50%, -100%);
        width: 95vw;
        max-width: 95vw;
        justify-content: center;
      }
      .toast.show {
        transform: translate(-50%, 0);
      }
    }

    .toast .count { position: absolute; left: 0; top: 0; height: 4px; background: var(--accent); width: 100%; transition: width linear; }
    .toast .msg { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    @media (max-width: 768px) { #b-info { display: inline; } }
  </style>
</head>
<body>

  <header class="glass">
    <button onclick="act('new')">新規</button>
    <button onclick="act('open')">開く</button>
    <button onclick="act('save')">保存</button>
    <button onclick="act('toggle')">設定</button>
  </header>

  <div id="options" class="glass">
    <div><span class="label">Font</span><select id="fSel"></select></div>
    <div><span class="label">Size</span><select id="sSel"></select></div>
    <div style="font-size: 10px; color: var(--dim); justify-content: center; border-top: 1px solid rgba(128,128,128,0.1); padding-top: 8px; margin-top: 8px;">
      Build TH202602050515 · Version 7.1
    </div>
  </div>

  <div id="confirmModal" class="glass modal" role="dialog" aria-modal="true" aria-labelledby="modalMsg" tabindex="-1">
    <p id="modalMsg">消去しますか？</p>
    <input type="text" id="fileNameInput" placeholder="ファイル名を入力..." style="display:none">
    <div class="modal-btns">
      <button class="btn-sub" onclick="closeConfirm(false)">キャンセル</button>
      <button id="modalConfirmBtn" class="btn-main" onclick="closeConfirm(true)">確定</button>
    </div>
  </div>

  <div id="backdrop" onclick="act('closeOverlays')"></div>
  <textarea id="edit" spellcheck="false"></textarea>

  <footer id="ft" class="glass">
    <span id="b-info"></span>
    <span id="f-info"></span>
  </footer>

  <input type="file" id="fileInput" hidden accept=".txt">

  <!-- 通知用のコンテナ -->
  <div id="toastContainer"></div>

  <script>
    var $ = function(id) { return document.getElementById(id); };
    
    var getBrowser = function() {
      var ua = navigator.userAgent.toLowerCase();
      if (ua.indexOf('opr') !== -1 || ua.indexOf('opera') !== -1) return 'Opera';
      if (ua.indexOf('edg') !== -1) return 'Edge';
      if (ua.indexOf('firefox') !== -1) return 'Firefox';
      if (ua.indexOf('chrome') !== -1) return 'Chrome'; 
      if (ua.indexOf('safari') !== -1) return 'Safari';
      return 'Browser';
    };

    var state = {
      curFile: 'memo.txt',
      browser: getBrowser(),
      text: '',
      isOptionsOpen: false,
      isModalOpen: false,
      modalType: 'new',
      isFooterHidden: false,
      hideTimer: null
    };

    var supportedFonts = ['Arial', 'Noto Sans JP', 'Noto Serif JP', 'Zen Maru Gothic', 'Dela Gothic One'];
    var supportedSizes = (function(){ var a=[]; for(var s=12;s<=80;s+=2) a.push(s); return a; })();

    // --- 通知管理（キュー）システム ---
    var toastQueue = [];
    var isToastShowing = false;
    // timer for showing final font-size toast after wheel stops
    var sizeToastTimer = null;

    function queueToast(message, duration) {
      toastQueue.push({ message, duration: duration || 4000 });
      processToastQueue();
    }

    function processToastQueue() {
      if (isToastShowing || toastQueue.length === 0) return;
      
      isToastShowing = true;
      var item = toastQueue.shift();
      showToastUI(item.message, item.duration);
    }

    function showToastUI(message, duration) {
      var container = $('toastContainer');
      var el = document.createElement('div');
      el.className = 'glass toast';

      var count = document.createElement('div');
      count.className = 'count';

      var msg = document.createElement('div');
      msg.className = 'msg';
      msg.textContent = message;
      msg.setAttribute('role', 'status');
      msg.setAttribute('aria-live', 'polite');

      el.appendChild(count);
      el.appendChild(msg);
      container.appendChild(el);

      // スタイル調整（ヘッダーに合わせる）
      var header = document.querySelector('header');
      if (header) {
        var rect = header.getBoundingClientRect();
        el.style.top = rect.top + 'px';
        el.style.height = rect.height + 'px';
        var cs = getComputedStyle(header);
        el.style.borderRadius = cs.borderRadius;
      }

      var bar = count;
      
      // 表示アニメーション
      setTimeout(function() {
        el.classList.add('show');
        bar.style.transitionDuration = duration + 'ms';
        bar.style.width = '0%';
      }, 50);

      // 終了処理
      setTimeout(function() {
        el.classList.remove('show');
        setTimeout(function() {
          el.remove();
          isToastShowing = false;
          processToastQueue(); // 次の通知へ
        }, 400);
      }, duration);
    }

    var ActionHandlers = {
      new: function() { 
        state.modalType = 'new';
        state.isModalOpen = true; 
      },
      open: function() { 
        state.isModalOpen = false;
        state.isOptionsOpen = false;
        render();
        var fi = $('fileInput');
        try { fi.value = ''; } catch(e) {}
        fi.click(); 
      },
      save: function() {
        ActionHandlers.executeSave();
      },
      executeSave: function() {
        var editEl = $('edit');
        var prevText = editEl.value;
        ActionHandlers.updateText(prevText);
        state.text = prevText;

        try {
          var inputName = sanitizeFileName(state.curFile);
          state.curFile = inputName;

          var fontMeta = '##FONT:"' + $('fSel').value + '"';
          var sizeMeta = '##SIZE:' + $('sSel').value;
          var fullText = fontMeta + '\n' + sizeMeta + '\n' + state.text;

          var a = document.createElement('a');
          var blob = new Blob([fullText], { type: 'text/plain' });
          var url = URL.createObjectURL(blob);
          a.href = url;
          a.download = state.curFile;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(function() { URL.revokeObjectURL(url); }, 100);

          queueToast('保存を開始しました：' + state.curFile, 2500);
        } catch (e) {
          console.error('保存に失敗しました', e);
          queueToast('保存に失敗しました。');
        }
      },
      toggle: function() { 
        state.isOptionsOpen = !state.isOptionsOpen; 
        if (state.isOptionsOpen) state.isModalOpen = false;
      },
      closeOverlays: function() {
        state.isOptionsOpen = false;
        state.isModalOpen = false;
      },
      updateText: function(val) {
        var processed = this.parseMetaData(val);
        state.text = processed;
        this.processFooterLogic();
      },
      parseMetaData: function(val) {
        var lines = val.split('\n');
        var newLines = [];
        var changed = false;

        for(var i=0; i<lines.length; i++) {
          var line = lines[i];
          if(line.indexOf('##FONT:') === 0) {
            var font = line.replace('##FONT:', '').replace(/"/g, '').trim();
            if (font) {
              updateSelectValue('fSel', font);
              changed = true;
            }
            continue;
          }
          if(line.indexOf('##SIZE:') === 0) {
            var sizeRaw = parseInt(line.replace('##SIZE:', '').trim());
            if(!isNaN(sizeRaw)) {
              var norm = normalizeSize(sizeRaw);
              if (supportedSizes.indexOf(sizeRaw) === -1) {
                queueToast('未実装フォントサイズが使われています：' + sizeRaw + 'px');
              }
              updateSelectValue('sSel', norm);
              changed = true;
            }
            continue;
          }
          newLines.push(line);
        }

        var finalBody = newLines.join('\n');
        if (changed) {
          $('edit').value = finalBody;
          applyStyles();
        }
        return finalBody;
      },
      processFooterLogic: function() {
        clearTimeout(state.hideTimer);
        var edit = $('edit');
        var isBottom = edit.scrollHeight - (edit.scrollTop + edit.clientHeight) < 50;
        
        if (state.text.length > 0 && isBottom) {
          state.isFooterHidden = true;
          state.hideTimer = setTimeout(function() {
            state.isFooterHidden = false;
            render(); 
          }, 1000);
        } else {
          state.isFooterHidden = false;
        }
      }
    };

    function isFontAvailable(font) {
      if (!font) return false;
      if (document.fonts && document.fonts.check) {
        try { if (document.fonts.check('12px "' + font + '"')) return true; } catch (e) {}
      }
      try {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        var text = 'abcdefghijklmnopqrstuvwxyz';
        ctx.font = '72px monospace';
        var w1 = ctx.measureText(text).width;
        ctx.font = '72px ' + font + ', monospace';
        var w2 = ctx.measureText(text).width;
        return w1 !== w2;
      } catch (e) { return false; }
    }

    function updateSelectValue(id, value) {
      var sel = $(id);
      var exists = false;
      for(var i=0; i<sel.options.length; i++){
        if(sel.options[i].value == value) {
          sel.selectedIndex = i;
          exists = true;
          break;
        }
      }

      if(id === 'fSel') {
        var allowed = supportedFonts.indexOf(value) !== -1;
        function fallbackToArial() {
          queueToast('未実装フォントが使われています：' + value);
          value = 'Arial';
          for (var k = 0; k < sel.options.length; k++) {
            if (sel.options[k].value === 'Arial') { sel.selectedIndex = k; break; }
          }
        }

        if (!allowed) {
          fallbackToArial();
        } else {
          if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(function() {
              if (!isFontAvailable(value)) {
                fallbackToArial();
              } else if (!exists) {
                sel.add(new Option(value, value));
                sel.selectedIndex = sel.options.length - 1;
              }
            });
          } else {
            if (!isFontAvailable(value)) {
              fallbackToArial();
            } else if (!exists) {
              sel.add(new Option(value, value));
              sel.selectedIndex = sel.options.length - 1;
            }
          }
        }
      } else if (!exists && id === 'sSel') {
        sel.add(new Option(value + "px", value));
        sel.value = String(value);
      }
    }

    function normalizeSize(size) {
      var min = 12, max = 80;
      if (isNaN(size)) return 18;
      size = Math.round(size);
      if (size % 2 !== 0) {
        var down = size - 1, up = size + 1;
        if (down < min) size = up; else if (up > max) size = down; else size = (Math.abs(size - down) <= Math.abs(up - size)) ? down : up;
      }
      if (size < min) size = min;
      if (size > max) size = max;
      return size;
    }

    function sanitizeFileName(name) {
      name = String(name || '').trim();
      name = name.replace(/[/\\:\*\?"<>\|]/g, '').replace(/\s+/g, ' ');
      if (!name) return 'memo.txt';
      if (!name.toLowerCase().endsWith('.txt')) name += '.txt';
      if (name.length > 200) name = name.slice(0, 200) + '.txt';
      return name;
    }

    function debounce(fn, wait) {
      var t;
      return function() {
        var ctx = this, args = arguments;
        clearTimeout(t);
        t = setTimeout(function() { fn.apply(ctx, args); }, wait);
      };
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (state.isModalOpen || state.isOptionsOpen) {
          ActionHandlers.closeOverlays();
          render();
        }
        return;
      }

      if (e.altKey && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
        var fontMap = {
          '1': 'Arial', '2': 'Noto Sans JP', '3': 'Noto Serif JP', '4': 'Zen Maru Gothic', '5': 'Dela Gothic One'
        };
        var f = fontMap[e.key];
        if (f) {
          e.preventDefault();
          updateSelectValue('fSel', f);
          applyStyles();
          queueToast('フォント：' + f, 1000);
        }
      }
    });

    window.act = function(type) {
      if (ActionHandlers[type]) ActionHandlers[type]();
      render();
    };

    window.closeConfirm = function(yes) {
      if (yes) {
        if (state.modalType === 'new') {
          $('edit').value = ""; 
          ActionHandlers.updateText("");
          state.curFile = 'memo.txt';
        }
      }
      ActionHandlers.closeOverlays();
      render();
    };

    function renderEditor() {
      var edit = $('edit');
      $('f-info').textContent = state.curFile + " · " + state.text.length + " 文字";
      $('b-info').textContent = state.browser;
      edit.placeholder = state.browser + " >";
    }

    function renderOverlays() {
      var bd = $('backdrop');
      var isAnyOpen = state.isOptionsOpen || state.isModalOpen;
      
      if (state.modalType === 'new') {
        $('modalMsg').textContent = '内容をすべて消去しますか？';
        $('fileNameInput').style.display = 'none';
        $('modalConfirmBtn').textContent = '消去';
      }

      $('options').className = 'glass' + (state.isOptionsOpen ? ' show' : '');
      $('confirmModal').className = 'glass modal' + (state.isModalOpen ? ' show' : '');
      bd.className = (isAnyOpen ? 'show' : '');

      if (state.isModalOpen) {
        setTimeout(function(){
          $('confirmModal').focus();
        }, 50);
      }
    }

    function renderFooter() {
      $('ft').className = 'glass' + (state.isFooterHidden ? ' hidden' : '');
    }

    function render() {
      renderEditor();
      renderOverlays();
      renderFooter();
    }

    function applyStyles() {
      var edit = $('edit');
      edit.style.fontFamily = $('fSel').value;
      edit.style.fontSize = $('sSel').value + 'px';
    }

    (function init() {
      var fSel = $('fSel'), sSel = $('sSel'), edit = $('edit');
      for (var i = 0; i < supportedFonts.length; i++) fSel.add(new Option(supportedFonts[i], supportedFonts[i]));
      for (var j = 12; j <= 80; j += 2) sSel.add(new Option(j + "px", j));
      sSel.value = 18;

      var debouncedUpdate = debounce(function() { ActionHandlers.updateText(edit.value); render(); }, 200);
      var debouncedScroll = debounce(function() { ActionHandlers.updateText(edit.value); render(); }, 100);

      edit.oninput = debouncedUpdate;
      edit.onscroll = debouncedScroll;
      edit.onclick = function() { ActionHandlers.updateText(edit.value); render(); };
      fSel.onchange = applyStyles;
      sSel.onchange = applyStyles;

      edit.addEventListener('wheel', function(e) {
        try {
          if (!e.ctrlKey) return;
          e.preventDefault();
          var delta = e.deltaY;
          var current = parseInt(sSel.value, 10) || 18;
          var step = 2;
          var newSize = current + (delta < 0 ? step : -step);
          newSize = normalizeSize(newSize);
          if (newSize === current) return;
          sSel.value = String(newSize);
          applyStyles();

          clearTimeout(sizeToastTimer);
          sizeToastTimer = setTimeout(function() {
            queueToast('フォントサイズ: ' + newSize + 'px', 1000);
            sizeToastTimer = null;
          }, 600);
        } catch (err) { /* ignore */ }
      }, { passive: false });

      $('fileInput').onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        state.curFile = file.name;
        var reader = new FileReader();
        reader.onload = function() { 
          edit.value = reader.result; 
          ActionHandlers.updateText(edit.value); 
          render(); 
          try { e.target.value = ''; } catch (err) {}
        };
        reader.readAsText(file);
      };

      applyStyles();
      render();
    })();
  </script>
</body>
</html>
