<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="Z5LCrw2wiWOC0bTQynoScEQ9LTvHoEucbmQwoReCLXE" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>Notepad26</title>
  <meta name="description" content="学生が個人開発しているメモ帳。">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    /* ── CSS変数 ── */
    :root {
      --bg: #121212;
      --text: #e0e0e0;
      --ui-bg: rgba(40, 40, 40, 0.5);
      --hover: rgba(255, 255, 255, 0.08);
      --dim: #888;
      --radius: 25px;
      --accent: #c9a181;
      --accent-rgb: 201, 161, 129;
    }

    /* ── リセット ── */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    select, input[type="text"] {
      border-radius: 8px;
      padding: 4px;
      font-size: 12px;
      font-family: inherit;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #333;
      color: var(--text);
    }
    select option { background: #2d2d2d; color: #fff; }

    /* ── グラスモーフィズム ── */
    .glass {
      background: var(--ui-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius);
      z-index: 10;
    }

    /* ── ヘッダー ── */
    header {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px;
      display: flex;
      gap: 4px;
      width: fit-content;
      max-width: 95vw;
      justify-content: center;
      z-index: 160;
      border-radius: var(--radius);
      transition: opacity 0.32s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.32s cubic-bezier(0.4, 0, 0.2, 1),
                  border-radius 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    header button {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px 16px;
      font-size: 13px;
      color: inherit;
      border-radius: 20px;
      transition: background 0.18s cubic-bezier(0.4,0,0.2,1),
                  transform 0.12s cubic-bezier(0.34,1.56,0.64,1),
                  color 0.18s;
      font-family: inherit;
      white-space: nowrap;
      -webkit-user-select: none;
      user-select: none;
    }
    header button:hover { background: var(--hover); }
    header button:active { transform: scale(0.88); background: rgba(255,255,255,0.13); }
    @media (max-width: 480px) {
      header { gap: 2px; padding: 4px 6px; }
      header button { padding: 6px 10px; font-size: 11px; }
    }

    /* ── 設定パネル ── */
    #options {
      position: fixed;
      top: 50%;
      left: 50%;
      z-index: 170;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      min-width: 220px;
      padding: 12px;
      padding-top: 36px;
      border-radius: 18px;
      /* 閉じている状態（＝ closing の終着点と同じ） */
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      opacity: 0;
      pointer-events: none;
      will-change: opacity, transform;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.38s cubic-bezier(0.34, 1.3, 0.64, 1);
    }
    #options.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }
    #options.closing {
      opacity: 0;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      pointer-events: none;
      transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1),
                  transform 0.28s cubic-bezier(0.4, 0, 1, 1);
    }
    #options div { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .label { width: 60px; color: var(--dim); font-size: 11px; }

    #clearAutoSaveBtn {
      background: rgba(229, 57, 53, 0.12);
      border: 1px solid rgba(229, 57, 53, 0.4);
      border-radius: 8px;
      cursor: pointer;
      padding: 0 7px;
      height: 26px;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #clearAutoSaveBtn:active { transform: scale(0.92); background: rgba(229,57,53,0.22); }
    .options-version {
      font-size: 10px;
      color: var(--dim);
      justify-content: center;
      border-top: 1px solid rgba(128, 128, 128, 0.1);
      padding-top: 8px;
      margin-top: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
    }

    /* ── 情報ドット（設定パネル右上）── */
    .info-dot {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid #494949;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      cursor: pointer;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      color: var(--text);
      font-style: italic;
      font-family: Georgia, serif;
      line-height: 1;
      transition: transform 0.15s;
    }
    .info-dot:hover { transform: scale(1.1); }
    .info-dot:active { transform: scale(0.9); }
    .info-dot:focus { outline: none; }

    /* ── 開発者メッセージモーダル ── */
    #devMessageModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      width: min(320px, 88vw);
      padding: 28px 24px 22px;
      border-radius: 20px;
      z-index: 210;
      opacity: 0;
      pointer-events: none;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.38s cubic-bezier(0.34, 1.3, 0.64, 1);
    }
    #devMessageModal.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }
    #devMessageModal.closing {
      opacity: 0;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      pointer-events: none;
      transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1),
                  transform 0.28s cubic-bezier(0.4, 0, 1, 1);
    }
    .dev-title-main { text-align: center; font-weight: bold; font-size: 1.1em; margin-bottom: 8px; }
    #devMessageModal .dev-title {
      font-size: 13px;
      font-weight: bold;
      color: var(--text);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    #devMessageModal .dev-title::before {
      content: "ℹ";
      font-size: 16px;
    }
    #devMessageModal .dev-body {
      font-size: 13px;
      line-height: 1.85;
      color: var(--text);
      white-space: pre-wrap;
    }
    #devMessageModal .dev-close {
      margin-top: 18px;
      display: block;
      width: 100%;
      padding: 9px 0;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    #devMessageModal .dev-close:hover { filter: brightness(1.15); }
    #devMessageModal .dev-close:active { transform: scale(0.95); filter: brightness(0.9); }

    /* ── 閉じるドット（赤丸）── */
    .close-dot {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935);
      border: 1px solid rgba(0, 0, 0, 0.25);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      cursor: pointer;
      padding: 0;
      display: inline-block;
      transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), filter 0.15s;
    }
    .close-dot:hover  { transform: scale(1.2); filter: brightness(1.1); }
    .close-dot:active { transform: scale(0.88); }
    .close-dot:focus { outline: none; }

    /* ── 確認モーダル ── */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      width: fit-content;
      min-width: 280px;
      padding: 24px 30px;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      z-index: 180;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.38s cubic-bezier(0.34, 1.3, 0.64, 1);
    }
    .modal.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }
    .modal.closing {
      opacity: 0;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      pointer-events: none;
      transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1),
                  transform 0.28s cubic-bezier(0.4, 0, 1, 1);
    }
    .modal p { margin: 0 0 15px 0; font-size: 14px; white-space: nowrap; font-weight: bold; }
    #fileNameInput {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #333;
      color: inherit;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 20px;
      outline: none;
      text-align: center;
    }
    .modal-btns { display: flex; gap: 10px; width: 100%; }
    .modal-btns button {
      flex: 1;
      padding: 10px 0;
      border-radius: 15px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      transition: filter 0.18s, transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .modal-btns button:active { transform: scale(0.93); filter: brightness(0.9); }
    .btn-main { background: var(--accent); color: white; }
    .btn-sub  { background: var(--hover); color: var(--text); }

    /* ── テキストエリア ── */
    textarea {
      position: absolute;
      inset: 0;
      border: none;
      outline: none;
      padding: 80px 30px 100px;
      background: transparent;
      color: inherit;
      line-height: 1.8;
      font-size: 18px;
      resize: none;
      width: 100%;
      height: auto;
      overflow: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      transition: padding-top 0.3s ease;
    }
    textarea::-webkit-scrollbar { display: none; }

    /* ── フッター ── */
    footer {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      padding: 5px 14px;
      font-size: 11px;
      color: var(--dim);
      display: flex;
      gap: 8px;
      max-width: 90vw;
      justify-content: center;
      white-space: nowrap;
      border-radius: var(--radius);
    }
    footer.hidden { transform: translate(-50%, 50px); opacity: 0; pointer-events: none; }

    /* ── バックドロップ ── */
    #backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.15);
      z-index: 9;
      display: none;
      pointer-events: none; /* textareaへの入力を妨げない */
    }
    #backdrop.show { display: block; }

    /* ── トースト ── */
    .toast {
      position: fixed;
      right: 16px;
      top: 12px;
      min-width: 260px;
      max-width: 420px;
      background: var(--ui-bg);
      color: var(--text);
      z-index: 200;
      overflow: hidden;
      transform: translateX(120%) scale(0.96);
      transition: transform 0.4s cubic-bezier(0.34, 1.2, 0.64, 1), opacity 0.25s;
      opacity: 0;
      display: flex;
      align-items: center;
      padding: 10px 14px;
      gap: 10px;
      font-size: 13px;
    }
    .toast.show { transform: translateX(0) scale(1); opacity: 1; }
    .toast .count { position: absolute; left: 0; top: 0; height: 4px; background: var(--accent); width: 100%; transition: width linear; }
    .toast .msg   { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    @media (max-width: 480px) {
      textarea, #searchHighlightMirror { padding: 72px 16px 90px; font-size: 16px; }
      #contextMenu { max-width: calc(100vw - 24px); }
      .toast {
        left: 50%; right: auto;
        transform: translate(-50%, -100%);
        width: 95vw; max-width: 95vw;
        justify-content: center;
      }
      .toast.show { transform: translate(-50%, 0); }
    }

    @keyframes contextMenuIn {
      from {
        opacity: 0;
        transform: scale(0.72);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    #contextMenu {
      position: fixed;
      z-index: 1000;
      display: none;
      min-width: 120px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.22);
      border-radius: 20px;
      overflow: hidden;
      padding: 4px;
      transform-origin: top left;
    }
    #contextMenu.animating {
      animation: contextMenuIn 0.22s cubic-bezier(0.34, 1.45, 0.64, 1) forwards;
    }
    #contextMenu button {
      width: 100%;
      padding: 8px 16px;
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      font-family: inherit;
      transition: background 0.15s, transform 0.1s cubic-bezier(0.34,1.56,0.64,1);
      border-radius: 16px;
    }
    #contextMenu button:hover { background: var(--hover); }
    #contextMenu button:active { transform: scale(0.95); background: rgba(255,255,255,0.12); }
    .ctx-divider {
      height: 1px;
      background: rgba(128, 128, 128, 0.18);
      margin: 3px 8px;
    }

    /* ── 検索ハイライトミラー ── */
    #searchHighlightMirror {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      padding: 80px 30px 100px;
      line-height: 1.8;
      font-size: 18px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      color: transparent;
      transition: padding-top 0.3s ease;
    }
    #searchHighlightMirror mark {
      border-radius: 3px;
      color: transparent;
      background: var(--accent);
      opacity: 0.18;
    }
    #searchHighlightMirror mark.current { opacity: 0.38; }

    /* ── 検索バー ── */
    #searchBar {
      position: fixed;
      left: 50%;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      z-index: 150;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.28s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.38s cubic-bezier(0.34, 1.2, 0.64, 1),
                  top 0.3s ease;
      transform: translateX(-50%) translateY(-10px) scale(0.96);
      border-radius: var(--radius);
    }
    #searchBar.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0) scale(1);
    }
    #searchBar input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 14px;
      color: var(--text);
      font-family: inherit;
      width: 200px;
      padding: 2px 4px;
    }
    #searchBar .s-count   { font-size: 11px; color: var(--dim); white-space: nowrap; min-width: 40px; }
    #searchBar .s-divider { width: 1px; height: 16px; background: rgba(128, 128, 128, 0.25); }
    #searchBar button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 13px;
      color: var(--dim);
      padding: 2px 6px;
      border-radius: 8px;
      font-family: inherit;
      transition: background 0.15s, color 0.15s, transform 0.1s cubic-bezier(0.34,1.56,0.64,1);
    }
    #searchBar button:hover { background: var(--hover); color: var(--text); }
    #searchBar button:active { transform: scale(0.88); }

    /* ── 翻訳パネル ── */
    #translatePanel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      width: min(480px, 92vw);
      max-height: 70vh;
      z-index: 1100;
      border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.22);
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.38s cubic-bezier(0.34, 1.3, 0.64, 1);
      overflow: hidden;
    }
    #translatePanel.show {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    #translatePanel.closing {
      opacity: 0;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      pointer-events: none;
      transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1),
                  transform 0.28s cubic-bezier(0.4, 0, 1, 1);
    }
    /* ── ドラッグハンドル ── */
    .drag-handle {
      cursor: grab;
      user-select: none;
      -webkit-user-select: none;
    }
    .drag-handle:active { cursor: grabbing; }

    /* 掴んだとき：スプリング縮小アニメーション */
    .panel-grabbing {
      transition: transform 0.2s cubic-bezier(0.34, 1.1, 0.64, 1),
                  box-shadow 0.2s cubic-bezier(0.34, 1.1, 0.64, 1),
                  opacity 0.15s !important;
      box-shadow: 0 24px 64px rgba(0,0,0,0.42) !important;
      opacity: 0.92 !important;
    }
    /* ドロップしたとき：スプリングで元のサイズに戻る */
    .panel-dropping {
      transition: transform 0.38s cubic-bezier(0.34, 1.35, 0.64, 1),
                  box-shadow 0.3s cubic-bezier(0.34, 1.35, 0.64, 1),
                  opacity 0.2s !important;
    }

    /* 設定パネル上部ハンドルのインジケーター（ホバー時のみ表示） */
    #optionsDragHandle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.45);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s cubic-bezier(0.4,0,0.2,1);
    }
    #optionsDragHandle:hover::after { opacity: 1; }

    /* Web検索パネルのヘッダー中央インジケーター（ホバー時のみ表示） */
    .swp-header::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.38);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s cubic-bezier(0.4,0,0.2,1);
    }
    .swp-header:hover::after { opacity: 1; }

    #translatePanel .tp-header {
      display: flex;
      align-items: center;
      padding: 11px 14px;
      border-bottom: 1px solid rgba(128, 128, 128, 0.15);
      flex-shrink: 0;
      position: relative;
    }
    #translatePanel .tp-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935);
      border: 1px solid rgba(0, 0, 0, 0.2);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: 0.15s;
      z-index: 1;
    }
    #translatePanel .tp-lang {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--dim);
    }
    #translatePanel .tp-lang select {
      border-radius: 10px;
      padding: 3px 6px;
      font-size: 12px;
      font-family: inherit;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #333;
      color: var(--text);
      cursor: pointer;
    }
    #translatePanel .tp-lang .tp-arrow { font-size: 13px; color: var(--dim); user-select: none; }
    #translatePanel .tp-body {
      padding: 14px 18px 10px;
      overflow-y: auto;
      flex: 1;
      scrollbar-width: none;
    }
    #translatePanel .tp-body::-webkit-scrollbar { display: none; }
    #translatePanel .tp-src {
      font-size: 13px;
      color: var(--dim);
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(128, 128, 128, 0.12);
      line-height: 1.6;
      word-break: break-all;
    }
    #translatePanel .tp-result  { font-size: 17px; line-height: 1.75; word-break: break-all; color: var(--text); }
    #translatePanel .tp-loading { text-align: center; padding: 24px 0; color: var(--dim); font-size: 13px; }
    #translatePanel .tp-error   { color: #e53935; font-size: 13px; padding: 16px 0; }
    #translatePanel .tp-powered {
      font-size: 10px;
      color: var(--dim);
      text-align: center;
      padding: 1px 1px 4px;
      border-top: 1px solid rgba(128, 128, 128, 0.12);
      flex-shrink: 0;
    }

    /* ── Web検索パネル ── */
    #searchWebPanel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      width: min(520px, 94vw);
      max-height: min(600px, 82vh);
      z-index: 1100;
      border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.22);
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.38s cubic-bezier(0.34, 1.3, 0.64, 1);
      overflow: hidden;
    }
    #searchWebPanel.show {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    #searchWebPanel.closing {
      opacity: 0;
      transform: translate(-50%, calc(-50% + 16px)) scale(0.9);
      pointer-events: none;
      transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1),
                  transform 0.28s cubic-bezier(0.4, 0, 1, 1);
    }
    #searchWebPanel .swp-header {
      display: flex;
      align-items: center;
      padding: 10px 14px 8px;
      border-bottom: 1px solid rgba(128, 128, 128, 0.15);
      flex-shrink: 0;
      gap: 8px;
      position: relative;
    }
    #searchWebPanel .swp-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #e53935);
      border: 1px solid rgba(0, 0, 0, 0.2);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: 0.15s;
    }
    #searchWebPanel .swp-wiki-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 11px;
      color: var(--dim);
      padding: 3px 10px;
      border-radius: 10px;
      font-family: inherit;
      transition: 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    #searchWebPanel .swp-wiki-btn:hover { background: var(--hover); color: var(--text); }
    #searchWebPanel .swp-body {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: none;
      padding: 12px 16px 16px;
    }
    #searchWebPanel .swp-body::-webkit-scrollbar { display: none; }

    .swp-empty { text-align: center; padding: 32px 0; font-size: 13px; color: var(--dim); }
    .swp-abstract { background: rgba(128,128,128,0.07); border-radius: 12px; padding: 12px 14px; margin-bottom: 14px; }
    .swp-abstract-heading { font-size: 14px; font-weight: bold; margin-bottom: 6px; color: var(--text); }
    .swp-abstract-desc    { font-size: 12px; color: var(--accent); margin-bottom: 6px; font-weight: bold; }
    .swp-abstract-text    { font-size: 13px; color: var(--text); line-height: 1.65; }
    .swp-abstract-src     { font-size: 11px; color: var(--dim); margin-top: 6px; }
    .swp-abstract-src a   { color: var(--accent); text-decoration: none; }
    .swp-abstract-src a:hover { text-decoration: underline; }
    .swp-results-label { font-size: 11px; color: var(--dim); margin-bottom: 8px; padding-left: 2px; }
    .swp-result-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.15s;
      margin-bottom: 4px;
    }
    .swp-result-item:hover { background: var(--hover); }
    .swp-result-title { font-size: 13px; font-weight: bold; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .swp-result-desc  { font-size: 12px; color: var(--text); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .swp-result-url   { font-size: 11px; color: var(--dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ── iOSトグルスイッチ ── */
    .ios-toggle {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 26px;
      flex-shrink: 0;
    }
    .ios-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }
    .ios-toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: rgba(120, 120, 128, 0.32);
      border-radius: 13px;
      transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .ios-toggle-slider::before {
      content: '';
      position: absolute;
      height: 22px;
      width: 22px;
      left: 2px;
      top: 2px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: transform 0.32s cubic-bezier(0.34, 1.3, 0.64, 1);
    }
    .ios-toggle input:checked + .ios-toggle-slider {
      background: #34c759;
    }
    .ios-toggle input:checked + .ios-toggle-slider::before {
      transform: translateX(18px);
    }

    .swatch {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.18s cubic-bezier(0.34,1.56,0.64,1), border-color 0.18s;
      flex-shrink: 0;
    }
    .swatch:hover  { transform: scale(1.2); }
    .swatch:active { transform: scale(0.9); }
    .swatch.active { border-color: var(--text); }

    /* ── Diffオーバーレイ ── */
    #diffOverlay { opacity: 0; transition: opacity 0.25s ease; }
    #diffOverlay.diff-overlay-visible { opacity: 1; }

    #diffContent {
      position: absolute;
      inset: 0;
      padding: 80px 30px 40px;
      overflow: auto;
      line-height: 1.8;
      font-size: 18px;
      white-space: pre-wrap;
      word-wrap: break-word;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #diffHeader {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 310;
      border-radius: 25px;
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #diffHeader.diff-enter  { opacity: 0; transform: translateX(-50%) scale(0.82); }
    #diffHeader.diff-visible{ opacity: 1; transform: translateX(-50%) scale(1); }

    #diffHeader .diff-label    { font-size: 12px; color: var(--dim); white-space: nowrap; }
    #diffHeader .diff-divider  { width: 1px; height: 16px; background: rgba(128, 128, 128, 0.25); display: inline-block; }
    #diffHeader .diff-legend   { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--dim); }
    #diffHeader .diff-legend-dot { display: inline-block; width: 14px; height: 14px; border-radius: 3px; }
    #diffHeader .diff-legend-dot.add { background: rgba(100, 210, 100, 0.45); }
    #diffHeader .diff-legend-dot.del { background: rgba(255, 80, 80, 0.45); }
    #diffHeader .diff-close-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 13px;
      color: var(--dim);
      padding: 2px 8px;
      border-radius: 20px;
      font-family: inherit;
      transition: 0.15s;
    }
    #diffHeader .diff-close-btn:hover { background: var(--hover); }

    header.diff-exit    { opacity: 0; transform: translateX(-50%) scale(0.82); pointer-events: none; }
    header.diff-restore { opacity: 1; transform: translateX(-50%) scale(1);    pointer-events: auto; }
  </style>
</head>
<body>

  <header class="glass">
    <button onclick="act('new')">新規</button>
    <button onclick="act('open')">開く</button>
    <button onclick="act('save')">保存</button>
    <button onclick="act('toggleSearch')">検索</button>
    <button onclick="act('toggle')">設定</button>
  </header>

  <div id="searchBar" class="glass">
    <button onclick="act('searchPrev')" title="前へ">↑</button>
    <button onclick="act('searchNext')" title="次へ">↓</button>
    <div class="s-divider"></div>
    <input id="searchInput" type="text" placeholder="検索..." autocomplete="off">
    <span id="searchCount" class="s-count"></span>
    <div class="s-divider"></div>
    <button onclick="act('toggleSearch')">✕</button>
  </div>

  <div id="options" class="glass">
    <div id="optionsDragHandle" class="drag-handle" style="position:absolute;top:0;left:0;right:0;height:36px;border-radius:18px 18px 0 0;"></div>
    <button class="close-dot" onclick="act('toggle')" aria-label="閉じる" title="閉じる"></button>
    <button class="info-dot" onclick="showDevMessage()" aria-label="開発者メッセージ" title="開発者メッセージ">i</button>
    <div><span class="label">フォント</span><select id="fSel"></select></div>
    <div><span class="label">サイズ</span><select id="sSel"></select></div>
    <div><span class="label">検索</span>
      <select id="dictSel">
        <option value="wikipedia">Wikipedia_JP</option>
        <option value="wiktionary">Wiktionary_JP</option>
      </select>
    </div>
    <div><span class="label">翻訳</span>
      <select id="translateSel">
        <option value="google">Google 翻訳</option>
        <option value="bing">Bing 翻訳</option>
      </select>
    </div>
    <div><span class="label">テーマ</span>
      <div class="color-swatches" id="colorSwatches"></div>
    </div>
    <div><span class="label">自動保存</span>
      <label class="ios-toggle">
        <input type="checkbox" id="autoSaveToggle">
        <span class="ios-toggle-slider"></span>
      </label>
      <button id="clearAutoSaveBtn" title="保存済みデータを消去">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#e53935;display:block;">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/><path d="M14 11v6"/>
          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
        </svg>
      </button>
    </div>

    <div class="options-version">
      <span>Build 2602190115</span>
      <span>Version 26.0.4</span>
      <span><strong>↓Creator↓</strong><br>Claude<br>Chat GPT<br>Gemini<br>Copilot<br>Cursor<br>Tikuwa</span>
    </div>
  </div>

  <div id="confirmModal" class="glass modal" role="dialog" aria-modal="true" aria-labelledby="modalMsg" tabindex="-1">
    <p id="modalMsg">内容をすべて消去しますか？</p>
    <input type="text" id="fileNameInput" placeholder="ファイル名を入力..." style="display:none">
    <div class="modal-btns">
      <button class="btn-sub" onclick="closeConfirm(false)">キャンセル</button>
      <button id="modalConfirmBtn" class="btn-main" onclick="closeConfirm(true)">確定</button>
    </div>
  </div>

  <div id="translatePanel" class="glass">
    <div class="tp-header drag-handle" id="translateDragHandle">
      <button class="tp-dot" onclick="closePanel('translatePanel')" aria-label="閉じる"></button>
      <div class="tp-lang">
        <select id="tpSrcLang">
          <option value="auto">自動検出</option>
          <option value="ja">日本語</option>
          <option value="en">英語</option>
          <option value="zh-CN">中国語</option>
          <option value="ko">韓国語</option>
          <option value="fr">フランス語</option>
          <option value="de">ドイツ語</option>
          <option value="es">スペイン語</option>
        </select>
        <span class="tp-arrow">→</span>
        <select id="tpTgtLang">
          <option value="ja">日本語</option>
          <option value="en">英語</option>
          <option value="zh-CN">中国語</option>
          <option value="ko">韓国語</option>
          <option value="fr">フランス語</option>
          <option value="de">ドイツ語</option>
          <option value="es">スペイン語</option>
        </select>
      </div>
    </div>
    <div class="tp-body">
      <div class="tp-src" id="tpSrc"></div>
      <div class="tp-result" id="tpResult"></div>
    </div>
    <div class="tp-powered" id="tpPowered">Powered by Google translation</div>
  </div>

  <div id="searchWebPanel" class="glass">
    <div class="swp-header drag-handle" id="searchWebDragHandle">
      <button class="swp-dot" onclick="closePanel('searchWebPanel')" aria-label="閉じる"></button>
      <button class="swp-wiki-btn" id="swpWikiBtn">開く</button>
    </div>
    <div class="swp-body" id="swpBody"></div>
  </div>

  <div id="devMessageModal" class="glass">
    <div class="dev-title-main">Information</div>
    <div class="dev-body">アプリを使っている人へ
私は最近開発にハマっており、このアプリもその一環として制作しました。
しかし進学に伴い学業が忙しくなるため、今後は大規模な更新は難しくなる可能性があります。
現在は主に細かな機能追加やバグ修正が中心になる予定ですが、可能な限り改善は続けていきます。
まとまった時間が確保でき次第、改めて本格的なメンテナンスや機能強化を行う予定です。

ご了承の上今後ともよろしくお願いします。

 - Tikuwa - </div>
    <button class="dev-close" onclick="hideDevMessage()">閉じる</button>
  </div>

  <div id="backdrop" onclick="act('closeOverlays')"></div>

  <div id="contextMenu" class="glass">
    <button id="ctxCopy"    onclick="ctxCopyText()">コピー</button>
    <button id="ctxCut"     onclick="ctxCutText()">切り取り</button>
    <button id="ctxPaste"   onclick="ctxPasteText()">貼り付け</button>
    <div id="ctxDivider" class="ctx-divider"></div>
    <button id="ctxSearch"  onclick="searchWiki()">検索</button>
    <button id="ctxTrans"   onclick="translateText()">翻訳</button>
    <button id="ctxCompare" onclick="openCompareFromContextMenu()">比較</button>
  </div>

  <div id="searchHighlightMirror"></div>
  <textarea id="edit" spellcheck="false"></textarea>

  <footer id="ft" class="glass">
    <span id="b-info"></span>
    <span id="f-info"></span>
  </footer>

  <input type="file" id="fileInput"        hidden accept=".txt">
  <input type="file" id="compareFileInput" hidden accept=".txt">

  <div id="diffOverlay" style="display:none; position:fixed; inset:0; z-index:300; overflow:hidden; background:var(--bg);">
    <div id="diffHeader" class="glass diff-enter">
      <span class="diff-label">比較結果</span>
      <span class="diff-divider"></span>
      <span id="diffLegendAdd" class="diff-legend"><span class="diff-legend-dot add"></span>追加</span>
      <span id="diffLegendDel" class="diff-legend"><span class="diff-legend-dot del"></span>削除</span>
      <span class="diff-divider"></span>
      <button class="diff-close-btn" onclick="closeDiffOverlay()">✕ 閉じる</button>
    </div>
    <div id="diffContent"></div>
  </div>

  <div id="toastContainer"></div>

  <script>
    var $ = function(id) { return document.getElementById(id); };

    /* ── 開発者メッセージ ── */
    function showDevMessage() { openPanel('devMessageModal'); }
    function hideDevMessage() { closePanel('devMessageModal'); }

    /* ── デバイス・ブラウザ判定 ── */
    var getDevice = function() {
      var ua = navigator.userAgent.toLowerCase();
      var isMobile = /mobi|android|iphone|ipad|ipod|windows phone|blackberry|silk/.test(ua)
        || (navigator.maxTouchPoints > 1 && window.screen.width <= 1024);
      return isMobile ? 'Mobile' : 'PC';
    };

    var getBrowser = function() {
      var ua = navigator.userAgent.toLowerCase();
      if (ua.indexOf('opr')     !== -1) return 'Opera';
      if (ua.indexOf('edg')     !== -1) return 'Edge';
      if (ua.indexOf('firefox') !== -1) return 'Firefox';
      if (ua.indexOf('chrome')  !== -1) return 'Chrome';
      if (ua.indexOf('safari')  !== -1) return 'Safari';
      return 'Browser';
    };

    /* ── アプリ状態 ── */
    var state = {
      curFile:        'memo.txt',
      browser:        getBrowser(),
      device:         getDevice(),
      text:           '',
      isOptionsOpen:  false,
      isModalOpen:    false,
      isSearchOpen:   false,
      modalType:      'new',
      isFooterHidden: false,
      hideTimer:      null,
      accentColor:    localStorage.getItem('accentColor') || '#c9a181',
      autoSave:       localStorage.getItem('autoSave') === 'true'
    };

    var supportedFonts = ['Arial', 'Noto Sans JP', 'Noto Serif JP', 'Zen Maru Gothic', 'Dela Gothic One'];

    /* ── トーストキュー ── */
    var toastQueue         = [];
    var isToastShowing     = false;
    var sizeToastTimer     = null;
    var hasShownOfflineToast = false;

    function queueToast(message, duration) {
      toastQueue.push({ message: message, duration: duration || 4000 });
      processToastQueue();
    }
    function processToastQueue() {
      if (isToastShowing || toastQueue.length === 0) return;
      isToastShowing = true;
      var item = toastQueue.shift();
      showToastUI(item.message, item.duration);
    }
    function showToastUI(message, duration) {
      var el    = document.createElement('div');
      el.className = 'glass toast';
      var count = document.createElement('div'); count.className = 'count';
      var msg   = document.createElement('div'); msg.className   = 'msg'; msg.textContent = message;
      el.appendChild(count);
      el.appendChild(msg);
      $('toastContainer').appendChild(el);

      var header = document.querySelector('header');
      if (header) {
        var rect = header.getBoundingClientRect();
        el.style.top          = rect.top + 'px';
        el.style.height       = rect.height + 'px';
        el.style.borderRadius = getComputedStyle(header).borderRadius;
      }
      setTimeout(function() {
        el.classList.add('show');
        count.style.transitionDuration = duration + 'ms';
        count.style.width = '0%';
      }, 50);
      setTimeout(function() {
        el.classList.remove('show');
        setTimeout(function() { el.remove(); isToastShowing = false; processToastQueue(); }, 400);
      }, duration);
    }

    /* ── アクションハンドラ ── */
    var ActionHandlers = {
      new: function() {
        state.modalType   = 'new';
        state.isModalOpen = true;
        openPanel('confirmModal');
      },
      open: function() {
        state.isModalOpen   = false;
        state.isOptionsOpen = false;
        render();
        var fi = $('fileInput');
        try { fi.value = ''; } catch(e) {}
        fi.click();
      },
      save: function() {
        state.text = $('edit').value;
        try {
          var fullText = '##FONT:"' + $('fSel').value + '"\n##SIZE:' + $('sSel').value + '\n' + state.text;
          var a    = document.createElement('a');
          var blob = new Blob([fullText], { type: 'text/plain' });
          var url  = URL.createObjectURL(blob);
          a.href = url; a.download = sanitizeFileName(state.curFile); a.click();
          URL.revokeObjectURL(url);
          queueToast('保存を開始しました：' + state.curFile, 2500);
        } catch(e) { queueToast('保存に失敗しました。'); }
      },
      toggle: function() {
        if (state.isOptionsOpen) {
          state.isOptionsOpen = false;
          closePanel('options');
        } else {
          state.isOptionsOpen = true;
          state.isModalOpen   = false;
          hideContextMenu();
          closePanel('translatePanel');
          openPanel('options');
        }
      },
      toggleSearch: function() {
        state.isSearchOpen = !state.isSearchOpen;
        if (state.isSearchOpen) {
          setTimeout(function() { $('searchInput').focus(); }, 50);
          doSearch(0);
        } else {
          clearSearchHighlight();
          $('searchCount').textContent = '';
        }
        updateTextareaPadding();
      },
      searchNext: function() { doSearch(1);  },
      searchPrev: function() { doSearch(-1); },
      closeOverlays: function() {
        if (state.isOptionsOpen) { state.isOptionsOpen = false; closePanel('options'); }
        if (state.isModalOpen)   { state.isModalOpen   = false; closePanel('confirmModal'); }
        closePanel('translatePanel');
        closePanel('searchWebPanel');
      },
      updateText: function(val) {
        var lines     = val.split(/\r?\n/);
        var bodyLines = [];
        var changed   = false;

        for (var i = 0; i < lines.length; i++) {
          var line = lines[i];
          if (line.startsWith('##FONT:')) {
            updateSelectValue('fSel', line.replace('##FONT:', '').replace(/"/g, '').trim());
            changed = true;
            continue;
          }
          if (line.startsWith('##SIZE:')) {
            var sizeRaw = parseInt(line.replace('##SIZE:', '').trim());
            if (!isNaN(sizeRaw)) { updateSelectValue('sSel', normalizeSize(sizeRaw)); changed = true; }
            continue;
          }
          bodyLines.push(line);
        }

        var processedText = bodyLines.join('\n');
        if (changed) {
          state.text = processedText;
          $('edit').value = state.text;
          applyStyles();
        } else {
          state.text = val;
        }

        clearTimeout(state.hideTimer);
        var edit = $('edit');
        if (state.text.length > 0 && (edit.scrollHeight - (edit.scrollTop + edit.clientHeight) < 50)) {
          state.isFooterHidden = true;
          state.hideTimer = setTimeout(function() { state.isFooterHidden = false; render(); }, 1000);
        } else {
          state.isFooterHidden = false;
        }
      }
    };

    /* ── 検索バー表示時のパディング調整 ── */
    function updateTextareaPadding() {
      var edit      = $('edit');
      var mirror    = $('searchHighlightMirror');
      var searchBar = $('searchBar');
      if (state.isSearchOpen) {
        var barTop       = parseInt(searchBar.style.top) || 68;
        var totalPadding = barTop + (searchBar.offsetHeight || 44) + 20;
        edit.style.paddingTop   = totalPadding + 'px';
        mirror.style.paddingTop = totalPadding + 'px';
        edit.readOnly = true;
        edit.style.caretColor = 'transparent';
      } else {
        edit.style.paddingTop   = '80px';
        mirror.style.paddingTop = '80px';
        edit.readOnly = false;
        edit.style.caretColor = '';
      }
    }

    /* ── ユーティリティ ── */
    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function normalizeSize(size) {
      size = Math.round(size);
      if (size % 2 !== 0) size = (size < 18) ? size + 1 : size - 1;
      return Math.min(80, Math.max(12, size));
    }
    function sanitizeFileName(name) {
      name = (name || 'memo.txt').trim().replace(/[/\\:*?"<>|]/g, '');
      return name.toLowerCase().endsWith('.txt') ? name : name + '.txt';
    }
    function debounce(fn, wait) {
      var t;
      return function() {
        var ctx = this, args = arguments;
        clearTimeout(t);
        t = setTimeout(function() { fn.apply(ctx, args); }, wait);
      };
    }
    function isFontAvailable(font) {
      if (!font) return false;
      try {
        var canvas = document.createElement('canvas');
        var ctx    = canvas.getContext('2d');
        ctx.font   = '72px monospace';
        var w1     = ctx.measureText('abcdefg').width;
        ctx.font   = '72px "' + font + '", monospace';
        return w1 !== ctx.measureText('abcdefg').width;
      } catch(e) { return false; }
    }
    function updateSelectValue(id, value) {
      var sel = $(id);
      for (var i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value == value) { sel.selectedIndex = i; return; }
      }
      if (id === 'fSel' && isFontAvailable(value)) {
        sel.add(new Option(value, value));
        sel.selectedIndex = sel.options.length - 1;
      }
    }

    /* ── コンテキストメニュー ── */
    var selectedText = '';
    var contextMenu  = null;

    function hideContextMenu() {
      if (contextMenu) { contextMenu.style.display = 'none'; contextMenu.classList.remove('animating'); }
    }
    function showContextMenu(x, y, hasSelection) {
      if (!contextMenu) contextMenu = $('contextMenu');
      var isMobile = state.device === 'Mobile';
      /* ボタン・区切り線の表示切り替え */
      var selButtons = [$('ctxCopy'), $('ctxCut'), $('ctxDivider'), $('ctxSearch'), $('ctxTrans'), $('ctxCompare')];
      selButtons.forEach(function(el) {
        if (!el) return;
        /* コピー・切り取りはモバイルでは非表示 */
        if (el === $('ctxCopy') || el === $('ctxCut')) {
          el.style.display = (!isMobile && hasSelection) ? '' : 'none';
        } else {
          el.style.display = hasSelection ? '' : 'none';
        }
      });
      var pasteBtn = $('ctxPaste');
      /* 貼り付けはモバイルでは非表示 */
      pasteBtn.style.display = (!isMobile && !hasSelection) ? '' : 'none';
      /* クリップボードが空なら貼り付けボタンを灰色に */
      var hasClip = getInternalClipboard().length > 0;
      pasteBtn.style.color         = hasClip ? '' : 'var(--dim)';
      pasteBtn.style.cursor        = hasClip ? '' : 'default';
      pasteBtn.style.pointerEvents = hasClip ? '' : 'none';
      contextMenu.classList.remove('animating');
      contextMenu.style.left    = x + 'px';
      contextMenu.style.top     = y + 'px';
      contextMenu.style.display = 'block';
      var rect = contextMenu.getBoundingClientRect();
      var finalX = x, finalY = y;
      if (rect.right  > window.innerWidth  - 8) finalX = x - rect.width  - 4;
      if (rect.bottom > window.innerHeight - 8) finalY = y - rect.height - 4;
      contextMenu.style.left = finalX + 'px';
      contextMenu.style.top  = finalY + 'px';
      /* transform-originをマウス位置に合わせる */
      var originX = (finalX !== x) ? 'right' : 'left';
      var originY = (finalY !== y) ? 'bottom' : 'top';
      contextMenu.style.transformOrigin = originY + ' ' + originX;
      /* アニメーション再トリガー */
      void contextMenu.offsetWidth;
      contextMenu.classList.add('animating');
    }

    /* テキストエリアの選択範囲を使ってクリップボードにコピーする共通関数 */
    var CLIP_KEY = 'notepad26_clipboard';

    function copyToClipboard(text, onDone) {
      localStorage.setItem(CLIP_KEY, text);
      if (onDone) onDone();
    }

    function getInternalClipboard() {
      return localStorage.getItem(CLIP_KEY) || '';
    }

    window.ctxCopyText = function() {
      if (!selectedText) { hideContextMenu(); return; }
      var text = selectedText;
      hideContextMenu();
      copyToClipboard(text, function() {
        queueToast('コピーしました', 1000);
      });
    };

    window.ctxCutText = function() {
      if (!selectedText) { hideContextMenu(); return; }
      var edit  = $('edit');
      var start = edit.selectionStart, end = edit.selectionEnd;
      var text  = selectedText;
      hideContextMenu();
      copyToClipboard(text, function() {
        edit.setRangeText('', start, end, 'start');
        ActionHandlers.updateText(edit.value);
        scheduleAutoSave();
        render();
        selectedText = '';
        queueToast('切り取りました', 1000);
      });
    };

    window.ctxPasteText = function() {
      var text = getInternalClipboard();
      if (!text) { hideContextMenu(); return; }
      var edit  = $('edit');
      var start = edit.selectionStart, end = edit.selectionEnd;
      edit.setRangeText(text, start, end, 'end');
      ActionHandlers.updateText(edit.value);
      scheduleAutoSave();
      render();
      hideContextMenu();
    };

    /* ── Web検索（Wikipedia / Wiktionary）── */
    var swpCurrentPageUrl = '';

    var DICT_CONFIG = {
      wikipedia:  { label: 'Wikipedia',  btnText: 'Wikiで開く' },
      wiktionary: { label: 'Wiktionary', btnText: 'Wiktで開く' }
    };

    function getCurrentDict() {
      return localStorage.getItem('dictEngine') || 'wikipedia';
    }

    window.searchWiki = function() {
      if (!selectedText) { hideContextMenu(); return; }
      hideContextMenu();

      var dict  = getCurrentDict();
      var query = selectedText;
      var body  = $('swpBody');
      var cfg   = DICT_CONFIG[dict] || DICT_CONFIG.wikipedia;

      $('swpWikiBtn').textContent = cfg.btnText;
      body.innerHTML = '';
      $('searchWebPanel').classList.add('show');

      if      (dict === 'wikipedia')  searchWikipedia(query);
      else if (dict === 'wiktionary') searchWiktionary(query);
    };

    function searchWikipedia(query) {
      var body    = $('swpBody');
      var wikiBtn = $('swpWikiBtn');
      swpCurrentPageUrl = 'https://ja.wikipedia.org/wiki/' + encodeURIComponent(query);
      wikiBtn.onclick = function() { window.open(swpCurrentPageUrl, '_blank'); };

      fetch('https://ja.wikipedia.org/w/api.php?action=query&list=search&srsearch='
        + encodeURIComponent(query) + '&srlimit=6&format=json&origin=*')
        .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
        .then(function(data) {
          var results = data.query && data.query.search;
          if (!results || results.length === 0) {
            body.innerHTML = '<div class="swp-empty">「' + escapeHtml(query) + '」はWikipediaに見つかりませんでした。</div>';
            return;
          }
          var topTitle = results[0].title;
          swpCurrentPageUrl = 'https://ja.wikipedia.org/wiki/' + encodeURIComponent(topTitle);
          wikiBtn.onclick = function() { window.open(swpCurrentPageUrl, '_blank'); };
          return fetch('https://ja.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(topTitle))
            .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
            .then(function(summary) { renderWikiResults(summary, results, query); });
        })
        .catch(function() {
          body.innerHTML = '<div class="swp-empty">取得に失敗しました。<br>ネットワーク接続を確認してください。</div>';
        });
    }

    function renderWikiResults(summary, searchResults, query) {
      var html = '';
      if (summary && summary.title) {
        var pageUrl = summary.content_urls && summary.content_urls.desktop
          ? summary.content_urls.desktop.page
          : 'https://ja.wikipedia.org/wiki/' + encodeURIComponent(summary.title);
        html += '<div class="swp-abstract">'
          + '<div class="swp-abstract-heading">' + escapeHtml(summary.title) + '</div>';
        if (summary.description && summary.description.indexOf('曖昧さ回避') === -1)
          html += '<div class="swp-abstract-desc">' + escapeHtml(summary.description) + '</div>';
        if (summary.extract) {
          var extract = summary.extract.length > 400 ? summary.extract.slice(0, 400) + '…' : summary.extract;
          html += '<div class="swp-abstract-text">' + escapeHtml(extract) + '</div>';
        }
        html += '<div class="swp-abstract-src"><a href="' + escapeHtml(pageUrl) + '" target="_blank" rel="noopener">Wikipedia で読む →</a></div>'
          + '</div>';
      }
      var related = searchResults.slice(1);
      if (related.length > 0) {
        html += '<div class="swp-results-label">関連記事</div>';
        related.forEach(function(item) {
          var url     = 'https://ja.wikipedia.org/wiki/' + encodeURIComponent(item.title);
          var snippet = item.snippet ? item.snippet.replace(/<[^>]+>/g, '') : '';
          html += '<a class="swp-result-item" href="' + escapeHtml(url) + '" target="_blank" rel="noopener">'
            + '<div class="swp-result-title">' + escapeHtml(item.title) + '</div>';
          if (snippet) html += '<div class="swp-result-desc">' + escapeHtml(snippet) + '</div>';
          html += '<div class="swp-result-url">' + escapeHtml(url) + '</div></a>';
        });
      }
      $('swpBody').innerHTML = html || '<div class="swp-empty">「' + escapeHtml(query) + '」はWikipediaに見つかりませんでした。</div>';
    }

    function searchWiktionary(query) {
      var body    = $('swpBody');
      var wikiBtn = $('swpWikiBtn');
      swpCurrentPageUrl = 'https://ja.wiktionary.org/wiki/' + encodeURIComponent(query);
      wikiBtn.onclick = function() { window.open(swpCurrentPageUrl, '_blank'); };

      fetch('https://ja.wiktionary.org/api/rest_v1/page/summary/' + encodeURIComponent(query))
        .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(function(data) {
          var html = '<div class="swp-abstract">'
            + '<div class="swp-abstract-heading">' + escapeHtml(data.title || query) + '</div>';
          if (data.description && data.description.indexOf('曖昧さ回避') === -1)
            html += '<div class="swp-abstract-desc">' + escapeHtml(data.description) + '</div>';
          if (data.extract) {
            var ext = data.extract.length > 500 ? data.extract.slice(0, 500) + '…' : data.extract;
            html += '<div class="swp-abstract-text">' + escapeHtml(ext) + '</div>';
          }
          var pageUrl = data.content_urls && data.content_urls.desktop
            ? data.content_urls.desktop.page : swpCurrentPageUrl;
          html += '<div class="swp-abstract-src"><a href="' + escapeHtml(pageUrl) + '" target="_blank" rel="noopener">Wiktionary で読む →</a></div>'
            + '</div>';

          return fetch('https://ja.wiktionary.org/w/api.php?action=query&list=search&srsearch='
            + encodeURIComponent(query) + '&srlimit=5&format=json&origin=*')
            .then(function(r) { return r.ok ? r.json() : { query: { search: [] } }; })
            .then(function(d) {
              var results = (d.query && d.query.search) ? d.query.search.slice(1) : [];
              if (results.length > 0) {
                html += '<div class="swp-results-label">関連語句</div>';
                results.forEach(function(item) {
                  var url     = 'https://ja.wiktionary.org/wiki/' + encodeURIComponent(item.title);
                  var snippet = item.snippet ? item.snippet.replace(/<[^>]+>/g, '') : '';
                  html += '<a class="swp-result-item" href="' + escapeHtml(url) + '" target="_blank" rel="noopener">'
                    + '<div class="swp-result-title">' + escapeHtml(item.title) + '</div>';
                  if (snippet) html += '<div class="swp-result-desc">' + escapeHtml(snippet) + '</div>';
                  html += '</a>';
                });
              }
              body.innerHTML = html;
            });
        })
        .catch(function() {
          // サマリー取得失敗時はリスト検索にフォールバック
          fetch('https://ja.wiktionary.org/w/api.php?action=query&list=search&srsearch='
            + encodeURIComponent(query) + '&srlimit=6&format=json&origin=*')
            .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
            .then(function(d) {
              var results = d.query && d.query.search;
              if (!results || results.length === 0) {
                body.innerHTML = '<div class="swp-empty">「' + escapeHtml(query) + '」はWiktionaryに見つかりませんでした。</div>';
                return;
              }
              var html = '<div class="swp-results-label">検索結果</div>';
              results.forEach(function(item) {
                var url     = 'https://ja.wiktionary.org/wiki/' + encodeURIComponent(item.title);
                var snippet = item.snippet ? item.snippet.replace(/<[^>]+>/g, '') : '';
                html += '<a class="swp-result-item" href="' + escapeHtml(url) + '" target="_blank" rel="noopener">'
                  + '<div class="swp-result-title">' + escapeHtml(item.title) + '</div>';
                if (snippet) html += '<div class="swp-result-desc">' + escapeHtml(snippet) + '</div>';
                html += '<div class="swp-result-url">' + escapeHtml(url) + '</div></a>';
              });
              body.innerHTML = html;
            })
            .catch(function() {
              body.innerHTML = '<div class="swp-empty">取得に失敗しました。<br>ネットワーク接続を確認してください。</div>';
            });
        });
    }

    /* ── 翻訳 ── */
    window.translateText = function() {
      if (!selectedText) { hideContextMenu(); return; }
      hideContextMenu();

      var src      = selectedText;
      var tpResult  = $('tpResult');
      var tpPowered = $('tpPowered');
      $('tpSrc').textContent = src.length > 120 ? src.slice(0, 120) + '…' : src;
      tpResult.innerHTML = '<div class="tp-loading">翻訳中…</div>';
      $('translatePanel').classList.add('show');

      var doFetch = function() {
        var engine = localStorage.getItem('translateEngine') || 'google';
        if (tpPowered) tpPowered.textContent = engine === 'bing' ? 'Powered by Bing translation' : 'Powered by Google translation';

        var url = 'https://translate.googleapis.com/translate_a/single?client=gtx'
          + '&sl=' + $('tpSrcLang').value + '&tl=' + $('tpTgtLang').value
          + '&dt=t&q=' + encodeURIComponent(src);
        tpResult.innerHTML = '<div class="tp-loading">翻訳中…</div>';
        fetch(url)
          .then(function(r) { if (!r.ok) throw new Error(); return r.json(); })
          .then(function(data) {
            var result = '';
            if (data && data[0]) data[0].forEach(function(seg) { if (seg && seg[0]) result += seg[0]; });
            tpResult.textContent = result || '翻訳結果が取得できませんでした';
          })
          .catch(function() {
            tpResult.innerHTML = '<div class="tp-error">翻訳に失敗しました。<br>ネットワーク接続を確認してください。</div>';
          });
      };
      $('tpSrcLang').onchange = doFetch;
      $('tpTgtLang').onchange = doFetch;
      doFetch();
    };

    /* ── グローバル公開 ── */
    window.act = function(type) { ActionHandlers[type](); render(); };
    window.closeConfirm = function(yes) {
      if (yes && state.modalType === 'new') {
        $('edit').value = '';
        ActionHandlers.updateText('');
        state.curFile = 'memo.txt';
      }
      state.isModalOpen = false;
      closePanel('confirmModal');
      render();
    };
    window.closePanel = closePanel;
    window.openPanel  = openPanel;

    /* ── レンダリング ── */
    function render() {
      var edit      = $('edit');
      var isAnyOpen = state.isOptionsOpen || state.isModalOpen;
      $('f-info').textContent  = state.curFile + ' · ' + edit.value.length + ' 文字';
      $('b-info').textContent  = state.browser + '_' + state.device;
      edit.placeholder         = state.browser + '_' + state.device + ' >';
      $('backdrop').className  = isAnyOpen ? 'show' : '';
      $('ft').className        = 'glass' + (state.isFooterHidden ? ' hidden' : '');
      $('searchBar').className = 'glass' + (state.isSearchOpen ? ' show' : '');
    }

    /* ── パネル開閉の共通関数（show / closing を管理） ── */
    function openPanel(id) {
      var el = $(id);
      if (!el) return;
      el.classList.remove('closing');
      el.classList.add('show');
    }
    function closePanel(id) {
      var el = $(id);
      if (!el || !el.classList.contains('show')) return;
      el.classList.add('closing');
      el.classList.remove('show');
      setTimeout(function() { el.classList.remove('closing'); }, 350);
    }
    /* ── ドラッグ移動機能 ── */
    (function() {
      function makeDraggable(panelId, handleId) {
        var panel  = $(panelId);
        var handle = $(handleId);
        if (!panel || !handle) return;

        var isDragging = false;
        var hasMoved   = false;
        var startX, startY, startLeft, startTop;
        var dropTimer  = null;

        function snapToPos() {
          // show クラスがある間は CSS の translate(-50%,-50%) が transform に含まれる。
          // getBoundingClientRect() は最終的な画面座標を返すので、
          // それを left/top にセットしつつ transform を scale(1) のみにすれば
          // CSS の translate は打ち消される。
          var rect = panel.getBoundingClientRect();
          // transition を一時停止してワープを防ぐ
          panel.style.transition = 'none';
          panel.style.left       = rect.left + 'px';
          panel.style.top        = rect.top  + 'px';
          panel.style.transform  = 'scale(1)';
          void panel.offsetWidth; // 強制リフロー
        }

        function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

        function onStart(clientX, clientY) {
          if (dropTimer) { clearTimeout(dropTimer); dropTimer = null; }

          // 初回ドラッグ：CSS の translate(-50%,-50%) を left/top の絶対座標に変換
          if (!panel.dataset.dragged) {
            snapToPos();
            panel.dataset.dragged = '1';
          }

          isDragging = true;
          hasMoved   = false;
          startX     = clientX;
          startY     = clientY;
          startLeft  = parseFloat(panel.style.left)  || 0;
          startTop   = parseFloat(panel.style.top)   || 0;

          // transition を有効化してスプリング縮小アニメーション
          panel.style.transition = '';
          panel.classList.remove('panel-dropping');
          // rAF × 2 でリフロー後に transition が確実に有効になった後に scale 変更
          requestAnimationFrame(function() {
            requestAnimationFrame(function() {
              panel.classList.add('panel-grabbing');
              panel.style.transform = 'scale(0.95)';
            });
          });
        }

        function onMove(clientX, clientY) {
          if (!isDragging) return;
          var dx = clientX - startX;
          var dy = clientY - startY;

          if (!hasMoved && Math.abs(dx) + Math.abs(dy) > 3) {
            hasMoved = true;
            // 動き始めたら transition なしで追従
            panel.classList.remove('panel-grabbing');
            panel.style.transition = 'none';
            panel.style.transform  = 'scale(0.95)';
          }
          if (!hasMoved) return;

          var maxL = window.innerWidth  - panel.offsetWidth  - 8;
          var maxT = window.innerHeight - panel.offsetHeight - 8;
          panel.style.left = clamp(startLeft + dx, 8, maxL) + 'px';
          panel.style.top  = clamp(startTop  + dy, 8, maxT) + 'px';
        }

        function onEnd() {
          if (!isDragging) return;
          isDragging = false;
          panel.classList.remove('panel-grabbing');
          panel.style.transition = '';
          // ドロップ：スプリングで scale(1) に戻す
          panel.classList.add('panel-dropping');
          panel.style.transform = 'scale(1)';
          dropTimer = setTimeout(function() {
            panel.classList.remove('panel-dropping');
            dropTimer = null;
          }, 420);
        }

        // パネルが閉じたらドラッグ状態をリセット
        new MutationObserver(function() {
          if (!panel.classList.contains('show') && !panel.classList.contains('closing')) {
            setTimeout(function() {
              if (!panel.classList.contains('show')) {
                delete panel.dataset.dragged;
                panel.style.left       = '';
                panel.style.top        = '';
                panel.style.transform  = '';
                panel.style.transition = '';
                panel.classList.remove('panel-grabbing', 'panel-dropping');
              }
            }, 420);
          }
        }).observe(panel, { attributes: true, attributeFilter: ['class'] });

        handle.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return;
          if (['BUTTON','SELECT','INPUT','LABEL'].indexOf(e.target.tagName) !== -1) return;
          e.preventDefault();
          onStart(e.clientX, e.clientY);
        });
        document.addEventListener('mousemove', function(e) { onMove(e.clientX, e.clientY); });
        document.addEventListener('mouseup',   onEnd);

        handle.addEventListener('touchstart', function(e) {
          if (['BUTTON','SELECT','INPUT','LABEL'].indexOf(e.target.tagName) !== -1) return;
          onStart(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: true });
        document.addEventListener('touchmove', function(e) {
          if (!isDragging) return;
          e.preventDefault();
          onMove(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });
        document.addEventListener('touchend', onEnd);
      }

      makeDraggable('options',        'optionsDragHandle');
      makeDraggable('translatePanel', 'translateDragHandle');
      makeDraggable('searchWebPanel', 'searchWebDragHandle');
    })();

    var themeColors = [
      { color: '#c9a181', label: 'チタニウムデザート' },
      { color: '#c4bcad', label: 'チタニウムナチュラル' },
      { color: '#ecc9a6', label: 'ゴールド' },
      { color: '#f9c0b9', label: 'ゴールドローズ' },
    ];
    function applyAccentColor(color) {
      document.documentElement.style.setProperty('--accent', color);
      var hex = color.replace('#', '');
      if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
      var r = parseInt(hex.substring(0,2),16);
      var g = parseInt(hex.substring(2,4),16);
      var b = parseInt(hex.substring(4,6),16);
      document.documentElement.style.setProperty('--accent-rgb', r+','+g+','+b);
      state.accentColor = color;
      localStorage.setItem('accentColor', color);
      document.querySelectorAll('.swatch').forEach(function(s) {
        s.classList.toggle('active', s.dataset.color === color);
      });
    }
    function applyStyles() {
      $('edit').style.fontFamily = $('fSel').value;
      $('edit').style.fontSize   = $('sSel').value + 'px';
      updateMirror();
    }

    /* ── 検索ハイライト ── */
    var searchMatches = [];
    var searchIndex   = 0;

    function updateMirror() {
      var mirror = $('searchHighlightMirror');
      var edit   = $('edit');
      if (!mirror) return;
      mirror.style.fontFamily = edit.style.fontFamily || '';
      mirror.style.fontSize   = edit.style.fontSize   || '18px';

      if (!state.isSearchOpen || searchMatches.length === 0) {
        mirror.innerHTML = '';
        mirror.scrollTop = edit.scrollTop;
        return;
      }
      var query = $('searchInput').value;
      if (!query) { mirror.innerHTML = ''; return; }

      var text = edit.value, qLen = query.length, html = '', cursor = 0;
      searchMatches.forEach(function(pos, i) {
        html += escapeHtml(text.substring(cursor, pos));
        html += '<mark class="' + (i === searchIndex ? 'current' : '') + '">'
              + escapeHtml(text.substring(pos, pos + qLen)) + '</mark>';
        cursor = pos + qLen;
      });
      html += escapeHtml(text.substring(cursor));
      mirror.innerHTML = html;
      mirror.scrollTop = edit.scrollTop;
    }

    function doSearch(dir) {
      var query = $('searchInput').value;
      var edit  = $('edit');
      searchMatches = [];
      if (!query) { $('searchCount').textContent = ''; updateMirror(); return; }

      var lowerText = edit.value.toLowerCase();
      var lowerQ    = query.toLowerCase();
      var pos = 0;
      while ((pos = lowerText.indexOf(lowerQ, pos)) !== -1) { searchMatches.push(pos); pos += lowerQ.length; }

      if (searchMatches.length === 0) { $('searchCount').textContent = '0 / 0'; updateMirror(); return; }

      if      (dir ===  1) searchIndex = (searchIndex + 1) % searchMatches.length;
      else if (dir === -1) searchIndex = (searchIndex - 1 + searchMatches.length) % searchMatches.length;
      else                 searchIndex = 0;

      var matchPos   = searchMatches[searchIndex];
      edit.setSelectionRange(matchPos, matchPos + query.length);
      var lineHeight = parseFloat(getComputedStyle(edit).lineHeight) || 28;
      var lineNum    = edit.value.substring(0, matchPos).split('\n').length - 1;
      var paddingTop = parseInt(edit.style.paddingTop) || 80;
      edit.scrollTop = Math.max(0, lineNum * lineHeight - (edit.clientHeight - paddingTop) / 2);

      $('searchCount').textContent = (searchIndex + 1) + ' / ' + searchMatches.length;
      updateMirror();
    }

    function clearSearchHighlight() {
      searchMatches = []; searchIndex = 0;
      var mirror = $('searchHighlightMirror');
      if (mirror) mirror.innerHTML = '';
    }

    /* ── 自動保存 ── */
    //       clearTimeout / clearInterval を統一して管理する
    var autoSaveTimer   = null;
    var autoSaveIsInterval = false;
    var AUTO_SAVE_INTERVAL = 2 * 60 * 1000; // 2分

    function clearAutoSaveTimer() {
      if (autoSaveTimer === null) return;
      if (autoSaveIsInterval) clearInterval(autoSaveTimer);
      else                    clearTimeout(autoSaveTimer);
      autoSaveTimer      = null;
      autoSaveIsInterval = false;
    }

    function doAutoSave() {
      if (!state.autoSave) return;
      var text = $('edit').value;
      localStorage.setItem('autosave_text', text);
      localStorage.setItem('autosave_file', state.curFile);
      var time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      queueToast('自動保存済み ' + time, 2000);
    }

    function scheduleAutoSave() {
      if (!state.autoSave) return;
      clearAutoSaveTimer();
      autoSaveIsInterval = false;
      autoSaveTimer = setTimeout(function() {
        doAutoSave();
        // 初回タイマー後は定期実行に切り替え
        autoSaveIsInterval = true;
        autoSaveTimer = setInterval(doAutoSave, AUTO_SAVE_INTERVAL);
      }, AUTO_SAVE_INTERVAL);
    }

    window.addEventListener('beforeunload', function() {
      if (state.autoSave) doAutoSave();
    });

    /* ── 初期化 ── */
    (function init() {
      var fSel = $('fSel'), sSel = $('sSel'), edit = $('edit');

      supportedFonts.forEach(function(f) { fSel.add(new Option(f, f)); });
      for (var j = 12; j <= 80; j += 2) sSel.add(new Option(j + 'px', j));
      sSel.value = 18;

      var translateSel = $('translateSel');
      translateSel.value    = localStorage.getItem('translateEngine') || 'google';
      translateSel.onchange = function() {
        localStorage.setItem('translateEngine', translateSel.value);
        var tpPowered = $('tpPowered');
        if (tpPowered) tpPowered.textContent = translateSel.value === 'bing'
          ? 'Powered by Bing translation' : 'Powered by Google translation';
      };

      var dictSel = $('dictSel');
      dictSel.value    = localStorage.getItem('dictEngine') || 'wikipedia';
      dictSel.onchange = function() { localStorage.setItem('dictEngine', dictSel.value); };

      var swatchContainer = $('colorSwatches');
      themeColors.forEach(function(t) {
        var s = document.createElement('button');
        s.className = 'swatch'; s.dataset.color = t.color;
        s.style.background = t.color; s.title = t.label;
        s.onclick = function(e) {
          e.preventDefault(); e.stopPropagation();
          hideContextMenu();
          applyAccentColor(t.color);
        };
        swatchContainer.appendChild(s);
      });
      applyAccentColor(state.accentColor);

      var autoSaveToggle = $('autoSaveToggle');
      autoSaveToggle.checked = state.autoSave;
      if (state.autoSave) {
        var saved     = localStorage.getItem('autosave_text');
        var savedFile = localStorage.getItem('autosave_file');
        if (saved && saved.length > 0 && edit.value.length === 0) {
          edit.value = saved;
          if (savedFile) state.curFile = savedFile;
          ActionHandlers.updateText(edit.value);
          queueToast('自動保存データを復元しました', 3000);
        }
      }
      autoSaveToggle.onchange = function() {
        state.autoSave = autoSaveToggle.checked;
        localStorage.setItem('autoSave', state.autoSave);
        if (!state.autoSave) {
          clearAutoSaveTimer(); // [Fix] 統一された関数を使う
        } else {
          scheduleAutoSave();
        }
      };

      $('clearAutoSaveBtn').onclick = function() {
        localStorage.removeItem('autosave_text');
        localStorage.removeItem('autosave_file');
        queueToast('自動保存データを消去しました', 2000);
      };

      function positionSearchBar() {
        var header = document.querySelector('header');
        var bar    = $('searchBar');
        if (header && bar) {
          bar.style.top = (header.getBoundingClientRect().bottom + 12) + 'px';
          if (state.isSearchOpen) updateTextareaPadding();
        }
      }
      positionSearchBar();
      window.addEventListener('resize', positionSearchBar);

      var searchInput = $('searchInput');
      searchInput.oninput = function() { doSearch(0); };
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault(); e.stopPropagation();
          doSearch(e.key === 'ArrowDown' ? 1 : -1);
          setTimeout(function() { searchInput.focus(); }, 0);
        }
        if (e.key === 'Enter')  { e.preventDefault(); doSearch(e.shiftKey ? -1 : 1); }
        if (e.key === 'Escape') { act('toggleSearch'); render(); }
      });

      var upd = debounce(function() {
        ActionHandlers.updateText(edit.value);
        scheduleAutoSave();
        render();
      }, 150);
      edit.oninput  = upd;
      edit.onclick  = function() { hideContextMenu(); upd(); };
      edit.onscroll = function() { hideContextMenu(); updateMirror(); };

      if (window.ResizeObserver) new ResizeObserver(function() { updateMirror(); }).observe(edit);

      fSel.onchange = applyStyles;
      sSel.onchange = applyStyles;

      edit.addEventListener('wheel', function(e) {
        if (!e.ctrlKey) return;
        e.preventDefault();
        var current = parseInt(sSel.value, 10) || 18;
        var newSize = normalizeSize(current + (e.deltaY < 0 ? 2 : -2));
        if (newSize !== current) {
          sSel.value = String(newSize); applyStyles();
          clearTimeout(sizeToastTimer);
          sizeToastTimer = setTimeout(function() { queueToast('フォントサイズ: ' + newSize + 'px', 1000); }, 600);
        }
      }, { passive: false });

      $('fileInput').onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        state.curFile = file.name;
        var reader = new FileReader();
        reader.onload = function() { edit.value = reader.result; ActionHandlers.updateText(edit.value); render(); };
        reader.readAsText(file);
      };

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (state.isOptionsOpen || state.isModalOpen) { ActionHandlers.closeOverlays(); render(); }
          hideDevMessage();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); ActionHandlers.toggleSearch(); render(); }
      });

      var contextMenuJustOpened = false;

      edit.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        var text = window.getSelection().toString().trim();
        selectedText = text;
        contextMenuJustOpened = true;
        showContextMenu(e.clientX, e.clientY, text.length > 0);
        setTimeout(function() { contextMenuJustOpened = false; }, 100);
      });

      edit.addEventListener('mouseup', function(e) {
        if (e.button === 2) return; // 右クリックは無視
        setTimeout(function() {
          var text = window.getSelection().toString().trim();
          if (text.length > 0) { selectedText = text; showContextMenu(e.clientX, e.clientY, true); }
          else if (contextMenu && !contextMenu.contains(e.target)) { hideContextMenu(); }
        }, 20);
      });

      function handleOutsideClick(e) {
        if (contextMenuJustOpened) return;
        if (contextMenu && contextMenu.style.display !== 'none') {
          if (!contextMenu.contains(e.target)) hideContextMenu();
          return;
        }

        // 設定パネルが開いているとき：パネル外クリックで閉じる（backdropがpointer-events:noneのため）
        // ただし devMessageModal が開いている場合は何もしない
        if (state.isOptionsOpen) {
          var devModal = $('devMessageModal');
          if (devModal && devModal.classList.contains('show')) return;
          var optEl = $('options');
          if (optEl && !optEl.contains(e.target)) {
            ActionHandlers.closeOverlays();
            render();
          }
          return;
        }

        // textareaやedit上のクリック/タッチはパネルを閉じない（編集を許可）
        var editEl = $('edit');
        if (editEl && (editEl === e.target || editEl.contains(e.target))) return;

        var tp = $('translatePanel');
        if (tp && tp.classList.contains('show') && !tp.contains(e.target)) closePanel('translatePanel');

        var swp = $('searchWebPanel');
        if (swp && swp.classList.contains('show') && !swp.contains(e.target)) closePanel('searchWebPanel');
      }
      document.addEventListener('mousedown',  handleOutsideClick);
      document.addEventListener('touchstart', handleOutsideClick, { passive: true });

      edit.addEventListener('touchend', function(e) {
        setTimeout(function() {
          var text = window.getSelection().toString().trim();
          if (text.length > 0) {
            selectedText = text;
            var touch = e.changedTouches[0];
            showContextMenu(touch.clientX, touch.clientY, true);
          }
        }, 50);
      });

      applyStyles();
      render();

      window.addEventListener('offline', function() {
        if (!hasShownOfflineToast) { hasShownOfflineToast = true; queueToast('エラー : インターネット接続が遮断されました', 5000); }
      });
      window.addEventListener('online', function() { hasShownOfflineToast = false; });
    })();

    /* ── Diff（ファイル比較）── */
    function computeDiff(aLines, bLines) {
      var n = aLines.length, m = bLines.length, max = n + m;
      if (max === 0) return [];
      var v = new Array(2 * max + 1).fill(0), trace = [];
      outer:
      for (var d = 0; d <= max; d++) {
        trace.push(v.slice());
        for (var k = -d; k <= d; k += 2) {
          var idx = k + max, x;
          x = (k === -d || (k !== d && v[idx - 1] < v[idx + 1])) ? v[idx + 1] : v[idx - 1] + 1;
          var y = x - k;
          while (x < n && y < m && aLines[x] === bLines[y]) { x++; y++; }
          v[idx] = x;
          if (x >= n && y >= m) { trace.push(v.slice()); break outer; }
        }
      }
      var ops = [], x = n, y = m;
      for (var dd = trace.length - 1; dd >= 0; dd--) {
        var vv = trace[dd], kk = x - y, kidx = kk + max;
        var prevK = (kk === -dd || (kk !== dd && vv[kidx - 1] < vv[kidx + 1])) ? kk + 1 : kk - 1;
        var prevX = vv[prevK + max], prevY = prevX - prevK;
        while (x > prevX && y > prevY) { x--; y--; ops.push({ op: '=', line: aLines[x] }); }
        if (dd > 0) {
          if      (x > prevX) { x--; ops.push({ op: '-', line: aLines[x] }); }
          else if (y > prevY) { y--; ops.push({ op: '+', line: bLines[y] }); }
        }
      }
      return ops.reverse();
    }

    function stripMeta(text) {
      return text.replace(/^##FONT:.*\n?/m, '').replace(/^##SIZE:.*\n?/m, '');
    }

    window.openCompareFromContextMenu = function() { hideContextMenu(); $('compareFileInput').click(); };

    $('compareFileInput').onchange = function(e) {
      var file = e.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function() { showDiff($('edit').value, reader.result, file.name); };
      reader.readAsText(file);
    };

    function showDiff(origText, newText, newFileName) {
      var aLines = stripMeta(origText).split(/\r?\n/);
      var bLines = stripMeta(newText).split(/\r?\n/);
      var ops    = computeDiff(aLines, bLines);

      var edit        = $('edit');
      var diffContent = $('diffContent');
      diffContent.style.fontSize   = edit.style.fontSize   || '18px';
      diffContent.style.fontFamily = edit.style.fontFamily || 'sans-serif';

      var addCount = 0, delCount = 0, html = '';
      ops.forEach(function(op) {
        var safe = escapeHtml(op.line);
        if      (op.op === '+') { addCount++; html += '<span style="background:rgba(100,210,100,0.3);display:block;">+ ' + safe + '</span>'; }
        else if (op.op === '-') { delCount++; html += '<span style="background:rgba(255,80,80,0.3);display:block;">- '  + safe + '</span>'; }
        else                    {             html += '<span style="opacity:0.7;display:block;">　' + safe + '</span>'; }
      });
      diffContent.innerHTML = html;
      $('diffLegendAdd').innerHTML = '<span class="diff-legend-dot add"></span>追加 ' + addCount + '行';
      $('diffLegendDel').innerHTML = '<span class="diff-legend-dot del"></span>削除 ' + delCount + '行';

      $('diffOverlay').style.display = 'block';
      var mainHeader = document.querySelector('header');
      mainHeader.classList.remove('diff-restore');
      requestAnimationFrame(function() { requestAnimationFrame(function() { mainHeader.classList.add('diff-exit'); }); });

      var hdr = $('diffHeader');
      hdr.classList.remove('diff-visible');
      hdr.classList.add('diff-enter');
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          $('diffOverlay').classList.add('diff-overlay-visible');
          diffContent.style.paddingTop = (hdr.getBoundingClientRect().bottom + 16) + 'px';
          setTimeout(function() { hdr.classList.remove('diff-enter'); hdr.classList.add('diff-visible'); }, 220);
        });
      });
    }

    window.closeDiffOverlay = function() {
      var mainHeader = document.querySelector('header');
      var hdr        = $('diffHeader');
      var overlay    = $('diffOverlay');
      hdr.classList.remove('diff-visible');
      hdr.classList.add('diff-enter');
      overlay.classList.remove('diff-overlay-visible');
      setTimeout(function() {
        mainHeader.classList.remove('diff-exit');
        requestAnimationFrame(function() { requestAnimationFrame(function() { mainHeader.classList.add('diff-restore'); }); });
      }, 120);
      setTimeout(function() {
        overlay.style.display = 'none';
        hdr.classList.remove('diff-enter', 'diff-visible');
        mainHeader.classList.remove('diff-exit', 'diff-restore');
      }, 350);
    };
  </script>
</body>
</html>
